

🧠 Claude 后端提示词：V1.3 用户登录与注册功能

🎯 开发目标

你将为 PocketSpeak 项目开发一套完整的用户登录与注册系统，基于 邮箱验证码登录 + Apple ID 登录（预留）。该模块应包括：
	•	用户模型设计与数据库字段规划
	•	邮箱验证码发送接口
	•	邮箱验证码登录接口
	•	当前登录用户信息接口（用户信息获取）
	•	Token 签发、验证与自动登录机制
	•	所有接口的请求验证、权限控制、异常处理

⸻

📁 目录要求

请将代码按照以下结构进行组织：

backend/
├── models/user_model.py                # 用户模型定义
├── routers/auth_router.py             # 登录相关 API 路由
├── services/auth_service.py           # 登录逻辑服务层
├── utils/email_sender.py              # 邮件发送工具（预留 Sendgrid、SMTP 等）
├── core/security.py                   # JWT 生成/验证逻辑
├── deps/dependencies.py               # 获取当前用户依赖项
└── config/config.yaml                 # 邮件发送配置、JWT配置等


⸻

📐 数据模型设计（SQLAlchemy）

请在 user_model.py 中定义如下字段：

字段名	类型	说明
user_id	UUID	主键，系统自动生成
email	String	邮箱地址，唯一
english_level	Enum/String	英语等级（A1~C2）
age_range	Enum/String	年龄段（12-20 等）
purpose	String	学英语目的
created_at	DateTime	创建时间
updated_at	DateTime	更新时间

⚠️ 所有与 V1.2 中的用户问卷结果字段必须一致，支持用户信息补充

⸻

🔐 Token 机制
	•	使用 pyjwt 生成与验证用户 JWT
	•	Token 中必须包含 user_id 和 email
	•	签发时间：24h
	•	Token 存入前端 SharedPreferences

⸻

📡 API接口设计

1. 发送验证码接口

POST /api/auth/send-code

请求体

{ "email": "user@example.com" }

响应

{ "message": "验证码已发送" }

✅ 逻辑要求：
	•	验证邮箱格式
	•	生成 6 位随机数字验证码
	•	存入缓存（建议使用 Redis / 内存字典）
	•	有效期 5 分钟
	•	限制重复发送（60 秒内不得再次发送）
	•	调用 email_sender.py 实现邮件发送（可打印替代）

⸻

2. 邮箱验证码登录接口

POST /api/auth/login-code

请求体

{
  "email": "user@example.com",
  "code": "123456"
}

响应体

{
  "token": "xxx",
  "user": {
    "user_id": "xxx",
    "email": "user@example.com",
    "english_level": "B1"  // 可能为空
  }
}

✅ 逻辑要求：
	•	校验验证码是否正确
	•	若用户不存在则注册用户
	•	若用户存在则直接登录
	•	自动生成 JWT 返回给前端
	•	若首次登录，english_level 字段应为 null

⸻

3. 获取当前用户接口

GET /api/user/me

Header

Authorization: Bearer <token>

响应体

{
  "user_id": "xxx",
  "email": "user@example.com",
  "english_level": "B2",
  "age_range": "21-30",
  "purpose": "日常口语交流"
}


⸻

💾 邮件发送工具

请封装 utils/email_sender.py：

def send_verification_code(email: str, code: str) -> bool:
    # 真实环境下接入 Sendgrid / SMTP
    print(f"向 {email} 发送验证码: {code}")
    return True


⸻

🔐 安全与防刷要求
	•	验证码不得打印在返回体中
	•	每个邮箱 60s 内不得重复发送
	•	每个 IP 每小时最多发送 10 次
	•	登录成功后刷新验证码（即验证码一次性使用）

⸻

🧪 测试建议

请为以下接口编写独立测试：
	•	✅ 邮箱格式错误
	•	✅ 验证码过期
	•	✅ 错误验证码
	•	✅ 注册新用户
	•	✅ 登录老用户

⸻

📌 注意事项
	1.	所有业务逻辑必须与 config.yaml 进行解耦
	2.	不允许前后端交叉逻辑（如前端生成验证码）
	3.	所有新建模块需记录在 CLAUDE.md 中（V1.3 部分）
	4.	必须在 claude_workspace/ 中写入本任务日志，包含接口路径、测试情况、是否成功

