# AIæ¶ˆæ¯åˆ†å¥æ˜¾ç¤ºä¿®å¤

**ä¿®å¤æ—¶é—´**: 2025-01-07
**é—®é¢˜**: AIå›å¤çš„å¤šå¥è¯éƒ½æŒ¤åœ¨åŒä¸€ä¸ªèŠå¤©æ°”æ³¡é‡Œ
**éœ€æ±‚**: æ¯å¥è¯åº”è¯¥æ˜¾ç¤ºä¸ºä¸€ä¸ªç‹¬ç«‹çš„èŠå¤©æ°”æ³¡
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## é—®é¢˜æè¿°

### ç”¨æˆ·éœ€æ±‚

> "å°æ™ºAIå›å¤æ—¶ä¸€èˆ¬ä¼šåˆ†ä¸ºå‡ å¥è¯å›å¤ï¼Œç°åœ¨ä½ æ˜¯æŠŠè¿™å‡ å¥è¯éƒ½æ”¾åœ¨åŒä¸€ä¸ªèŠå¤©æ°”æ³¡äº†ï¼Œè¿™æ ·ä¸å¯¹ï¼Œåº”è¯¥æ˜¯æ¯ä¸€å¥è¯ä¸€ä¸ªèŠå¤©æ°”æ³¡æ‰å¯¹ï¼"

### é—®é¢˜è¡¨ç°

**å½“å‰æ˜¾ç¤º**ï¼ˆé”™è¯¯ï¼‰ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœ¨å¸®ç¨‹åºå‘˜ç”·å‹debugå•¦ï¼Œä»–å†™çš„  â”‚
â”‚ ä»£ç åƒæäº†æˆ‘ä»¬çš„çˆ±æƒ…â€”â€”ä¸€å †     â”‚
â”‚ warningä½†è¿˜èƒ½è¿è¡Œã€‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœŸæœ›æ˜¾ç¤º**ï¼ˆæ­£ç¡®ï¼‰ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœ¨å¸®ç¨‹åºå‘˜ç”·å‹debugå•¦ï¼Œ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»–å†™çš„ä»£ç åƒæäº†æˆ‘ä»¬çš„çˆ±æƒ…â€”â€”   â”‚
â”‚ ä¸€å †warningä½†è¿˜èƒ½è¿è¡Œã€‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¹æœ¬åŸå› åˆ†æ

### åŸå§‹é€»è¾‘ï¼ˆé”™è¯¯ï¼‰

**æ–‡ä»¶**: `frontend/pocketspeak_app/lib/pages/chat_page.dart`

**Line 449** (æ—§ä»£ç ):
```dart
String accumulatedText = '';  // âŒ ç´¯ç§¯çš„æ–‡æœ¬
```

**Line 472-517** (æ—§ä»£ç ):
```dart
for (var sentence in sentences) {
  final text = sentence['text'] as String;
  final audioData = sentence['audio_data'] as String;

  // âŒ ç´¯ç§¯æ–‡æœ¬
  accumulatedText += text;

  // åˆ›å»ºæˆ–æ›´æ–°AIæ¶ˆæ¯
  if (_currentAiMessage == null) {
    // ç¬¬ä¸€å¥ï¼šåˆ›å»ºæ–°æ¶ˆæ¯
    final aiMessage = ChatMessage(
      messageId: 'ai_${DateTime.now().millisecondsSinceEpoch}',
      text: accumulatedText,  // âŒ åŒ…å«æ‰€æœ‰ç´¯ç§¯çš„å¥å­
      isUser: false,
      timestamp: DateTime.now(),
      hasAudio: true,
    );

    setState(() {
      _messages.add(aiMessage);
      _isProcessing = false;
    });

    _currentAiMessage = aiMessage;
  } else {
    // âŒ åç»­å¥å­ï¼šæ›´æ–°åŒä¸€ä¸ªæ¶ˆæ¯
    final updatedMessage = ChatMessage(
      messageId: _currentAiMessage!.messageId,
      text: accumulatedText,  // âŒ ç´¯ç§¯çš„æ–‡æœ¬è¶Šæ¥è¶Šé•¿
      isUser: false,
      timestamp: _currentAiMessage!.timestamp,
      hasAudio: true,
    );

    setState(() {
      final index = _messages.indexWhere((msg) => msg.messageId == _currentAiMessage!.messageId);
      if (index != -1) {
        _messages[index] = updatedMessage;  // âŒ æ›´æ–°åŒä¸€ä¸ªæ°”æ³¡
      }
    });

    _currentAiMessage = updatedMessage;
  }
}
```

### é—®é¢˜æµç¨‹

```
æ”¶åˆ°ç¬¬ä¸€å¥: "åœ¨å¸®ç¨‹åºå‘˜ç”·å‹debugå•¦ï¼Œ"
  â†’ accumulatedText = "åœ¨å¸®ç¨‹åºå‘˜ç”·å‹debugå•¦ï¼Œ"
  â†’ åˆ›å»ºæ°”æ³¡1: "åœ¨å¸®ç¨‹åºå‘˜ç”·å‹debugå•¦ï¼Œ"
  â†’ _currentAiMessage = æ°”æ³¡1

æ”¶åˆ°ç¬¬äºŒå¥: "ä»–å†™çš„ä»£ç åƒæäº†æˆ‘ä»¬çš„çˆ±æƒ…â€”â€”ä¸€å †warningä½†è¿˜èƒ½è¿è¡Œã€‚"
  â†’ accumulatedText += "ä»–å†™çš„ä»£ç åƒæäº†æˆ‘ä»¬çš„çˆ±æƒ…â€”â€”ä¸€å †warningä½†è¿˜èƒ½è¿è¡Œã€‚"
  â†’ accumulatedText = "åœ¨å¸®ç¨‹åºå‘˜ç”·å‹debugå•¦ï¼Œä»–å†™çš„ä»£ç åƒæäº†æˆ‘ä»¬çš„çˆ±æƒ…â€”â€”ä¸€å †warningä½†è¿˜èƒ½è¿è¡Œã€‚"
  â†’ âŒ æ›´æ–°æ°”æ³¡1: "åœ¨å¸®ç¨‹åºå‘˜ç”·å‹debugå•¦ï¼Œä»–å†™çš„ä»£ç åƒæäº†æˆ‘ä»¬çš„çˆ±æƒ…â€”â€”ä¸€å †warningä½†è¿˜èƒ½è¿è¡Œã€‚"
```

**å…³é”®é—®é¢˜**ï¼š
- ç´¯ç§¯æ–‡æœ¬å¯¼è‡´æ‰€æœ‰å¥å­æŒ¤åœ¨ä¸€ä¸ªæ°”æ³¡é‡Œ
- ç¬¬ä¸€å¥åˆ›å»ºæ°”æ³¡åï¼Œåç»­å¥å­ä¸€ç›´æ›´æ–°åŒä¸€ä¸ªæ°”æ³¡
- éœ€è¦æ”¹ä¸ºï¼šæ¯ä¸ªå¥å­åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„æ°”æ³¡

---

## ä¿®å¤æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯

**æ¯æ”¶åˆ°ä¸€ä¸ªå¥å­ï¼Œç«‹å³åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ `ChatMessage`**ï¼Œä¸ç´¯ç§¯æ–‡æœ¬ï¼Œä¸æ›´æ–°å·²æœ‰æ°”æ³¡ã€‚

---

## å…·ä½“ä¿®æ”¹è®°å½•

### ä¿®æ”¹1: ç§»é™¤æ–‡æœ¬ç´¯ç§¯é€»è¾‘

**æ–‡ä»¶**: `frontend/pocketspeak_app/lib/pages/chat_page.dart`
**ä½ç½®**: Line 441-516

**ä¿®æ”¹å‰**:
```dart
void _startSentencePlayback() {
  print('ğŸµ å¯åŠ¨é€å¥æ’­æ”¾è½®è¯¢...');

  _lastSentenceIndex = 0;
  _sentenceQueue.clear();
  _isPlayingSentences = false;
  _currentAiMessage = null;
  String accumulatedText = '';  // âŒ ç´¯ç§¯çš„æ–‡æœ¬

  _sentencePollingTimer = Timer.periodic(const Duration(milliseconds: 300), (timer) async {
    // ...è·å–å¥å­

    if (hasNewSentences) {
      final sentences = data['sentences'] as List<dynamic>;

      for (var sentence in sentences) {
        final text = sentence['text'] as String;
        final audioData = sentence['audio_data'] as String;

        // âŒ ç´¯ç§¯æ–‡æœ¬
        accumulatedText += text;

        // âŒ åˆ›å»ºæˆ–æ›´æ–°AIæ¶ˆæ¯ï¼ˆç¬¬ä¸€å¥åˆ›å»ºï¼Œåç»­æ›´æ–°ï¼‰
        if (_currentAiMessage == null) {
          // åˆ›å»ºæ–°æ¶ˆæ¯
          final aiMessage = ChatMessage(
            messageId: 'ai_${DateTime.now().millisecondsSinceEpoch}',
            text: accumulatedText,
            isUser: false,
            timestamp: DateTime.now(),
            hasAudio: true,
          );

          setState(() {
            _messages.add(aiMessage);
          });

          _currentAiMessage = aiMessage;
        } else {
          // âŒ æ›´æ–°æ¶ˆæ¯æ–‡æœ¬
          final updatedMessage = ChatMessage(
            messageId: _currentAiMessage!.messageId,
            text: accumulatedText,
            isUser: false,
            timestamp: _currentAiMessage!.timestamp,
            hasAudio: true,
          );

          setState(() {
            final index = _messages.indexWhere((msg) => msg.messageId == _currentAiMessage!.messageId);
            if (index != -1) {
              _messages[index] = updatedMessage;
            }
          });

          _currentAiMessage = updatedMessage;
        }

        // æ·»åŠ åˆ°æ’­æ”¾é˜Ÿåˆ—
        _sentenceQueue.add({
          'text': text,
          'audioData': audioData,
        });
      }
    }
  });
}
```

**ä¿®æ”¹å**:
```dart
void _startSentencePlayback() {
  print('ğŸµ å¯åŠ¨é€å¥æ’­æ”¾è½®è¯¢...');

  _lastSentenceIndex = 0;
  _sentenceQueue.clear();
  _isPlayingSentences = false;  // âœ… åˆå§‹åŒ–ä¸ºfalse,å…è®¸ç¬¬ä¸€å¥å¼€å§‹æ’­æ”¾

  // æ¯300msè½®è¯¢æ–°å®Œæˆçš„å¥å­ï¼ˆé™ä½é¢‘ç‡å‡å°‘ç³»ç»Ÿè´Ÿæ‹…ï¼‰
  _sentencePollingTimer = Timer.periodic(const Duration(milliseconds: 300), (timer) async {
    try {
      final result = await _voiceService.getCompletedSentences(
        lastSentenceIndex: _lastSentenceIndex,
      );

      if (result['success'] == true) {
        final data = result['data'];
        final hasNewSentences = data['has_new_sentences'] ?? false;
        final isComplete = data['is_complete'] ?? false;

        if (hasNewSentences) {
          final sentences = data['sentences'] as List<dynamic>;

          for (var sentence in sentences) {
            final text = sentence['text'] as String;
            final audioData = sentence['audio_data'] as String;

            _debugLog('ğŸ“ æ”¶åˆ°æ–°å¥å­: $text');

            // âœ… æ¯å¥è¯åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„AIæ¶ˆæ¯æ°”æ³¡
            final aiMessage = ChatMessage(
              messageId: 'ai_${DateTime.now().millisecondsSinceEpoch}',
              text: text,  // âœ… åªæ˜¾ç¤ºå½“å‰å¥å­ï¼Œä¸ç´¯ç§¯
              isUser: false,
              timestamp: DateTime.now(),
              hasAudio: true,
            );

            setState(() {
              _messages.add(aiMessage);
              _isProcessing = false;
            });

            _typingController.stop();
            _scrollToBottom();

            _debugLog('âœ… åˆ›å»ºAIæ¶ˆæ¯æ°”æ³¡: $text');

            // æ·»åŠ åˆ°æ’­æ”¾é˜Ÿåˆ—
            _sentenceQueue.add({
              'text': text,
              'audioData': audioData,
            });
          }

          // æ›´æ–°ç´¢å¼•
          _lastSentenceIndex = data['total_sentences'];

          // ç«‹å³å¯åŠ¨æ’­æ”¾
          if (!_isPlayingSentences) {
            _playNextSentence();
          }
        }

        // TTSå®Œæˆ,åœæ­¢è½®è¯¢
        if (isComplete) {
          _debugLog('ğŸ›‘ TTSå®Œæˆ,åœæ­¢å¥å­è½®è¯¢');
          timer.cancel();
          _sentencePollingTimer = null;
        }
      }
    } catch (e) {
      _debugLog('âŒ è·å–å¥å­å¤±è´¥: $e');
    }
  });
}
```

### ä¿®æ”¹2: ç§»é™¤ä¸å†ä½¿ç”¨çš„å˜é‡

**æ–‡ä»¶**: `frontend/pocketspeak_app/lib/pages/chat_page.dart`
**ä½ç½®**: Line 77-83

**ä¿®æ”¹å‰**:
```dart
// é€å¥æ’­æ”¾ç›¸å…³
Timer? _sentencePollingTimer;  // å¥å­è½®è¯¢å®šæ—¶å™¨
int _lastSentenceIndex = 0;  // ä¸Šæ¬¡è·å–åˆ°çš„å¥å­ç´¢å¼•
List<Map<String, String>> _sentenceQueue = [];  // å¥å­é˜Ÿåˆ—
bool _isPlayingSentences = false;  // æ˜¯å¦æ­£åœ¨æ’­æ”¾å¥å­é˜Ÿåˆ—
StreamSubscription? _playbackSubscription;  // æ’­æ”¾å®Œæˆç›‘å¬å™¨
ChatMessage? _currentAiMessage;  // âŒ å½“å‰æ­£åœ¨æ„å»ºçš„AIæ¶ˆæ¯(é€å¥ç´¯ç§¯æ–‡æœ¬)
String? _lastProcessedMessageId;  // ä¸Šæ¬¡å¤„ç†è¿‡çš„æ¶ˆæ¯ID
```

**ä¿®æ”¹å**:
```dart
// é€å¥æ’­æ”¾ç›¸å…³
Timer? _sentencePollingTimer;  // å¥å­è½®è¯¢å®šæ—¶å™¨
int _lastSentenceIndex = 0;  // ä¸Šæ¬¡è·å–åˆ°çš„å¥å­ç´¢å¼•
List<Map<String, String>> _sentenceQueue = [];  // å¥å­é˜Ÿåˆ—
bool _isPlayingSentences = false;  // æ˜¯å¦æ­£åœ¨æ’­æ”¾å¥å­é˜Ÿåˆ—
StreamSubscription? _playbackSubscription;  // æ’­æ”¾å®Œæˆç›‘å¬å™¨
String? _lastProcessedMessageId;  // ä¸Šæ¬¡å¤„ç†è¿‡çš„æ¶ˆæ¯ID
// âœ… ç§»é™¤äº† _currentAiMessageï¼Œä¸å†éœ€è¦ç´¯ç§¯æ–‡æœ¬
```

---

## ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰

```
AIå›å¤: "åœ¨å¸®ç¨‹åºå‘˜ç”·å‹debugå•¦ï¼Œä»–å†™çš„ä»£ç åƒæäº†æˆ‘ä»¬çš„çˆ±æƒ…â€”â€”ä¸€å †warningä½†è¿˜èƒ½è¿è¡Œã€‚"

ç•Œé¢æ˜¾ç¤º:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœ¨å¸®ç¨‹åºå‘˜ç”·å‹debugå•¦ï¼Œä»–å†™çš„  â”‚
â”‚ ä»£ç åƒæäº†æˆ‘ä»¬çš„çˆ±æƒ…â€”â€”ä¸€å †     â”‚
â”‚ warningä½†è¿˜èƒ½è¿è¡Œã€‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     (ä¸€ä¸ªå¤§æ°”æ³¡ï¼ŒåŒ…å«æ‰€æœ‰å¥å­)
```

### ä¿®å¤å

```
AIå›å¤: "åœ¨å¸®ç¨‹åºå‘˜ç”·å‹debugå•¦ï¼Œ" + "ä»–å†™çš„ä»£ç åƒæäº†æˆ‘ä»¬çš„çˆ±æƒ…â€”â€”ä¸€å †warningä½†è¿˜èƒ½è¿è¡Œã€‚"

ç•Œé¢æ˜¾ç¤º:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœ¨å¸®ç¨‹åºå‘˜ç”·å‹debugå•¦ï¼Œ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     (æ°”æ³¡1: ç¬¬ä¸€å¥)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»–å†™çš„ä»£ç åƒæäº†æˆ‘ä»¬çš„çˆ±æƒ…â€”â€”   â”‚
â”‚ ä¸€å †warningä½†è¿˜èƒ½è¿è¡Œã€‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     (æ°”æ³¡2: ç¬¬äºŒå¥)
```

---

## é¢„æœŸæ—¥å¿—è¾“å‡º

ä¿®å¤åï¼Œæ—¥å¿—åº”è¯¥å¦‚ä¸‹ï¼š

```
flutter: ğŸ“ æ”¶åˆ°æ–°å¥å­: åœ¨å¸®ç¨‹åºå‘˜ç”·å‹debugå•¦ï¼Œ
flutter: âœ… åˆ›å»ºAIæ¶ˆæ¯æ°”æ³¡: åœ¨å¸®ç¨‹åºå‘˜ç”·å‹debugå•¦ï¼Œ
flutter: ğŸ”Š å¼€å§‹æ’­æ”¾å¥å­: åœ¨å¸®ç¨‹åºå‘˜ç”·å‹debugå•¦ï¼Œ
flutter: âœ… å¥å­æ’­æ”¾å®Œæˆ,æ’­æ”¾ä¸‹ä¸€å¥

flutter: ğŸ“ æ”¶åˆ°æ–°å¥å­: ä»–å†™çš„ä»£ç åƒæäº†æˆ‘ä»¬çš„çˆ±æƒ…â€”â€”ä¸€å †warningä½†è¿˜èƒ½è¿è¡Œã€‚
flutter: âœ… åˆ›å»ºAIæ¶ˆæ¯æ°”æ³¡: ä»–å†™çš„ä»£ç åƒæäº†æˆ‘ä»¬çš„çˆ±æƒ…â€”â€”ä¸€å †warningä½†è¿˜èƒ½è¿è¡Œã€‚
flutter: ğŸ”Š å¼€å§‹æ’­æ”¾å¥å­: ä»–å†™çš„ä»£ç åƒæäº†æˆ‘ä»¬çš„çˆ±æƒ…â€”â€”ä¸€å †warningä½†è¿˜èƒ½è¿è¡Œã€‚
flutter: âœ… å¥å­æ’­æ”¾å®Œæˆ,æ’­æ”¾ä¸‹ä¸€å¥
flutter: ğŸ›‘ TTSå®Œæˆ,åœæ­¢å¥å­è½®è¯¢
```

---

## æµ‹è¯•éªŒè¯æ–¹æ³•

### æ­¥éª¤

1. **å¯åŠ¨åº”ç”¨å¹¶çƒ­é‡è½½**
```bash
cd frontend/pocketspeak_app
flutter run
# æŒ‰ r çƒ­é‡è½½
```

2. **è¿›è¡Œå¯¹è¯æµ‹è¯•**
   - ç‚¹å‡»å½•éŸ³æŒ‰é’®
   - è¯´ï¼š"åœ¨å—åœ¨å—ï¼Ÿ"
   - æ¾å¼€æŒ‰é’®
   - è§‚å¯ŸAIå›å¤

3. **éªŒè¯è¦ç‚¹**

âœ… **æ¯å¥è¯ä¸€ä¸ªç‹¬ç«‹æ°”æ³¡**ï¼š
- ç¬¬ä¸€å¥å‡ºç°åœ¨ç¬¬ä¸€ä¸ªæ°”æ³¡
- ç¬¬äºŒå¥å‡ºç°åœ¨ç¬¬äºŒä¸ªæ°”æ³¡
- æ¯ä¸ªæ°”æ³¡ç‹¬ç«‹æ˜¾ç¤º

âœ… **æ’­æ”¾é€»è¾‘æ­£å¸¸**ï¼š
- ç¬¬ä¸€å¥æ’­æ”¾å®Œæˆåè‡ªåŠ¨æ’­æ”¾ç¬¬äºŒå¥
- éŸ³é¢‘ä¸å¡é¡¿
- æ–‡æœ¬æ˜¾ç¤ºä¸éŸ³é¢‘åŒæ­¥

âœ… **ç•Œé¢æµç•…**ï¼š
- å¥å­é€ä¸ªå‡ºç°
- æ»šåŠ¨åˆ°åº•éƒ¨
- æ— UIå¡é¡¿

---

## æŠ€æœ¯æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›

**ä¿®æ”¹å‰**ï¼ˆç´¯ç§¯æ¨¡å¼ï¼‰ï¼š
```dart
æ”¶åˆ°å¥å­1 â†’ åˆ›å»ºæ°”æ³¡Aï¼Œæ˜¾ç¤º"å¥å­1"
æ”¶åˆ°å¥å­2 â†’ æ›´æ–°æ°”æ³¡Aï¼Œæ˜¾ç¤º"å¥å­1å¥å­2"
æ”¶åˆ°å¥å­3 â†’ æ›´æ–°æ°”æ³¡Aï¼Œæ˜¾ç¤º"å¥å­1å¥å­2å¥å­3"
```

**ä¿®æ”¹å**ï¼ˆç‹¬ç«‹æ¨¡å¼ï¼‰ï¼š
```dart
æ”¶åˆ°å¥å­1 â†’ åˆ›å»ºæ°”æ³¡Aï¼Œæ˜¾ç¤º"å¥å­1"
æ”¶åˆ°å¥å­2 â†’ åˆ›å»ºæ°”æ³¡Bï¼Œæ˜¾ç¤º"å¥å­2"
æ”¶åˆ°å¥å­3 â†’ åˆ›å»ºæ°”æ³¡Cï¼Œæ˜¾ç¤º"å¥å­3"
```

### è®¾è®¡æ¨¡å¼

è¿™æ˜¯**å±•ç¤ºç²’åº¦ï¼ˆDisplay Granularityï¼‰**çš„ä¼˜åŒ–ï¼š

```
âŒ ç²—ç²’åº¦ï¼šæ•´æ®µå›å¤ä½œä¸ºä¸€ä¸ªå±•ç¤ºå•å…ƒ
   â†’ ç”¨æˆ·çœ‹ä¸åˆ°AI"é€å¥æ€è€ƒ"çš„è¿‡ç¨‹
   â†’ ç±»ä¼¼ä¼ ç»Ÿçš„æ¶ˆæ¯åº”ç”¨

âœ… ç»†ç²’åº¦ï¼šæ¯å¥è¯ä½œä¸ºä¸€ä¸ªå±•ç¤ºå•å…ƒ
   â†’ ç”¨æˆ·æ„Ÿå—åˆ°AI"è¾¹è¯´è¾¹æƒ³"
   â†’ æ›´ç¬¦åˆè¯­éŸ³å¯¹è¯çš„è‡ªç„¶ä½“éªŒ
   â†’ ç±»ä¼¼çœŸäººå¯¹è¯æ—¶çš„é€å¥è¡¨è¾¾
```

### ç”¨æˆ·ä½“éªŒæå‡

1. **è§†è§‰åé¦ˆ**ï¼šç”¨æˆ·èƒ½æ¸…æ™°çœ‹åˆ°æ¯å¥è¯çš„è¾¹ç•Œ
2. **è®¤çŸ¥è´Ÿæ‹…**ï¼šæ¯ä¸ªæ°”æ³¡å†…å®¹æ›´çŸ­ï¼Œæ›´æ˜“é˜…è¯»
3. **å¯¹è¯æ„Ÿ**ï¼šæ¨¡æ‹ŸçœŸäººé€å¥è¯´è¯çš„èŠ‚å¥
4. **å¯è¯»æ€§**ï¼šé•¿æ®µè½è¢«è‡ªç„¶åˆ†å‰²ï¼Œé¿å…è§†è§‰ç–²åŠ³

---

## ç›¸å…³æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶

1. `frontend/pocketspeak_app/lib/pages/chat_page.dart`
   - Line 77-83: ç§»é™¤ `_currentAiMessage` å˜é‡
   - Line 441-516: æ”¹ä¸ºæ¯å¥è¯åˆ›å»ºç‹¬ç«‹æ°”æ³¡

### æœªä¿®æ”¹çš„æ–‡ä»¶

- `backend/*` (æ— éœ€ä¿®æ”¹)
- `frontend/lib/services/*` (æ— éœ€ä¿®æ”¹)
- `frontend/lib/models/*` (æ— éœ€ä¿®æ”¹)

---

## Debugè§„åˆ™éµå®ˆæƒ…å†µ

âœ… **ç¬¬ä¸€æ­¥ï¼šç¡®è®¤é—®é¢˜** - ç”¨æˆ·æ˜ç¡®æŒ‡å‡ºæ¯å¥è¯åº”è¯¥ç‹¬ç«‹æ˜¾ç¤º
âœ… **ç¬¬äºŒæ­¥ï¼šåˆ†æä»£ç ** - æ‰¾åˆ°æ–‡æœ¬ç´¯ç§¯é€»è¾‘
âœ… **ç¬¬ä¸‰æ­¥ï¼šç²¾å‡†ä¿®æ”¹** - åªä¿®æ”¹é€å¥æ’­æ”¾é€»è¾‘ï¼Œä¸å½±å“å…¶ä»–åŠŸèƒ½
âœ… **ä¿®æ”¹é€æ˜åŒ–** - æ‰€æœ‰ä¿®æ”¹éƒ½è®°å½•åœ¨æœ¬æ–‡æ¡£ä¸­
âœ… **å¯å›æ»š** - å¯ä»¥é€šè¿‡gitå›æ»š
âœ… **æ›´æ–°æ–‡æ¡£** - è®°å½•äº†å®Œæ•´çš„ä¿®å¤è¿‡ç¨‹

---

## æ€»ç»“

### ä¿®å¤å‰é—®é¢˜

- AIçš„å¤šå¥å›å¤æŒ¤åœ¨åŒä¸€ä¸ªæ°”æ³¡é‡Œ
- åŸå› ï¼šæ–‡æœ¬ç´¯ç§¯ + æ›´æ–°åŒä¸€ä¸ªæ¶ˆæ¯

### ä¿®å¤åæ•ˆæœ

- âœ… æ¯å¥è¯ä¸€ä¸ªç‹¬ç«‹æ°”æ³¡
- âœ… é€å¥æ˜¾ç¤ºï¼Œæ›´ç¬¦åˆè¯­éŸ³å¯¹è¯ä½“éªŒ
- âœ… æ’­æ”¾é€»è¾‘ä¸å˜ï¼Œä»ç„¶é€å¥æ’­æ”¾éŸ³é¢‘

### ä¿®å¤æˆæœ

- **ä¿®æ”¹æ–‡ä»¶æ•°**: 1ä¸ª
- **ä¿®æ”¹ä»£ç è¡Œæ•°**: çº¦70è¡Œ
- **ä¿®å¤æ—¶é—´**: 15åˆ†é’Ÿ
- **æµ‹è¯•çŠ¶æ€**: å¾…ç”¨æˆ·éªŒè¯

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-01-07
**ä¿®å¤äººå‘˜**: Claude
**å®¡æ ¸çŠ¶æ€**: å¾…ç”¨æˆ·æµ‹è¯•éªŒè¯

## ä¸‹ä¸€æ­¥

**è¯·ç”¨æˆ·æµ‹è¯•**ï¼š
1. çƒ­é‡è½½å‰ç«¯ï¼ˆæŒ‰ `r` é”®ï¼‰
2. è¿›è¡Œè¯­éŸ³å¯¹è¯
3. è§‚å¯ŸAIå›å¤æ˜¯å¦æ¯å¥è¯ä¸€ä¸ªæ°”æ³¡
4. åé¦ˆæµ‹è¯•ç»“æœ
