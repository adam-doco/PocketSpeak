# é‡æ–°æ€è€ƒï¼šç®€åŒ–æ–¹æ¡ˆ

**æ—¥æœŸ**: 2025-01-07
**é—®é¢˜**: æˆ‘æ˜¯ä¸æ˜¯æŠŠé—®é¢˜å¤æ‚åŒ–äº†ï¼Ÿ

---

## ğŸ¤” ç”¨æˆ·çš„è´¨ç–‘

> "ä¸€ä¸ªè¯­éŸ³æ’­æ”¾é€»è¾‘éœ€è¦æ”¹è¿™ä¹ˆå¤šä¸œè¥¿å—ï¼Ÿï¼Ÿï¼Ÿï¼Ÿèƒ½ä¸èƒ½æŠŠZoev4çš„ç›´æ¥æ‹¿è¿‡æ¥ç”¨å‘¢ï¼Ÿ"

**ç”¨æˆ·è¯´å¾—å¯¹ï¼**è®©æˆ‘é‡æ–°ç†æ¸…æ¥šæ¶æ„ã€‚

---

## ğŸ“Š æ¶æ„å¯¹æ¯”é‡æ–°æ¢³ç†

### PocketSpeakå½“å‰æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               PocketSpeakåç«¯                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ WebSocket
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          å°æ™ºAIå®˜æ–¹æœåŠ¡å™¨                        â”‚
â”‚         (wss://api.tenclass.net)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                      â”‚
    AUDIOæ¶ˆæ¯              TEXTæ¶ˆæ¯
        â”‚                      â”‚
        â–¼                      â–¼
   _pcm_chunks            _sentences
        â”‚                      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
         ç­‰å¾…å¥å­å®Œæˆ (is_complete=True)
                   â”‚
                   â–¼
            å‰ç«¯è½®è¯¢è·å– (30ms)
                   â”‚
                   â–¼
            é€å¥æ’­æ”¾ (ç­‰å¾…ä¸Šä¸€å¥æ’­å®Œ)
```

**å»¶è¿Ÿæ¥æº**:
1. ç­‰å¾…TEXTæ¶ˆæ¯æ ‡è®°å¥å­å®Œæˆ: +200-300ms
2. å‰ç«¯è½®è¯¢å‘¨æœŸ: +15ms (å¹³å‡)
3. ç­‰å¾…ä¸Šä¸€å¥æ’­æ”¾å®Œæˆ: +200-500ms

**æ€»å»¶è¿Ÿ**: 415-815ms

---

### Zoev4çš„æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Zoev4åç«¯                         â”‚
â”‚          (zoev3_audio_bridge)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ WebSocket
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               æœ¬åœ°Zoev3                         â”‚
â”‚          (è¿è¡Œåœ¨åŒä¸€æœåŠ¡å™¨)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                OPUSå¸§
                    â”‚
                    â–¼
         ç«‹å³è½¬å‘ç»™å‰ç«¯ (WebSocket)
                    â”‚
                    â–¼
               å‰ç«¯æ”¶åˆ°
                    â”‚
                    â–¼
            ç«‹å³è§£ç +æ’­æ”¾
```

**å»¶è¿Ÿ**: ~50ms

---

## ğŸ’¡ å…³é”®åŒºåˆ«åœ¨å“ªé‡Œï¼Ÿ

### åŒºåˆ«1: AIæœåŠ¡æ¥æºä¸åŒ

| é¡¹ç›® | AIæœåŠ¡æ¥æº | é€šä¿¡æ–¹å¼ |
|------|-----------|---------|
| **PocketSpeak** | äº‘ç«¯å°æ™ºAI | WebSocket (è¿œç¨‹) |
| **Zoev4** | æœ¬åœ°Zoev3 | æœ¬åœ°é€šä¿¡ |

**ç»“è®º**: Zoev4çš„ä½å»¶è¿Ÿéƒ¨åˆ†æ¥è‡ªäº"æœ¬åœ°AI"ï¼Œæˆ‘ä»¬æ— æ³•å¤åˆ¶ï¼

---

### åŒºåˆ«2: åè®®å·®å¼‚

**å°æ™ºAIå®˜æ–¹åè®®**ï¼ˆPocketSpeakä½¿ç”¨ï¼‰:
```json
// éŸ³é¢‘æ¶ˆæ¯
{
  "type": "audio",
  "format": "opus",
  "data": "..."
}

// æ–‡æœ¬æ¶ˆæ¯ï¼ˆå•ç‹¬å‘é€ï¼‰
{
  "type": "text",
  "content": "ä½ å¥½"
}

// TTSåœæ­¢ä¿¡å·
{
  "type": "tts",
  "tts_stop": true
}
```

**ç‰¹ç‚¹**: éŸ³é¢‘å’Œæ–‡æœ¬åˆ†ç¦»ï¼Œéœ€è¦ç­‰TEXTæ¶ˆæ¯æ¥å®šä¹‰å¥å­è¾¹ç•Œ

---

**Zoev4åè®®**ï¼ˆè‡ªå®šä¹‰ï¼‰:
```javascript
// éŸ³é¢‘ç›´æ¥å‘é€äºŒè¿›åˆ¶
WebSocket.send(opusFrameBytes)

// æ–‡æœ¬é€šè¿‡JSONï¼ˆå¯é€‰ï¼‰
{
  "type": "text",
  "content": "..."
}
```

**ç‰¹ç‚¹**: è‡ªå·±æ§åˆ¶åè®®ï¼Œå¯ä»¥ä¸ç­‰TEXT

---

## ğŸ¯ çœŸæ­£çš„é—®é¢˜

### é—®é¢˜ä¸åœ¨äº"æ’­æ”¾å™¨å®ç°"ï¼Œè€Œåœ¨äº"å¥å­è¾¹ç•Œç­‰å¾…"ï¼

**æ ¸å¿ƒçŸ›ç›¾**:
- å°æ™ºAIåè®®ï¼šéŸ³é¢‘å’Œæ–‡æœ¬åˆ†ç¦»
- PocketSpeakå½“å‰é€»è¾‘ï¼šå¿…é¡»ç­‰TEXTåˆ°è¾¾æ‰èƒ½æ’­æ”¾éŸ³é¢‘
- **è¿™å°±æ˜¯å»¶è¿Ÿçš„æ ¹æœ¬åŸå› ï¼**

---

## ğŸ’¡ ç®€åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆï¼šä¸ç­‰TEXTï¼ŒéŸ³é¢‘åˆ°è¾¾å°±æ’­æ”¾ï¼

#### åç«¯ä¿®æ”¹ï¼ˆè¶…ç®€å•ï¼ï¼‰

**æ–‡ä»¶**: `voice_session_manager.py`

**åŸæ¥çš„é€»è¾‘**:
```python
async def _on_ws_message_received(self, message: str):
    parsed_response = self.ws_client.parse_message(message)

    if parsed_response.message_type == MessageType.AUDIO:
        # ä»…ç´¯ç§¯ï¼Œä¸æ¨é€
        self.current_message.append_audio_chunk(audio_data)

    elif parsed_response.message_type == MessageType.TEXT:
        # æ”¶åˆ°TEXTæ‰æ ‡è®°å¥å­å®Œæˆ
        self.current_message.add_text_sentence(text)
```

**æ–°é€»è¾‘**ï¼ˆåªæ”¹ä¸€ä¸ªæ–¹æ³•ï¼ï¼‰:
```python
async def _on_ws_message_received(self, message: str):
    parsed_response = self.ws_client.parse_message(message)

    if parsed_response.message_type == MessageType.AUDIO:
        # âœ… 1. ç´¯ç§¯åˆ°å†å²è®°å½•
        self.current_message.append_audio_chunk(audio_data)

        # âœ… 2. ç«‹å³æ ‡è®°å½“å‰å¥å­"å¯æ’­æ”¾"ï¼ˆä¸ç­‰TEXTï¼ï¼‰
        if self.current_message._sentences:
            # å¦‚æœæœ‰å½“å‰å¥å­ï¼Œæ›´æ–°å…¶end_chunk
            self.current_message._sentences[-1]["end_chunk"] = len(self.current_message._pcm_chunks)
            self.current_message._sentences[-1]["is_complete"] = True  # â† å…³é”®ï¼

    elif parsed_response.message_type == MessageType.TEXT:
        # âœ… TEXTåˆ°è¾¾ï¼šåˆ›å»ºæ–°å¥å­
        # æ”¶åˆ°TEXTè¯´æ˜ä¸Šä¸€å¥å·²ç»å®Œæˆï¼Œå¼€å§‹æ–°å¥å­
        if self.current_message._sentences:
            # ä¸Šä¸€å¥å·²ç»æ ‡è®°å®Œæˆäº†ï¼ˆåœ¨AUDIOåˆ°è¾¾æ—¶ï¼‰
            pass

        # åˆ›å»ºæ–°å¥å­
        self.current_message._sentences.append({
            "text": text,
            "start_chunk": len(self.current_message._pcm_chunks),
            "end_chunk": None,
            "is_complete": False  # é»˜è®¤æœªå®Œæˆï¼Œç­‰AUDIOåˆ°è¾¾æ—¶æ ‡è®°
        })
```

**å°±è¿™ä¹ˆç®€å•ï¼**

---

#### å‰ç«¯ä¸ç”¨æ”¹ï¼ï¼ï¼

**å…³é”®å‘ç°**: å‰ç«¯çš„è½®è¯¢é€»è¾‘ä¸éœ€è¦æ”¹ï¼

```dart
// å‰ç«¯ç°æœ‰é€»è¾‘å®Œå…¨ä¸ç”¨åŠ¨ï¼
_sentencePollingTimer = Timer.periodic(Duration(milliseconds: 30), (timer) async {
  final result = await _voiceService.getCompletedSentences(...);

  if (result['data']['has_new_sentences']) {
    // éŸ³é¢‘å·²ç»ç«‹å³å¯ç”¨ï¼ˆå› ä¸ºåç«¯ä¸ç­‰TEXTäº†ï¼‰
    _sentenceQueue.add(sentences);
    _playNextSentence();
  }
});
```

**ä¸ºä»€ä¹ˆä¸ç”¨æ”¹ï¼Ÿ**
- åç«¯æ”¹ä¸º"éŸ³é¢‘åˆ°è¾¾å°±æ ‡è®°is_complete=True"
- å‰ç«¯è½®è¯¢åˆ°çš„å¥å­ç«‹å³æœ‰éŸ³é¢‘
- æ— éœ€ç­‰å¾…TEXTæ¶ˆæ¯ï¼

---

## ğŸ“Š æ•ˆæœå¯¹æ¯”

| æ–¹æ¡ˆ | åç«¯ä¿®æ”¹ | å‰ç«¯ä¿®æ”¹ | é¢„æœŸå»¶è¿Ÿ | é£é™© |
|------|---------|---------|---------|------|
| **æˆ‘ä¹‹å‰çš„æ–¹æ¡ˆ** | æ–°å¢WebSocketæ¨é€ | å®Œå…¨é‡å†™æ’­æ”¾å™¨ | 50-100ms | â­â­â­â­ |
| **ç®€åŒ–æ–¹æ¡ˆ** | åªæ”¹1ä¸ªæ–¹æ³• | **ä¸ç”¨æ”¹** | 150-200ms | â­ |

---

## âš ï¸ ç®€åŒ–æ–¹æ¡ˆçš„é—®é¢˜

### é—®é¢˜1: TEXTæ™šäºAUDIOåˆ°è¾¾

**åœºæ™¯**:
```
T+0ms:   æ”¶åˆ°AUDIOå¸§1-5
T+50ms:  æ ‡è®°å¥å­1å®Œæˆ (is_complete=True)
T+80ms:  å‰ç«¯è½®è¯¢åˆ°å¥å­1ï¼ˆä½†text=""ï¼‰â† é—®é¢˜ï¼
T+120ms: æ”¶åˆ°TEXT "ä½ å¥½"
```

**ç»“æœ**: å‰ç«¯æ”¶åˆ°çš„å¥å­å¯èƒ½æ²¡æœ‰æ–‡å­—ï¼

**è§£å†³æ–¹æ¡ˆA**: å‰ç«¯å®¹å¿ç©ºæ–‡å­—
```dart
if (sentence['text'] == null || sentence['text'].isEmpty) {
  sentence['text'] = '...';  // æ˜¾ç¤ºå ä½ç¬¦
}
```

**è§£å†³æ–¹æ¡ˆB**: åç«¯å…ˆç¼“å†²éŸ³é¢‘ï¼Œç­‰TEXTåˆ°è¾¾å†ä¸€èµ·å‘
- âŒ ä½†è¿™åˆå›åˆ°äº†åŸæ¥çš„å»¶è¿Ÿé—®é¢˜

---

### é—®é¢˜2: å¥å­åˆ‡åˆ†ä¸å‡†ç¡®

**åœºæ™¯**: å¦‚æœTEXTæ™šåˆ°è¾¾ï¼ŒéŸ³é¢‘ä¼šè¢«åˆ‡åˆ†åˆ°é”™è¯¯çš„å¥å­

```
T+0ms:   æ”¶åˆ°AUDIOå¸§1-5 (å±äºå¥å­1)
T+50ms:  æ ‡è®°å¥å­1å®Œæˆï¼Œå‰ç«¯å¼€å§‹æ’­æ”¾
T+120ms: æ”¶åˆ°TEXT "ä½ å¥½" â†’ åˆ›å»ºå¥å­1
T+150ms: æ”¶åˆ°AUDIOå¸§6-10 (å±äºå¥å­1ï¼Œä½†è¢«å½’åˆ°å¥å­2äº†ï¼)
```

**ç»“æœ**: å¥å­åˆ‡åˆ†é”™è¯¯ï¼

---

## ğŸ¤” æ ¹æœ¬çŸ›ç›¾

**å°æ™ºAIåè®®çš„è®¾è®¡**:
- AUDIOå’ŒTEXTåˆ†ç¦»å‘é€
- TEXTç”¨äºå®šä¹‰å¥å­è¾¹ç•Œ
- ä¸¤è€…åˆ°è¾¾æ—¶é—´ä¸ç¡®å®š

**PocketSpeakçš„éœ€æ±‚**:
- éŸ³é¢‘è¦ç«‹å³æ’­æ”¾ï¼ˆä½å»¶è¿Ÿï¼‰
- æ–‡å­—è¦å‡†ç¡®åˆ‡åˆ†ï¼ˆé€å¥æ˜¾ç¤ºï¼‰

**è¿™ä¸¤ä¸ªéœ€æ±‚æœ‰å¤©ç„¶å†²çªï¼**

---

## ğŸ’¡ æœ€ç»ˆç»“è®º

### æ–¹æ¡ˆ1: æ”¾å¼ƒé€å¥æ˜¾ç¤ºï¼Œæ”¹ä¸º"æµå¼æ˜¾ç¤º"

**ç­–ç•¥**:
- éŸ³é¢‘åˆ°è¾¾å°±æ’­æ”¾ï¼ˆä¸ç­‰TEXTï¼‰
- TEXTåˆ°è¾¾å°±è¿½åŠ åˆ°å½“å‰æ°”æ³¡ï¼ˆä¸åˆ›å»ºæ–°æ°”æ³¡ï¼‰

**æ•ˆæœ**:
- âœ… éŸ³é¢‘å»¶è¿Ÿé™è‡³~50ms
- âœ… æ–‡å­—æ˜¾ç¤ºæµç•…
- âŒ å¤±å»"é€å¥æ°”æ³¡"æ•ˆæœ

---

### æ–¹æ¡ˆ2: ä¿æŒé€å¥æ˜¾ç¤ºï¼Œæ¥å—å»¶è¿Ÿ

**ç­–ç•¥**:
- ç­‰TEXTåˆ°è¾¾åå†æ’­æ”¾éŸ³é¢‘
- ä¿æŒå‡†ç¡®çš„å¥å­åˆ‡åˆ†

**æ•ˆæœ**:
- âŒ éŸ³é¢‘å»¶è¿Ÿä»ç„¶~300ms
- âœ… é€å¥æ°”æ³¡å‡†ç¡®
- âœ… ä¸ç”¨æ”¹æ¶æ„

---

### æ–¹æ¡ˆ3: æ–‡å­—å’ŒéŸ³é¢‘è§£è€¦ï¼ˆæˆ‘ä¹‹å‰çš„æ–¹æ¡ˆï¼‰

**ç­–ç•¥**:
- éŸ³é¢‘åˆ°è¾¾ç«‹å³æ’­æ”¾ï¼ˆWebSocketæ¨é€ï¼‰
- æ–‡å­—åˆ°è¾¾æ˜¾ç¤ºæ°”æ³¡ï¼ˆç‹¬ç«‹é€»è¾‘ï¼‰
- ä¸¤è€…ä¸ç»‘å®š

**æ•ˆæœ**:
- âœ… éŸ³é¢‘å»¶è¿Ÿé™è‡³~50ms
- âœ… ä¿æŒé€å¥æ°”æ³¡
- âš ï¸ æ–‡å­—å¯èƒ½æ™š100-200msæ˜¾ç¤º
- âŒ éœ€è¦å¤§æ”¹ï¼ˆå‰åç«¯éƒ½è¦æ”¹ï¼‰

---

## ğŸ¯ ç»™ç”¨æˆ·çš„é—®é¢˜

**æˆ‘éœ€è¦ä½ æ˜ç¡®ä¸€ä¸‹éœ€æ±‚ä¼˜å…ˆçº§**:

1. **éŸ³é¢‘å»¶è¿Ÿæœ€é‡è¦** â†’ é€‰æ–¹æ¡ˆ1æˆ–æ–¹æ¡ˆ3
   - æ–¹æ¡ˆ1: ç®€å•ï¼Œä½†å¤±å»é€å¥æ°”æ³¡
   - æ–¹æ¡ˆ3: å¤æ‚ï¼Œä½†ä¿ç•™é€å¥æ°”æ³¡

2. **é€å¥æ°”æ³¡æœ€é‡è¦** â†’ é€‰æ–¹æ¡ˆ2
   - æ¥å—300mså»¶è¿Ÿ
   - ä»…å¾®è°ƒå‚æ•°ï¼ˆé™ä½è½®è¯¢é—´éš”åˆ°10msï¼‰

3. **ä¸¤è€…éƒ½è¦** â†’ å¿…é¡»é€‰æ–¹æ¡ˆ3
   - å¤§æ”¹æ¶æ„
   - 8-12å°æ—¶å¼€å‘

---

**è¯·å‘Šè¯‰æˆ‘ä½ çš„é€‰æ‹©ï¼**
