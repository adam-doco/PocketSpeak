# ğŸ”§ ç¬¬äºŒæ¬¡ä¿®å¤ï¼šWebSocketéŸ³é¢‘æ¨é€é—®é¢˜

**æ—¶é—´**: 2025-01-12
**ä¼˜å…ˆçº§**: P0
**çŠ¶æ€**: å·²ä¿®å¤ â†’ ç­‰å¾…æµ‹è¯•

---

## ğŸ¯ é—®é¢˜åˆ†æ

### ç”¨æˆ·åé¦ˆ

1. âœ… **æ–‡å­—ä¸é‡å¤äº†** - ç¬¬ä¸€æ¬¡ä¿®å¤æˆåŠŸ
2. âŒ **å£°éŸ³ä»ç„¶å¡é¡¿** - éŸ³é¢‘æ¨é€ä»æœ‰é—®é¢˜

### æ—¥å¿—åˆ†æ

**åç«¯æ—¥å¿—**ï¼š
```
INFO:services.voice_chat.voice_session_manager:âœ… æµå¼OPUSè§£ç å™¨å·²åˆå§‹åŒ–
```
- `_on_audio_received` è¢«è°ƒç”¨äº†
- è§£ç å™¨åˆå§‹åŒ–æˆåŠŸ

**ä½†æ˜¯å‰ç«¯æ—¥å¿—**ï¼š
```
flutter: ğŸµ å¯åŠ¨è¿ç»­æ’­æ”¾å¾ªç¯
flutter: âœ… è¿ç»­æ’­æ”¾å¾ªç¯ç»“æŸ  // â† ç«‹å³ç»“æŸï¼
```
- **å‰ç«¯å®Œå…¨æ²¡æœ‰æ”¶åˆ°éŸ³é¢‘å¸§**
- æ’­æ”¾å¾ªç¯å¯åŠ¨åç«‹å³ç»“æŸï¼ˆé˜Ÿåˆ—ä¸ºç©ºï¼‰

### æ ¹æœ¬åŸå› 

**é—®é¢˜åœ¨äº `on_audio_frame` å›è°ƒçš„æ‰§è¡Œæ–¹å¼**ï¼š

åŸä»£ç ï¼ˆvoice_chat.py:826-833ï¼‰ï¼š
```python
def on_audio_frame(audio_data: bytes):
    """æ”¶åˆ°éŸ³é¢‘å¸§ç«‹å³æ¨é€"""
    import base64
    asyncio.create_task(websocket.send_json({
        "type": "audio_frame",
        "data": base64.b64encode(audio_data).decode('utf-8')
    }))
```

**é—®é¢˜**ï¼š
- `asyncio.create_task` åˆ›å»ºçš„ä»»åŠ¡å¯èƒ½ä¸ä¼šç«‹å³æ‰§è¡Œ
- æˆ–è€…åœ¨æŸäº›æƒ…å†µä¸‹ä»»åŠ¡ä¼šè¢«å–æ¶ˆ
- æ²¡æœ‰é”™è¯¯å¤„ç†ï¼Œå¦‚æœå‘é€å¤±è´¥ä¹Ÿä¸çŸ¥é“

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: ä½¿ç”¨ `run_coroutine_threadsafe` ç¡®ä¿ä»»åŠ¡æ‰§è¡Œ

**æ–‡ä»¶**: `backend/routers/voice_chat.py` (826-845è¡Œ)

**ä¿®æ”¹**ï¼š
```python
def on_audio_frame(audio_data: bytes):
    """æ”¶åˆ°éŸ³é¢‘å¸§ç«‹å³æ¨é€ï¼ˆæ¨¡ä»¿py-xiaozhiçš„å³æ—¶æ’­æ”¾ï¼‰"""
    import base64
    try:
        # ğŸ”¥ å…³é”®ä¿®å¤ï¼šä½¿ç”¨ run_coroutine_threadsafe ç¡®ä¿ä»»åŠ¡çœŸæ­£æ‰§è¡Œ
        loop = asyncio.get_event_loop()

        async def _send():
            try:
                await websocket.send_json({
                    "type": "audio_frame",
                    "data": base64.b64encode(audio_data).decode('utf-8')
                })
                logger.debug(f"âœ… éŸ³é¢‘å¸§å·²æ¨é€: {len(audio_data)} bytes")
            except Exception as e:
                logger.error(f"âŒ WebSocketå‘é€éŸ³é¢‘å¸§å¤±è´¥: {e}")

        asyncio.run_coroutine_threadsafe(_send(), loop)
    except Exception as e:
        logger.error(f"âŒ on_audio_frame å›è°ƒå¤±è´¥: {e}", exc_info=True)
```

**å…³é”®æ”¹è¿›**ï¼š
1. ä½¿ç”¨ `run_coroutine_threadsafe` æ›¿ä»£ `create_task`
2. æ·»åŠ å¼‚å¸¸å¤„ç†
3. æ·»åŠ æ—¥å¿—è¿½è¸ª

### ä¿®å¤2: ä¼˜åŒ– `_on_audio_received` æ—¥å¿—

**æ–‡ä»¶**: `backend/services/voice_chat/voice_session_manager.py` (947-981è¡Œ)

**ä¿®æ”¹**ï¼š
```python
def _on_audio_received(self, audio_data: AudioData):
    """
    å½“æ”¶åˆ°éŸ³é¢‘æ¶ˆæ¯æ—¶çš„å›è°ƒï¼ˆè§£æå™¨è§¦å‘ï¼‰
    ğŸš€ åœ¨è¿™é‡Œç«‹å³è§£ç å¹¶æ¨é€éŸ³é¢‘å¸§ç»™å‰ç«¯ï¼ˆæ¨¡ä»¿py-xiaozhiï¼‰
    """
    if self.on_audio_frame_received:
        try:
            import opuslib
            if not hasattr(self, '_streaming_opus_decoder'):
                self._streaming_opus_decoder = opuslib.Decoder(24000, 1)
                logger.info("âœ… æµå¼OPUSè§£ç å™¨å·²åˆå§‹åŒ–")
                self._audio_frame_count = 0

            # è§£ç OPUSä¸ºPCM
            pcm_data = self._streaming_opus_decoder.decode(
                audio_data.data,
                frame_size=960,
                decode_fec=False
            )

            # è°ƒç”¨å›è°ƒæ¨é€ç»™å‰ç«¯
            self.on_audio_frame_received(pcm_data)

            # æ¯10å¸§è¾“å‡ºä¸€æ¬¡æ—¥å¿—
            self._audio_frame_count += 1
            if self._audio_frame_count % 10 == 0:
                logger.info(f"ğŸµ å·²æ¨é€ {self._audio_frame_count} å¸§éŸ³é¢‘")
        except Exception as e:
            logger.error(f"âŒ éŸ³é¢‘å¸§æ¨é€å›è°ƒå¤±è´¥: {e}", exc_info=True)
    else:
        logger.warning("âš ï¸ on_audio_frame_received å›è°ƒæœªè®¾ç½®ï¼ŒéŸ³é¢‘å¸§æœªæ¨é€")
```

**å…³é”®æ”¹è¿›**ï¼š
1. æ·»åŠ å¸§è®¡æ•°å™¨
2. æ¯10å¸§è¾“å‡ºä¸€æ¬¡æ—¥å¿—ï¼ˆé¿å…æ—¥å¿—è¿‡å¤šï¼‰
3. æ¸…æ™°çš„å¼‚å¸¸å¤„ç†

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æ­¥éª¤1: é‡å¯åç«¯

```bash
cd /Users/good/Desktop/PocketSpeak/backend
# Ctrl+C åœæ­¢
python -m uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

### æ­¥éª¤2: æµ‹è¯•

1. å¯åŠ¨å‰ç«¯
2. è¯´ä¸€å¥è¯
3. è§‚å¯Ÿæ—¥å¿—

### æ­¥éª¤3: æ£€æŸ¥å…³é”®æ—¥å¿—

**åç«¯åº”è¯¥æ˜¾ç¤º**ï¼š
```
âœ… æµå¼OPUSè§£ç å™¨å·²åˆå§‹åŒ–
ğŸµ å·²æ¨é€ 10 å¸§éŸ³é¢‘
ğŸµ å·²æ¨é€ 20 å¸§éŸ³é¢‘
...
```

**å¦‚æœæ¨é€å¤±è´¥**ï¼š
```
âŒ WebSocketå‘é€éŸ³é¢‘å¸§å¤±è´¥: xxx
âŒ on_audio_frame å›è°ƒå¤±è´¥: xxx
```

**å‰ç«¯åº”è¯¥æ˜¾ç¤º**ï¼š
```
flutter: ğŸµ å¯åŠ¨è¿ç»­æ’­æ”¾å¾ªç¯
// åº”è¯¥æŒç»­æ’­æ”¾ï¼Œä¸ä¼šç«‹å³ç»“æŸ
flutter: âœ… è¿ç»­æ’­æ”¾å¾ªç¯ç»“æŸ  // â† åœ¨æ‰€æœ‰éŸ³é¢‘æ’­æ”¾å®Œåæ‰ç»“æŸ
```

---

## ğŸ¯ py-xiaozhi vs PocketSpeak æ¶æ„å¯¹æ¯”

### py-xiaozhiï¼ˆç¡¬ä»¶é©±åŠ¨æ¨¡å¼ï¼‰

```
sounddevice.OutputStream
  â†“
stream callback (æ¯40msè‡ªåŠ¨è§¦å‘)
  â†“
ä» asyncio.Queue è·å–éŸ³é¢‘å¸§
  â†“
å†™å…¥ç¡¬ä»¶ç¼“å†²åŒº
  â†“
ç¡¬ä»¶è‡ªåŠ¨æ’­æ”¾ï¼ˆæ— ç¼è¿ç»­ï¼‰
```

**ç‰¹ç‚¹**ï¼š
- ç¡¬ä»¶é©±åŠ¨ï¼Œè‡ªåŠ¨è¿ç»­
- æ— éœ€æ‰‹åŠ¨å¾ªç¯
- å»¶è¿Ÿæä½ï¼ˆ~40msï¼‰

### PocketSpeakï¼ˆæ–‡ä»¶æ’­æ”¾æ¨¡å¼ï¼‰

```
WebSocket æ”¶åˆ°éŸ³é¢‘å¸§
  â†“
ç´¯ç§¯åˆ°é˜Ÿåˆ—
  â†“
æ’­æ”¾å¾ªç¯ï¼š
  - å–3å¸§ï¼ˆ~120msï¼‰
  - å†™WAVæ–‡ä»¶
  - è®¾ç½®æ’­æ”¾è·¯å¾„
  - await æ’­æ”¾å®Œæˆ
  - ç»§ç»­ä¸‹ä¸€æ‰¹
  â†“
æ¯æ‰¹ä¹‹é—´æœ‰é—´éš™ï¼ˆæ–‡ä»¶IO + æ’­æ”¾å™¨åˆ‡æ¢ï¼‰
```

**ç‰¹ç‚¹**ï¼š
- æ–‡ä»¶æ’­æ”¾ï¼Œéœ€è¦æ‰‹åŠ¨å¾ªç¯
- æ¯æ‰¹ä¹‹é—´æœ‰åˆ‡æ¢å»¶è¿Ÿ
- æ€»å»¶è¿Ÿè¾ƒé«˜ï¼ˆå–å†³äºæ‰¹æ¬¡å¤§å°å’ŒIOé€Ÿåº¦ï¼‰

### å…³é”®å·®å¼‚

| ç‰¹æ€§ | py-xiaozhi | PocketSpeak |
|------|-----------|-------------|
| æ’­æ”¾æ–¹å¼ | ç¡¬ä»¶æµå¼ | æ–‡ä»¶æ’­æ”¾ |
| æ˜¯å¦éœ€è¦å¾ªç¯ | å¦ï¼ˆè‡ªåŠ¨ï¼‰ | æ˜¯ï¼ˆæ‰‹åŠ¨ï¼‰ |
| å»¶è¿Ÿ | 40ms | 120ms+ |
| è¿ç»­æ€§ | å®Œç¾æ— ç¼ | æœ‰é—´éš™ |
| å¹³å° | æ¡Œé¢ | ç§»åŠ¨ç«¯ |

---

## ğŸš¨ å¦‚æœä»ç„¶å¡é¡¿çš„å¯èƒ½åŸå› 

### 1. å‰ç«¯ä»æœªæ”¶åˆ°éŸ³é¢‘

**æ£€æŸ¥**ï¼š
- åç«¯æ˜¯å¦æœ‰ "âŒ WebSocketå‘é€éŸ³é¢‘å¸§å¤±è´¥" é”™è¯¯
- å‰ç«¯æ˜¯å¦æœ‰éŸ³é¢‘å¸§æ¥æ”¶æ—¥å¿—

**æ’æŸ¥**ï¼š
```bash
# åç«¯æ—¥å¿—æœç´¢
grep "WebSocketå‘é€éŸ³é¢‘å¸§å¤±è´¥" backend.log
grep "å·²æ¨é€.*å¸§éŸ³é¢‘" backend.log

# å‰ç«¯æ—¥å¿—æœç´¢
# æŸ¥çœ‹æ˜¯å¦æœ‰ addAudioFrame è°ƒç”¨
```

### 2. å‰ç«¯æ’­æ”¾é€»è¾‘æœ‰é—®é¢˜

**å¯èƒ½åŸå› **ï¼š
- æ‰¹æ¬¡å¤§å°ä¸åˆé€‚ï¼ˆå¤ªå¤§å¯¼è‡´å»¶è¿Ÿï¼Œå¤ªå°å¯¼è‡´åˆ‡æ¢é¢‘ç¹ï¼‰
- WAVæ–‡ä»¶å†™å…¥å¤ªæ…¢
- just_audio æ’­æ”¾å™¨åˆ‡æ¢æœ‰å»¶è¿Ÿ

**ä¼˜åŒ–æ–¹å‘**ï¼š
- å‡å°æ‰¹æ¬¡å¤§å°ï¼ˆ1å¸§ = 40msï¼‰
- ä½¿ç”¨å†…å­˜ç¼“å†²è€Œéæ–‡ä»¶
- é¢„åŠ è½½ä¸‹ä¸€æ‰¹

### 3. ç½‘ç»œå»¶è¿Ÿ

**æ£€æŸ¥**ï¼š
- WebSocketå»¶è¿Ÿ
- éŸ³é¢‘å¸§åˆ°è¾¾é¢‘ç‡

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

### æˆåŠŸæ ‡å¿—

**åç«¯æ—¥å¿—**ï¼š
```
âœ… æµå¼OPUSè§£ç å™¨å·²åˆå§‹åŒ–
ğŸµ å·²æ¨é€ 10 å¸§éŸ³é¢‘
ğŸµ å·²æ¨é€ 20 å¸§éŸ³é¢‘
ğŸµ å·²æ¨é€ 30 å¸§éŸ³é¢‘
...
ğŸµ å·²æ¨é€ 130 å¸§éŸ³é¢‘  // çº¦130å¸§ = 5.2ç§’éŸ³é¢‘
```

**å‰ç«¯æ—¥å¿—**ï¼š
```
flutter: ğŸµ å¯åŠ¨è¿ç»­æ’­æ”¾å¾ªç¯
// æŒç»­æ’­æ”¾çº¦5ç§’...
flutter: âœ… è¿ç»­æ’­æ”¾å¾ªç¯ç»“æŸ
```

**ç”¨æˆ·ä½“éªŒ**ï¼š
- éŸ³é¢‘æ’­æ”¾æµç•…
- é—´éš™æ„ŸçŸ¥ä¸æ˜æ˜¾ï¼ˆ<100msï¼‰
- æ•´ä½“å¯æ¥å—

### å¦‚æœä»æœ‰å¡é¡¿

éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–å‰ç«¯æ’­æ”¾é€»è¾‘ï¼š
1. è°ƒæ•´æ‰¹æ¬¡å¤§å°
2. ä¼˜åŒ–æ–‡ä»¶IO
3. è€ƒè™‘ä½¿ç”¨æµå¼æ’­æ”¾æ’ä»¶

---

**ä¿®å¤æ—¶é—´**: 2025-01-12
**æµ‹è¯•çŠ¶æ€**: ç­‰å¾…ç”¨æˆ·æµ‹è¯•
**é¢„æœŸ**: å‰ç«¯èƒ½æ”¶åˆ°éŸ³é¢‘å¸§ï¼Œä½†å¯èƒ½ä»æœ‰è½»å¾®å¡é¡¿ï¼ˆå—é™äºæ–‡ä»¶æ’­æ”¾æ¨¡å¼ï¼‰
