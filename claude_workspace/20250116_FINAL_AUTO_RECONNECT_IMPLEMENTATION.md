# WebSocket è‡ªåŠ¨é‡è¿æœºåˆ¶å®Œæ•´å®ç°

**ä»»åŠ¡æ—¥æœŸ**: 2025-01-16
**ä»»åŠ¡ç±»å‹**: ğŸ”¥ Critical Bug Fix - 1åˆ†é’Ÿç©ºé—²æ–­çº¿é—®é¢˜
**ä»»åŠ¡çŠ¶æ€**: âœ… å·²å®Œæˆï¼ˆå¾…æµ‹è¯•ï¼‰

---

## ä¸€ã€é—®é¢˜å›é¡¾

### 1.1 ç”¨æˆ·åé¦ˆçš„ä¸¥é‡é—®é¢˜

**åŸå§‹é—®é¢˜** (2025-01-15):
> "é—´éš”ä¸€æ®µæ—¶é—´ä¸è·ŸAIå‘é€æ¶ˆæ¯ï¼Œé“¾æ¥å°±ä¼šæ–­å¼€"

**ç¬¬ä¸€æ¬¡ä¿®å¤å** (2025-01-16 ä¸Šåˆ):
- âœ… çŸ­æ—¶é—´ç©ºé—²ï¼ˆ1-2åˆ†é’Ÿï¼‰ï¼šé‡è¿æˆåŠŸ
- âŒ é•¿æ—¶é—´ç©ºé—²ï¼ˆ10åˆ†é’Ÿä»¥ä¸Šï¼‰ï¼šä»ç„¶æ–­å¼€

**ç¬¬äºŒæ¬¡ä¿®å¤å** (2025-01-16 ä¸­åˆ):
- ä½¿ç”¨ `close_code` æ›¿ä»£ `closed` æ£€æµ‹è¿æ¥çŠ¶æ€
- æ·»åŠ  `_handle_connection_loss()` æ–¹æ³•

**æœ€æ–°é—®é¢˜** (2025-01-16 ä¸‹åˆ) - ğŸ”¥ CRITICAL:
> "æœ€æ–°ç‰ˆæœ¬çš„çŸ­çº¿é‡è¿è¿˜æ˜¯æœ‰é—®é¢˜ï¼ç°åœ¨ä¸ç”¨ç­‰10åˆ†é’Ÿï¼Œç­‰1åˆ†é’Ÿä¸å‘ä¿¡æ¯ä»–å°±æ–­å¼€äº†ï¼æˆ‘è§‰å¾—ä¸€æ–¹é¢è¦æœ‰å¿ƒè·³æœºåˆ¶ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿè¦æœ‰é‡æ–°é“¾æ¥çš„æœºåˆ¶ï¼Œä½ è¿˜æ˜¯æ²¡æœ‰å®Œå…¨æŒæ¡py-xiaozhiçš„é‡è¿æœºåˆ¶ï¼ï¼ï¼"

### 1.2 æ ¹æœ¬åŸå› åˆ†æ

**é—®é¢˜æœ¬è´¨**ï¼šåªå®ç°äº†è¿æ¥**æ£€æµ‹**æœºåˆ¶ï¼Œæœªå®ç°å®Œæ•´çš„**é‡è¿**æœºåˆ¶

| åŠŸèƒ½ç»„ä»¶ | æˆ‘çš„å®ç° | py-xiaozhiå®ç° | çŠ¶æ€ |
|---------|---------|---------------|-----|
| å¿ƒè·³æ£€æµ‹ | âœ… ping/pong (20s) | âœ… ping/pong (20s) | âœ… å·²å®ç° |
| è¿æ¥ç›‘æ§ | âœ… close_codeæ£€æŸ¥ (5s) | âœ… close_codeæ£€æŸ¥ (5s) | âœ… å·²å®ç° |
| è‡ªåŠ¨é‡è¿å¼€å…³ | âŒ ç¼ºå¤± | âœ… `_auto_reconnect_enabled` | âŒ **ç¼ºå¤±** |
| é‡è¿æ¬¡æ•°é™åˆ¶ | âŒ ç¼ºå¤± | âœ… `_max_reconnect_attempts` | âŒ **ç¼ºå¤±** |
| è¿æ¥æ¸…ç†æœºåˆ¶ | âŒ ç¼ºå¤± | âœ… `_cleanup_connection()` | âŒ **ç¼ºå¤±** |
| ä¸»åŠ¨å…³é—­æ ‡å¿— | âŒ ç¼ºå¤± | âœ… `_is_closing` | âŒ **ç¼ºå¤±** |
| å®Œæ•´å¼‚å¸¸æ•è· | âš ï¸ ä¸å®Œæ•´ | âœ… 5ç§å¼‚å¸¸ç±»å‹ | âš ï¸ **ä¸å®Œæ•´** |

**å…³é”®ç¼ºå¤±**:
```python
# py-xiaozhi æœ‰è¿™äº›ï¼Œä½†æˆ‘çš„ä»£ç æ²¡æœ‰ï¼š
self._auto_reconnect_enabled = False  # ğŸ”¥ è‡ªåŠ¨é‡è¿å¼€å…³ï¼ˆå¿…é¡»æ˜¾å¼å¯ç”¨ï¼‰
self._max_reconnect_attempts = 0      # ğŸ”¥ æœ€å¤§é‡è¿æ¬¡æ•°
self._is_closing = False              # ğŸ”¥ ä¸»åŠ¨å…³é—­æ ‡å¿—

def enable_auto_reconnect(enabled=True, max_attempts=5):  # ğŸ”¥ å¯ç”¨é‡è¿çš„æ–¹æ³•
    self._auto_reconnect_enabled = enabled
    self._max_reconnect_attempts = max_attempts

async def _cleanup_connection():  # ğŸ”¥ æ¸…ç†æ—§è¿æ¥çš„æ–¹æ³•
    # å–æ¶ˆæ‰€æœ‰ä»»åŠ¡
    # å…³é—­WebSocket
    # é‡ç½®çŠ¶æ€
```

---

## äºŒã€å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

### 2.1 ä¿®å¤ç­–ç•¥

**å‚ç…§æ ‡å‡†**: `libs/py_xiaozhi/src/protocols/websocket_protocol.py`

**å®æ–½æ­¥éª¤**:
1. âœ… æ·»åŠ  `_auto_reconnect_enabled`, `_max_reconnect_attempts`, `_is_closing` å±æ€§
2. âœ… å®ç° `enable_auto_reconnect()` æ–¹æ³•
3. âœ… å®ç° `_cleanup_connection()` æ–¹æ³•
4. âœ… ä¿®æ”¹ `_handle_connection_loss()` è°ƒç”¨ cleanup å¹¶æ£€æŸ¥å¼€å…³
5. âœ… å¢å¼º `_handle_messages()` æ•è·æ‰€æœ‰WebSocketå¼‚å¸¸ç±»å‹
6. âœ… åœ¨ `voice_session_manager` åˆå§‹åŒ–æ—¶å¯ç”¨è‡ªåŠ¨é‡è¿

---

## ä¸‰ã€ä»£ç ä¿®æ”¹è¯¦æƒ…

### 3.1 æ·»åŠ è‡ªåŠ¨é‡è¿å±æ€§ (`ws_client.py` ç¬¬88-93è¡Œ)

```python
# é‡è¿æ§åˆ¶
self.reconnect_attempts = 0
self.should_reconnect = True
self._is_closing = False  # æ˜¯å¦æ­£åœ¨ä¸»åŠ¨å…³é—­ï¼ˆå‚ç…§py-xiaozhiï¼‰
self._auto_reconnect_enabled = False  # è‡ªåŠ¨é‡è¿å¼€å…³ï¼ˆå‚ç…§py-xiaozhiï¼‰
self._max_reconnect_attempts = 0  # æœ€å¤§é‡è¿æ¬¡æ•°ï¼ˆå‚ç…§py-xiaozhiï¼‰
```

**å…³é”®ç‚¹**:
- `_is_closing`: é¿å…åœ¨ä¸»åŠ¨å…³é—­æ—¶è§¦å‘é‡è¿
- `_auto_reconnect_enabled`: é»˜è®¤å…³é—­ï¼Œå¿…é¡»æ˜¾å¼å¯ç”¨
- `_max_reconnect_attempts`: ç‹¬ç«‹äº `config.max_reconnect_attempts`

### 3.2 å®ç° `enable_auto_reconnect()` æ–¹æ³• (`ws_client.py` ç¬¬226-240è¡Œ)

```python
def enable_auto_reconnect(self, enabled: bool = True, max_attempts: int = 5):
    """
    å¯ç”¨æˆ–ç¦ç”¨è‡ªåŠ¨é‡è¿åŠŸèƒ½ï¼ˆå‚ç…§py-xiaozhiï¼‰

    Args:
        enabled: æ˜¯å¦å¯ç”¨è‡ªåŠ¨é‡è¿
        max_attempts: æœ€å¤§é‡è¿æ¬¡æ•°ï¼ˆä»…å½“enabled=Trueæ—¶æœ‰æ•ˆï¼‰
    """
    self._auto_reconnect_enabled = enabled
    if enabled:
        self._max_reconnect_attempts = max_attempts
        logger.info(f"âœ… å¯ç”¨è‡ªåŠ¨é‡è¿ï¼Œæœ€å¤§å°è¯•æ¬¡æ•°: {max_attempts}")
    else:
        self._max_reconnect_attempts = 0
        logger.info("âŒ ç¦ç”¨è‡ªåŠ¨é‡è¿")
```

**ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªæ–¹æ³•**:
- py-xiaozhi ä¸ä¼šè‡ªåŠ¨å¼€å¯é‡è¿ï¼Œå¿…é¡»åº”ç”¨å±‚è°ƒç”¨æ­¤æ–¹æ³•
- æä¾›çµæ´»çš„æ§åˆ¶ï¼šå¯ä»¥åŠ¨æ€å¼€å¯/å…³é—­

### 3.3 ä¿®æ”¹ `disconnect()` æ–¹æ³• (`ws_client.py` ç¬¬242-248è¡Œ)

```python
async def disconnect(self):
    """æ–­å¼€WebSocketè¿æ¥"""
    logger.info("å¼€å§‹æ–­å¼€WebSocketè¿æ¥")

    self.should_reconnect = False
    self._is_closing = True  # æ ‡è®°ä¸ºä¸»åŠ¨å…³é—­ï¼ˆå‚ç…§py-xiaozhiï¼‰
    self.state = ConnectionState.DISCONNECTED
```

**ä½œç”¨**:
- è®¾ç½® `_is_closing = True`ï¼Œé˜²æ­¢ä¸»åŠ¨æ–­å¼€æ—¶è§¦å‘è‡ªåŠ¨é‡è¿

### 3.4 å®ç° `_cleanup_connection()` æ–¹æ³• (`ws_client.py` ç¬¬702-746è¡Œ)

```python
async def _cleanup_connection(self):
    """
    æ¸…ç†è¿æ¥èµ„æºï¼ˆå‚ç…§py-xiaozhiå®ç°ï¼‰

    åœ¨é‡è¿ä¹‹å‰å¿…é¡»å½»åº•æ¸…ç†æ—§çš„è¿æ¥å’Œä»»åŠ¡ï¼Œé¿å…èµ„æºæ³„æ¼
    """
    logger.debug("ğŸ§¹ å¼€å§‹æ¸…ç†è¿æ¥èµ„æº")

    # å–æ¶ˆæ‰€æœ‰åå°ä»»åŠ¡
    tasks_to_cancel = []
    if self.connection_task and not self.connection_task.done():
        tasks_to_cancel.append(("connection_task", self.connection_task))
    if self.heartbeat_task and not self.heartbeat_task.done():
        tasks_to_cancel.append(("heartbeat_task", self.heartbeat_task))
    if self.monitor_task and not self.monitor_task.done():
        tasks_to_cancel.append(("monitor_task", self.monitor_task))

    # å–æ¶ˆä»»åŠ¡
    for task_name, task in tasks_to_cancel:
        try:
            task.cancel()
            await asyncio.wait_for(task, timeout=1.0)
        except (asyncio.CancelledError, asyncio.TimeoutError):
            logger.debug(f"âœ… å·²å–æ¶ˆ {task_name}")
        except Exception as e:
            logger.warning(f"å–æ¶ˆ {task_name} å¤±è´¥: {e}")

    # å…³é—­WebSocketè¿æ¥
    if self.websocket:
        try:
            await asyncio.wait_for(self.websocket.close(), timeout=2.0)
            logger.debug("âœ… WebSocketè¿æ¥å·²å…³é—­")
        except asyncio.TimeoutError:
            logger.warning("WebSocketå…³é—­è¶…æ—¶")
        except Exception as e:
            logger.warning(f"å…³é—­WebSocketå¤±è´¥: {e}")
        finally:
            self.websocket = None

    # é‡ç½®ä»»åŠ¡å¼•ç”¨
    self.connection_task = None
    self.heartbeat_task = None
    self.monitor_task = None

    logger.debug("âœ… è¿æ¥èµ„æºæ¸…ç†å®Œæˆ")
```

**å…³é”®ç‚¹**:
- å–æ¶ˆæ‰€æœ‰åå°ä»»åŠ¡ï¼ˆconnection_task, heartbeat_task, monitor_taskï¼‰
- å…³é—­WebSocketè¿æ¥ï¼ˆå¸¦è¶…æ—¶ä¿æŠ¤ï¼‰
- é‡ç½®ä»»åŠ¡å¼•ç”¨ï¼Œé¿å…å†…å­˜æ³„æ¼

### 3.5 ä¿®æ”¹ `_handle_connection_loss()` æ–¹æ³• (`ws_client.py` ç¬¬748-794è¡Œ)

```python
async def _handle_connection_loss(self, reason: str):
    """
    å¤„ç†è¿æ¥ä¸¢å¤±ï¼ˆå‚ç…§py-xiaozhiå®ç°ï¼‰

    è¿™ä¸ªæ–¹æ³•ä¼šï¼š
    1. æ£€æŸ¥æ˜¯å¦æ­£åœ¨ä¸»åŠ¨å…³é—­ï¼ˆé¿å…ä¸å¿…è¦çš„é‡è¿ï¼‰
    2. æ¸…ç†è¿æ¥èµ„æº
    3. æ›´æ–°è¿æ¥çŠ¶æ€
    4. è§¦å‘æ–­å¼€å›è°ƒ
    5. å¦‚æœå¯ç”¨è‡ªåŠ¨é‡è¿ï¼Œè§¦å‘é‡è¿
    """
    logger.warning(f"ğŸ”— å¤„ç†è¿æ¥ä¸¢å¤±: {reason}")

    # ğŸ”¥ æ£€æŸ¥æ˜¯å¦æ­£åœ¨ä¸»åŠ¨å…³é—­ï¼ˆå‚ç…§py-xiaozhiï¼‰
    if self._is_closing:
        logger.info("æ­£åœ¨ä¸»åŠ¨å…³é—­è¿æ¥ï¼Œè·³è¿‡é‡è¿é€»è¾‘")
        return

    # ğŸ”¥ æ¸…ç†è¿æ¥èµ„æºï¼ˆå‚ç…§py-xiaozhiï¼‰
    await self._cleanup_connection()

    # æ›´æ–°è¿æ¥çŠ¶æ€
    was_connected = self.state in [ConnectionState.CONNECTED, ConnectionState.AUTHENTICATED]
    self.state = ConnectionState.DISCONNECTED

    # é€šçŸ¥è¿æ¥çŠ¶æ€å˜åŒ–
    if self.on_disconnected and was_connected:
        try:
            self.on_disconnected(reason)
        except Exception as e:
            logger.error(f"è°ƒç”¨è¿æ¥æ–­å¼€å›è°ƒå¤±è´¥: {e}")

    # ğŸ”¥ æ£€æŸ¥è‡ªåŠ¨é‡è¿å¼€å…³ï¼ˆå‚ç…§py-xiaozhiï¼‰
    if self._auto_reconnect_enabled and self.should_reconnect:
        # æ£€æŸ¥é‡è¿æ¬¡æ•°é™åˆ¶
        if self._max_reconnect_attempts > 0 and self.reconnect_attempts >= self._max_reconnect_attempts:
            logger.error(f"å·²è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•° ({self._max_reconnect_attempts})ï¼Œåœæ­¢é‡è¿")
            if self.on_error:
                self.on_error(f"è¿æ¥ä¸¢å¤±ä¸”å·²è¾¾æœ€å¤§é‡è¿æ¬¡æ•°: {reason}")
        else:
            # è§¦å‘é‡è¿
            await self._schedule_reconnect()
    else:
        # æœªå¯ç”¨è‡ªåŠ¨é‡è¿æˆ–should_reconnectä¸ºFalse
        logger.info("è‡ªåŠ¨é‡è¿æœªå¯ç”¨æˆ–å·²ç¦æ­¢é‡è¿")
        if self.on_error:
            self.on_error(f"è¿æ¥ä¸¢å¤±: {reason}")
```

**ä¿®æ”¹ç‚¹**:
1. ğŸ”¥ æ·»åŠ  `_is_closing` æ£€æŸ¥ï¼ˆé¿å…ä¸»åŠ¨å…³é—­æ—¶é‡è¿ï¼‰
2. ğŸ”¥ è°ƒç”¨ `_cleanup_connection()`ï¼ˆæ¸…ç†æ—§è¿æ¥ï¼‰
3. ğŸ”¥ æ£€æŸ¥ `_auto_reconnect_enabled`ï¼ˆå¿…é¡»å¯ç”¨æ‰é‡è¿ï¼‰
4. ğŸ”¥ æ£€æŸ¥ `_max_reconnect_attempts`ï¼ˆé™åˆ¶é‡è¿æ¬¡æ•°ï¼‰

### 3.6 å¢å¼º `_handle_messages()` å¼‚å¸¸æ•è· (`ws_client.py` ç¬¬567-600è¡Œ)

```python
except websockets.exceptions.ConnectionClosed as e:
    # WebSocketæ­£å¸¸å…³é—­ï¼ˆå‚ç…§py-xiaozhiï¼‰
    close_code = getattr(e, 'code', 'unknown')
    close_reason = getattr(e, 'reason', 'unknown')
    logger.warning(f"WebSocketè¿æ¥å·²å…³é—­ (code={close_code}, reason={close_reason})")
    await self._handle_connection_loss(f"è¿æ¥å…³é—­: {close_code} {close_reason}")

except websockets.exceptions.ConnectionClosedError as e:
    # WebSocketå¼‚å¸¸å…³é—­ï¼ˆå‚ç…§py-xiaozhiï¼‰
    close_code = getattr(e, 'code', 'unknown')
    close_reason = getattr(e, 'reason', 'unknown')
    logger.error(f"WebSocketè¿æ¥é”™è¯¯: code={close_code}, reason={close_reason}")
    await self._handle_connection_loss(f"è¿æ¥é”™è¯¯: {close_code} {close_reason}")

except websockets.exceptions.InvalidState as e:
    # WebSocketçŠ¶æ€å¼‚å¸¸ï¼ˆå‚ç…§py-xiaozhiï¼‰
    logger.error(f"WebSocketçŠ¶æ€å¼‚å¸¸: {e}")
    await self._handle_connection_loss("è¿æ¥çŠ¶æ€å¼‚å¸¸")

except ConnectionResetError:
    # è¿æ¥è¢«é‡ç½®ï¼ˆå‚ç…§py-xiaozhiï¼‰
    logger.error("è¿æ¥è¢«é‡ç½® (ConnectionResetError)")
    await self._handle_connection_loss("è¿æ¥è¢«é‡ç½®")

except OSError as e:
    # ç½‘ç»œI/Oé”™è¯¯ï¼ˆå‚ç…§py-xiaozhiï¼‰
    logger.error(f"ç½‘ç»œI/Oé”™è¯¯: {e}")
    await self._handle_connection_loss(f"ç½‘ç»œI/Oé”™è¯¯: {e}")

except Exception as e:
    # å…¶ä»–æœªé¢„æœŸçš„å¼‚å¸¸
    error_msg = f"æ¶ˆæ¯å¤„ç†å¾ªç¯å¼‚å¸¸: {e}"
    logger.error(error_msg, exc_info=True)
    await self._handle_connection_loss(f"æœªçŸ¥å¼‚å¸¸: {e}")
```

**æ”¹è¿›ç‚¹**:
- âœ… æ•è· `ConnectionClosed`ï¼ˆæ­£å¸¸å…³é—­ï¼‰
- âœ… æ•è· `ConnectionClosedError`ï¼ˆå¼‚å¸¸å…³é—­ï¼‰
- âœ… æ•è· `InvalidState`ï¼ˆçŠ¶æ€å¼‚å¸¸ï¼‰
- âœ… æ•è· `ConnectionResetError`ï¼ˆè¿æ¥é‡ç½®ï¼‰
- âœ… æ•è· `OSError`ï¼ˆç½‘ç»œI/Oé”™è¯¯ï¼‰
- âœ… æ‰€æœ‰å¼‚å¸¸ç»Ÿä¸€è°ƒç”¨ `_handle_connection_loss()`

**æ—§ä»£ç é—®é¢˜**:
```python
# æ—§ç‰ˆæœ¬åªæœ‰è¿™äº›ï¼š
except websockets.exceptions.ConnectionClosed as e:
    # ... ç›´æ¥è°ƒç”¨ _schedule_reconnect()ï¼Œæ²¡æœ‰æ¸…ç†
except Exception as e:
    # ... ç›´æ¥è®¾ç½®é”™è¯¯çŠ¶æ€ï¼Œæ²¡æœ‰é‡è¿
```

### 3.7 åœ¨ `voice_session_manager` ä¸­å¯ç”¨è‡ªåŠ¨é‡è¿ (`voice_session_manager.py` ç¬¬462-464è¡Œ)

```python
# 6. è®¾ç½®å›è°ƒå‡½æ•°
self._setup_callbacks()

# 6.5 å¯ç”¨WebSocketè‡ªåŠ¨é‡è¿ï¼ˆå‚ç…§py-xiaozhiï¼‰
self.ws_client.enable_auto_reconnect(enabled=True, max_attempts=5)
logger.info("âœ… WebSocketè‡ªåŠ¨é‡è¿å·²å¯ç”¨ (max_attempts=5)")

# 7. å»ºç«‹WebSocketè¿æ¥
logger.info("å»ºç«‹WebSocketè¿æ¥...")
if not await self.ws_client.connect():
```

**å…³é”®ç‚¹**:
- ğŸ”¥ **å¿…é¡»åœ¨ `connect()` ä¹‹å‰è°ƒç”¨** `enable_auto_reconnect()`
- ğŸ”¥ è®¾ç½® `max_attempts=5`ï¼ˆæœ€å¤šé‡è¿5æ¬¡ï¼‰
- è¿™æ˜¯æ¿€æ´»æ•´ä¸ªè‡ªåŠ¨é‡è¿æœºåˆ¶çš„**å…³é”®æ­¥éª¤**

---

## å››ã€ä¿®å¤å‰åå¯¹æ¯”

### 4.1 æ•°æ®æµå¯¹æ¯”

#### ä¿®å¤å‰ï¼ˆæœ‰æ£€æµ‹ï¼Œæ— é‡è¿ï¼‰

```
åº”ç”¨å¯åŠ¨
  â†“
WebSocketè¿æ¥æˆåŠŸ
  â†“
å¿ƒè·³ä»»åŠ¡è¿è¡Œï¼ˆping/pong æ¯20ç§’ï¼‰âœ…
è¿æ¥ç›‘æ§ä»»åŠ¡è¿è¡Œï¼ˆæ£€æŸ¥close_code æ¯5ç§’ï¼‰âœ…
  â†“
[ç”¨æˆ·ç©ºé—²1åˆ†é’Ÿ]
  â†“
æœåŠ¡å™¨è¶…æ—¶å…³é—­è¿æ¥ï¼ˆclose_code=1006ï¼‰
  â†“
è¿æ¥ç›‘æ§æ£€æµ‹åˆ° close_code != None âœ…
  â†“
è°ƒç”¨ _handle_connection_loss() âœ…
  â†“
æ£€æŸ¥ _auto_reconnect_enabled... âŒ False (æœªå¯ç”¨!)
  â†“
âŒ åœæ­¢é‡è¿ï¼Œè§¦å‘é”™è¯¯å›è°ƒ
  â†“
è¿æ¥æ–­å¼€ï¼Œåº”ç”¨æ— æ³•ä½¿ç”¨
```

#### ä¿®å¤åï¼ˆå®Œæ•´çš„æ£€æµ‹+é‡è¿ï¼‰

```
åº”ç”¨å¯åŠ¨
  â†“
è°ƒç”¨ enable_auto_reconnect(enabled=True, max_attempts=5) âœ…
  â†“
WebSocketè¿æ¥æˆåŠŸ
  â†“
å¿ƒè·³ä»»åŠ¡è¿è¡Œï¼ˆping/pong æ¯20ç§’ï¼‰âœ…
è¿æ¥ç›‘æ§ä»»åŠ¡è¿è¡Œï¼ˆæ£€æŸ¥close_code æ¯5ç§’ï¼‰âœ…
  â†“
[ç”¨æˆ·ç©ºé—²1åˆ†é’Ÿ]
  â†“
æœåŠ¡å™¨è¶…æ—¶å…³é—­è¿æ¥ï¼ˆclose_code=1006ï¼‰
  â†“
è¿æ¥ç›‘æ§æ£€æµ‹åˆ° close_code != None âœ…
  â†“
è°ƒç”¨ _handle_connection_loss() âœ…
  â†“
æ£€æŸ¥ _is_closing... âœ… False (ä¸æ˜¯ä¸»åŠ¨å…³é—­)
  â†“
è°ƒç”¨ _cleanup_connection() âœ…
  â”œâ”€ å–æ¶ˆ connection_task âœ…
  â”œâ”€ å–æ¶ˆ monitor_task âœ…
  â””â”€ å…³é—­æ—§çš„ websocket âœ…
  â†“
æ£€æŸ¥ _auto_reconnect_enabled... âœ… True (å·²å¯ç”¨!)
  â†“
æ£€æŸ¥é‡è¿æ¬¡æ•° (0 < 5)... âœ… å…è®¸é‡è¿
  â†“
è°ƒç”¨ _schedule_reconnect() âœ…
  â”œâ”€ è®¡ç®—å»¶è¿Ÿ: 1ç§’ + éšæœºæŠ–åŠ¨
  â””â”€ ç­‰å¾…1ç§’...
  â†“
è°ƒç”¨ connect() âœ…
  â”œâ”€ å»ºç«‹æ–°çš„WebSocketè¿æ¥
  â”œâ”€ é‡æ–°è®¤è¯
  â””â”€ é‡æ–°å¯åŠ¨ç›‘æ§ä»»åŠ¡
  â†“
âœ… è¿æ¥æ¢å¤ï¼Œåº”ç”¨ç»§ç»­æ­£å¸¸å·¥ä½œ
```

### 4.2 å…³é”®å·®å¼‚æ€»ç»“

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|-----|--------|--------|
| **è‡ªåŠ¨é‡è¿å¼€å…³** | âŒ æœªå¯ç”¨ | âœ… å·²å¯ç”¨ |
| **è¿æ¥æ¸…ç†** | âŒ ç¼ºå¤± | âœ… å®Œæ•´æ¸…ç† |
| **ä¸»åŠ¨å…³é—­æ£€æŸ¥** | âŒ ç¼ºå¤± | âœ… é¿å…è¯¯é‡è¿ |
| **é‡è¿æ¬¡æ•°é™åˆ¶** | âš ï¸ ä»…configå±‚ | âœ… åŒå±‚é™åˆ¶ |
| **å¼‚å¸¸æ•è·** | âš ï¸ 2ç§ | âœ… 6ç§ |
| **1åˆ†é’Ÿç©ºé—²** | âŒ æ–­å¼€ | âœ… è‡ªåŠ¨é‡è¿ |

---

## äº”ã€æµ‹è¯•è®¡åˆ’

### 5.1 æµ‹è¯•åœºæ™¯

#### åœºæ™¯1: 1åˆ†é’Ÿç©ºé—²æµ‹è¯•ï¼ˆæ ¸å¿ƒåœºæ™¯ï¼‰

**æ­¥éª¤**:
1. å¯åŠ¨åº”ç”¨ï¼Œå®ŒæˆWebSocketè¿æ¥
2. å‘é€ä¸€æ¡æ¶ˆæ¯ï¼ŒéªŒè¯è¿æ¥æ­£å¸¸
3. ç­‰å¾…1åˆ†é’Ÿï¼Œä¸å‘é€ä»»ä½•æ¶ˆæ¯
4. è§‚å¯Ÿæ—¥å¿—ï¼Œç¡®è®¤è¿æ¥ç›‘æ§æ£€æµ‹åˆ°æ–­å¼€
5. ç­‰å¾…è‡ªåŠ¨é‡è¿å®Œæˆï¼ˆçº¦1-2ç§’ï¼‰
6. å†æ¬¡å‘é€æ¶ˆæ¯ï¼ŒéªŒè¯è¿æ¥æ¢å¤

**é¢„æœŸç»“æœ**:
```
[00:00] âœ… WebSocketè¿æ¥å»ºç«‹æˆåŠŸ
[00:05] ğŸ” è¿æ¥ç›‘æ§ï¼šè¿æ¥æ­£å¸¸ (close_code=None)
[00:10] ğŸ” è¿æ¥ç›‘æ§ï¼šè¿æ¥æ­£å¸¸ (close_code=None)
...
[01:00] ğŸ” è¿æ¥ç›‘æ§ï¼šæ£€æµ‹åˆ°WebSocketè¿æ¥å·²å…³é—­ (close_code=1006)
[01:00] ğŸ”— å¤„ç†è¿æ¥ä¸¢å¤±: è¿æ¥ç›‘æ§æ£€æµ‹åˆ°è¿æ¥å·²å…³é—­
[01:00] ğŸ§¹ å¼€å§‹æ¸…ç†è¿æ¥èµ„æº
[01:00] âœ… è¿æ¥èµ„æºæ¸…ç†å®Œæˆ
[01:00] ğŸ”„ å°†åœ¨ 1.0 ç§’åå°è¯•ç¬¬ 1 æ¬¡é‡è¿
[01:01] å¼€å§‹è¿æ¥åˆ°å°æ™ºAIæœåŠ¡å™¨: wss://api.tenclass.net/xiaozhi/v1/
[01:02] âœ… WebSocketè¿æ¥å»ºç«‹æˆåŠŸ (ping_interval=20s, ping_timeout=20s)
```

#### åœºæ™¯2: 10åˆ†é’Ÿç©ºé—²æµ‹è¯•ï¼ˆé•¿æ—¶é—´æµ‹è¯•ï¼‰

**æ­¥éª¤**:
1. å¯åŠ¨åº”ç”¨ï¼Œå®ŒæˆWebSocketè¿æ¥
2. ç­‰å¾…10åˆ†é’Ÿï¼Œä¸å‘é€ä»»ä½•æ¶ˆæ¯
3. è§‚å¯Ÿæ˜¯å¦è‡ªåŠ¨é‡è¿
4. å‘é€æ¶ˆæ¯ï¼ŒéªŒè¯è¿æ¥

**é¢„æœŸç»“æœ**:
- è¿æ¥åœ¨æœåŠ¡å™¨è¶…æ—¶åè‡ªåŠ¨é‡è¿
- ç”¨æˆ·å®Œå…¨æ— æ„ŸçŸ¥

#### åœºæ™¯3: ä¸»åŠ¨æ–­å¼€æµ‹è¯•ï¼ˆé¿å…è¯¯é‡è¿ï¼‰

**æ­¥éª¤**:
1. å¯åŠ¨åº”ç”¨ï¼Œå®ŒæˆWebSocketè¿æ¥
2. è°ƒç”¨ `disconnect()` ä¸»åŠ¨æ–­å¼€
3. è§‚å¯Ÿæ—¥å¿—ï¼Œç¡®è®¤ä¸è§¦å‘è‡ªåŠ¨é‡è¿

**é¢„æœŸç»“æœ**:
```
[00:00] å¼€å§‹æ–­å¼€WebSocketè¿æ¥
[00:00] æ­£åœ¨ä¸»åŠ¨å…³é—­è¿æ¥ï¼Œè·³è¿‡é‡è¿é€»è¾‘
[00:00] âœ… WebSocketè¿æ¥å·²æ–­å¼€
```

#### åœºæ™¯4: è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°æµ‹è¯•

**æ­¥éª¤**:
1. å¯åŠ¨åº”ç”¨ï¼Œå®ŒæˆWebSocketè¿æ¥
2. æ‰‹åŠ¨å…³é—­ç½‘ç»œï¼ˆæ¨¡æ‹Ÿç½‘ç»œä¸å¯ç”¨ï¼‰
3. è§‚å¯Ÿè‡ªåŠ¨é‡è¿å°è¯•5æ¬¡ååœæ­¢

**é¢„æœŸç»“æœ**:
```
[00:00] ğŸ”„ å°†åœ¨ 1.0 ç§’åå°è¯•ç¬¬ 1 æ¬¡é‡è¿
[00:01] âŒ WebSocketè¿æ¥å¤±è´¥
[00:01] ğŸ”„ å°†åœ¨ 2.0 ç§’åå°è¯•ç¬¬ 2 æ¬¡é‡è¿
[00:03] âŒ WebSocketè¿æ¥å¤±è´¥
...
[00:31] âŒ å·²è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•° (5)ï¼Œåœæ­¢é‡è¿
```

### 5.2 éªŒè¯æ£€æŸ¥æ¸…å•

- [ ] 1åˆ†é’Ÿç©ºé—²åè‡ªåŠ¨é‡è¿æˆåŠŸ
- [ ] 10åˆ†é’Ÿç©ºé—²åè‡ªåŠ¨é‡è¿æˆåŠŸ
- [ ] ä¸»åŠ¨æ–­å¼€ä¸è§¦å‘è‡ªåŠ¨é‡è¿
- [ ] è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°ååœæ­¢
- [ ] é‡è¿åemojiæ­£å¸¸æ’­æ”¾
- [ ] é‡è¿åéŸ³é¢‘æ­£å¸¸æ¨é€
- [ ] æ— å†…å­˜æ³„æ¼ï¼ˆæ—§ä»»åŠ¡å·²æ¸…ç†ï¼‰
- [ ] æ—¥å¿—æ¸…æ™°ï¼Œä¾¿äºè°ƒè¯•

---

## å…­ã€å®Œæ•´ä¿®æ”¹æ¸…å•

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ | è¡Œå· |
|---------|---------|------|
| `backend/services/voice_chat/ws_client.py` | æ·»åŠ  `_is_closing`, `_auto_reconnect_enabled`, `_max_reconnect_attempts` å±æ€§ | 91-93 |
| | å®ç° `enable_auto_reconnect()` æ–¹æ³• | 226-240 |
| | ä¿®æ”¹ `disconnect()` è®¾ç½® `_is_closing = True` | 247 |
| | å®ç° `_cleanup_connection()` æ–¹æ³• | 702-746 |
| | ä¿®æ”¹ `_handle_connection_loss()` æ·»åŠ æ¸…ç†å’Œå¼€å…³æ£€æŸ¥ | 748-794 |
| | å¢å¼º `_handle_messages()` æ•è·6ç§å¼‚å¸¸ç±»å‹ | 567-600 |
| `backend/services/voice_chat/voice_session_manager.py` | åœ¨åˆå§‹åŒ–æ—¶å¯ç”¨è‡ªåŠ¨é‡è¿ | 462-464 |

---

## ä¸ƒã€æŠ€æœ¯ç»†èŠ‚è¯´æ˜

### 7.1 ä¸ºä»€ä¹ˆéœ€è¦ `_auto_reconnect_enabled` å¼€å…³ï¼Ÿ

**é—®é¢˜**: ä¸ºä»€ä¹ˆä¸ç›´æ¥åœ¨ `_handle_connection_loss()` ä¸­è‡ªåŠ¨é‡è¿ï¼Ÿ

**ç­”æ¡ˆ**:
1. **çµæ´»æ€§**: åº”ç”¨å±‚å¯ä»¥æ ¹æ®åœºæ™¯å†³å®šæ˜¯å¦å¯ç”¨é‡è¿
2. **ç”Ÿå‘½å‘¨æœŸæ§åˆ¶**: åº”ç”¨å…³é—­æ—¶å¯ä»¥ç¦ç”¨é‡è¿ï¼Œé¿å…èµ„æºæ³„æ¼
3. **æµ‹è¯•å‹å¥½**: æµ‹è¯•æ—¶å¯ä»¥ç¦ç”¨é‡è¿ï¼Œé¿å…å¹²æ‰°
4. **py-xiaozhiæ ‡å‡†**: å®˜æ–¹å®ç°å°±æ˜¯è¿™æ ·è®¾è®¡çš„

### 7.2 ä¸ºä»€ä¹ˆéœ€è¦ `_cleanup_connection()`ï¼Ÿ

**é—®é¢˜**: ä¸ºä»€ä¹ˆä¸ç›´æ¥é‡è¿ï¼Œè¦å…ˆæ¸…ç†ï¼Ÿ

**ç­”æ¡ˆ**:
1. **ä»»åŠ¡æ³„æ¼**: æ—§çš„ `connection_task`, `monitor_task` ä¸æ¸…ç†ä¼šä¸€ç›´è¿è¡Œ
2. **åŒé‡è¿æ¥**: æ—§çš„ websocket ä¸å…³é—­ï¼Œä¼šå¯¼è‡´ä¸¤ä¸ªè¿æ¥å¹¶å­˜
3. **çŠ¶æ€æ··ä¹±**: æ—§ä»»åŠ¡å¯èƒ½è§¦å‘é”™è¯¯å›è°ƒï¼Œå¹²æ‰°æ–°è¿æ¥
4. **å†…å­˜æ³„æ¼**: é•¿æœŸè¿è¡Œä¼šç§¯ç´¯å¤§é‡åƒµå°¸ä»»åŠ¡

### 7.3 ä¸ºä»€ä¹ˆéœ€è¦ `_is_closing` æ ‡å¿—ï¼Ÿ

**é—®é¢˜**: ä¸»åŠ¨æ–­å¼€è¿æ¥æ—¶ä¸ºä»€ä¹ˆè¦é˜»æ­¢é‡è¿ï¼Ÿ

**ç­”æ¡ˆ**:
1. **ç”¨æˆ·æ„å›¾**: ç”¨æˆ·ä¸»åŠ¨æ–­å¼€æ—¶ä¸å¸Œæœ›è‡ªåŠ¨é‡è¿
2. **åº”ç”¨å…³é—­**: åº”ç”¨é€€å‡ºæ—¶è°ƒç”¨ `disconnect()`ï¼Œä¸åº”è¯¥é‡è¿
3. **èµ„æºé‡Šæ”¾**: é¿å…åœ¨æ¸…ç†èµ„æºæ—¶è§¦å‘æ–°è¿æ¥

### 7.4 ä¸ºä»€ä¹ˆéœ€è¦æ•è·6ç§å¼‚å¸¸ç±»å‹ï¼Ÿ

**é—®é¢˜**: åªæ•è· `ConnectionClosed` ä¸å¤Ÿå—ï¼Ÿ

**ç­”æ¡ˆ**:
ä¸å¤Ÿï¼ä¸åŒçš„è¿æ¥å¤±è´¥åœºæ™¯ä¼šè§¦å‘ä¸åŒå¼‚å¸¸ï¼š

| å¼‚å¸¸ç±»å‹ | è§¦å‘åœºæ™¯ | ç¤ºä¾‹ |
|---------|---------|------|
| `ConnectionClosed` | æ­£å¸¸å…³é—­ | æœåŠ¡å™¨ä¸»åŠ¨å…³é—­è¿æ¥ (close_code=1000) |
| `ConnectionClosedError` | å¼‚å¸¸å…³é—­ | æœåŠ¡å™¨è¶…æ—¶ (close_code=1006) |
| `InvalidState` | çŠ¶æ€å¼‚å¸¸ | åœ¨å…³é—­çš„è¿æ¥ä¸Šå‘é€æ¶ˆæ¯ |
| `ConnectionResetError` | è¿æ¥é‡ç½® | ç½‘ç»œä¸­æ–­ï¼ŒTCP RST |
| `OSError` | ç½‘ç»œI/Oé”™è¯¯ | DNSè§£æå¤±è´¥ï¼Œç«¯å£ä¸å¯è¾¾ |
| `Exception` | å…¶ä»–å¼‚å¸¸ | å…œåº•å¤„ç† |

---

## å…«ã€ä¸py-xiaozhiçš„å¯¹é½éªŒè¯

### 8.1 å…³é”®ç‰¹æ€§å¯¹æ¯”

| ç‰¹æ€§ | py-xiaozhi | æˆ‘ä»¬çš„å®ç° | çŠ¶æ€ |
|-----|-----------|-----------|------|
| `_auto_reconnect_enabled` | âœ… | âœ… | âœ… å¯¹é½ |
| `_max_reconnect_attempts` | âœ… | âœ… | âœ… å¯¹é½ |
| `_is_closing` | âœ… | âœ… | âœ… å¯¹é½ |
| `enable_auto_reconnect()` | âœ… | âœ… | âœ… å¯¹é½ |
| `_cleanup_connection()` | âœ… | âœ… | âœ… å¯¹é½ |
| `_handle_connection_loss()` | âœ… | âœ… | âœ… å¯¹é½ |
| 6ç§å¼‚å¸¸æ•è· | âœ… | âœ… | âœ… å¯¹é½ |
| close_codeæ£€æµ‹ | âœ… | âœ… | âœ… å¯¹é½ |
| ping/pongå¿ƒè·³ | âœ… (20s) | âœ… (20s) | âœ… å¯¹é½ |
| è¿æ¥ç›‘æ§ | âœ… (5s) | âœ… (5s) | âœ… å¯¹é½ |

### 8.2 å‚ç…§çš„py-xiaozhiä»£ç è¡Œå·

| åŠŸèƒ½ | py-xiaozhiè¡Œå· | è¯´æ˜ |
|-----|---------------|------|
| è‡ªåŠ¨é‡è¿å±æ€§ | ç¬¬26-28è¡Œ | `_auto_reconnect_enabled`, `_max_reconnect_attempts` |
| `enable_auto_reconnect()` | ç¬¬319-332è¡Œ | å¯ç”¨é‡è¿çš„å…¬å…±æ–¹æ³• |
| `_cleanup_connection()` | ç¬¬289-318è¡Œ | æ¸…ç†è¿æ¥èµ„æº |
| `_handle_connection_loss()` | ç¬¬229-272è¡Œ | å¤„ç†è¿æ¥ä¸¢å¤± |
| `_connection_monitor()` | ç¬¬209-228è¡Œ | è¿æ¥ç›‘æ§ï¼ˆclose_codeæ£€æŸ¥ï¼‰ |
| å¼‚å¸¸æ•è· | ç¬¬160-206è¡Œ | 6ç§å¼‚å¸¸ç±»å‹ |

---

## ä¹ã€å·²çŸ¥é™åˆ¶å’Œæ³¨æ„äº‹é¡¹

### 9.1 é™åˆ¶

1. **æœ€å¤§é‡è¿æ¬¡æ•°**: è®¾ç½®ä¸º5æ¬¡ï¼Œè¾¾åˆ°åå°†åœæ­¢é‡è¿
   - å¯é€šè¿‡è°ƒç”¨ `enable_auto_reconnect(enabled=True, max_attempts=10)` è°ƒæ•´

2. **é‡è¿å»¶è¿Ÿ**: ä½¿ç”¨æŒ‡æ•°é€€é¿ï¼Œæœ€å°1ç§’ï¼Œæœ€å¤§60ç§’
   - å¯é€šè¿‡ä¿®æ”¹ `WSConfig.reconnect_base_delay` å’Œ `reconnect_max_delay` è°ƒæ•´

3. **æ¸…ç†è¶…æ—¶**: WebSocketå…³é—­è¶…æ—¶è®¾ç½®ä¸º2ç§’
   - å¦‚æœæœåŠ¡å™¨å“åº”æ…¢ï¼Œå¯èƒ½ä¼šè¶…æ—¶å¼ºåˆ¶å…³é—­

### 9.2 æ³¨æ„äº‹é¡¹

1. **å¿…é¡»è°ƒç”¨ `enable_auto_reconnect()`**:
   - è‡ªåŠ¨é‡è¿ä¸ä¼šè‡ªåŠ¨å¼€å¯
   - å¿…é¡»åœ¨ `connect()` ä¹‹å‰è°ƒç”¨
   - å·²åœ¨ `voice_session_manager.py` ç¬¬463è¡Œæ·»åŠ 

2. **ä¸»åŠ¨æ–­å¼€ä¸ä¼šé‡è¿**:
   - è°ƒç”¨ `disconnect()` æ—¶è®¾ç½®äº† `_is_closing = True`
   - `_handle_connection_loss()` ä¼šæ£€æŸ¥æ­¤æ ‡å¿—å¹¶è·³è¿‡é‡è¿

3. **é‡è¿ä¼šé‡ç½®çŠ¶æ€**:
   - é‡è¿åéœ€è¦é‡æ–°è®¤è¯
   - session_id ä¿æŒä¸å˜
   - éŸ³é¢‘æ’­æ”¾çŠ¶æ€å¯èƒ½éœ€è¦é‡æ–°åˆå§‹åŒ–

---

## åã€åç»­ä¼˜åŒ–å»ºè®®

### 10.1 çŸ­æœŸä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

1. **æ·»åŠ é‡è¿æˆåŠŸå›è°ƒ**:
   ```python
   self.on_reconnected: Optional[Callable[[], None]] = None
   ```
   - ç”¨äºé€šçŸ¥å‰ç«¯è¿æ¥å·²æ¢å¤

2. **æŒä¹…åŒ–é‡è¿æ¬¡æ•°**:
   - å½“å‰é‡è¿æ¬¡æ•°åœ¨åº”ç”¨é‡å¯åé‡ç½®
   - å¯ä»¥è€ƒè™‘æŒä¹…åŒ–ï¼Œé¿å…é¢‘ç¹å¤±è´¥çš„è¿æ¥æµªè´¹èµ„æº

3. **è‡ªé€‚åº”é‡è¿å»¶è¿Ÿ**:
   - æ ¹æ®è¿æ¥å¤±è´¥åŸå› è°ƒæ•´å»¶è¿Ÿ
   - ä¾‹å¦‚ï¼šç½‘ç»œé”™è¯¯ä½¿ç”¨æ›´é•¿å»¶è¿Ÿï¼Œè®¤è¯å¤±è´¥ç«‹å³åœæ­¢

### 10.2 é•¿æœŸä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

1. **ç½‘ç»œçŠ¶æ€ç›‘æ§**:
   - ç›‘å¬ç³»ç»Ÿç½‘ç»œçŠ¶æ€å˜åŒ–
   - ç½‘ç»œæ¢å¤æ—¶ç«‹å³å°è¯•é‡è¿ï¼Œä¸ç­‰å»¶è¿Ÿ

2. **è¿æ¥è´¨é‡è¯„ä¼°**:
   - è®°å½•è¿æ¥ç¨³å®šæ€§æŒ‡æ ‡
   - æ ¹æ®å†å²æ•°æ®è°ƒæ•´å¿ƒè·³é—´éš”

3. **ä¼˜é›…é™çº§**:
   - è¿æ¥å¤±è´¥æ—¶ç¼“å­˜ç”¨æˆ·æ¶ˆæ¯
   - è¿æ¥æ¢å¤åè‡ªåŠ¨å‘é€ç¼“å­˜æ¶ˆæ¯

---

## åä¸€ã€æµ‹è¯•æŒ‡å—

### 11.1 å¦‚ä½•è¿è¡Œæµ‹è¯•

**æ­¥éª¤1**: é‡å¯åç«¯æœåŠ¡
```bash
cd /Users/good/Desktop/PocketSpeak/backend
# ç¡®ä¿ä¹‹å‰çš„æœåŠ¡å·²åœæ­¢
# å¯åŠ¨æ–°æœåŠ¡
python -m uvicorn main:app --reload
```

**æ­¥éª¤2**: é‡å¯å‰ç«¯åº”ç”¨
```bash
cd /Users/good/Desktop/PocketSpeak/frontend/pocketspeak_app
flutter run
```

**æ­¥éª¤3**: è§‚å¯Ÿå¯åŠ¨æ—¥å¿—
```
âœ… WebSocketè‡ªåŠ¨é‡è¿å·²å¯ç”¨ (max_attempts=5)
å»ºç«‹WebSocketè¿æ¥...
âœ… WebSocketè¿æ¥å»ºç«‹æˆåŠŸ (ping_interval=20s, ping_timeout=20s)
ğŸ’“ ä½¿ç”¨websocketsåº“å†…ç½®å¿ƒè·³æœºåˆ¶ï¼ˆæ— éœ€åº”ç”¨å±‚å¿ƒè·³ä»»åŠ¡ï¼‰
ğŸ” è¿æ¥ç›‘æ§ä»»åŠ¡å·²å¯åŠ¨ (æ£€æŸ¥é—´éš”=5s)
```

**æ­¥éª¤4**: æ‰§è¡Œ1åˆ†é’Ÿç©ºé—²æµ‹è¯•
1. å‘é€ä¸€æ¡æ¶ˆæ¯ï¼š"ä½ å¥½"
2. ç­‰å¾…1åˆ†é’Ÿï¼ˆä¸æ“ä½œï¼‰
3. è§‚å¯Ÿæ—¥å¿—æ˜¯å¦å‡ºç°é‡è¿ä¿¡æ¯
4. å†æ¬¡å‘é€æ¶ˆæ¯ï¼ŒéªŒè¯åŠŸèƒ½æ­£å¸¸

### 11.2 æ—¥å¿—å…³é”®è¯

**æ­£å¸¸é‡è¿æ—¥å¿—**:
```
ğŸ” è¿æ¥ç›‘æ§ï¼šæ£€æµ‹åˆ°WebSocketè¿æ¥å·²å…³é—­ (close_code=1006)
ğŸ”— å¤„ç†è¿æ¥ä¸¢å¤±: è¿æ¥ç›‘æ§æ£€æµ‹åˆ°è¿æ¥å·²å…³é—­
ğŸ§¹ å¼€å§‹æ¸…ç†è¿æ¥èµ„æº
âœ… è¿æ¥èµ„æºæ¸…ç†å®Œæˆ
ğŸ”„ å°†åœ¨ 1.0 ç§’åå°è¯•ç¬¬ 1 æ¬¡é‡è¿
å¼€å§‹è¿æ¥åˆ°å°æ™ºAIæœåŠ¡å™¨
âœ… WebSocketè¿æ¥å»ºç«‹æˆåŠŸ
```

**å¼‚å¸¸æ—¥å¿—**:
```
âŒ å·²è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•° (5)ï¼Œåœæ­¢é‡è¿
æ­£åœ¨ä¸»åŠ¨å…³é—­è¿æ¥ï¼Œè·³è¿‡é‡è¿é€»è¾‘
è‡ªåŠ¨é‡è¿æœªå¯ç”¨æˆ–å·²ç¦æ­¢é‡è¿
```

---

## åäºŒã€æ€»ç»“

### 12.1 æ ¸å¿ƒæˆå°±

âœ… **å®Œæ•´å®ç°äº†py-xiaozhiçš„è‡ªåŠ¨é‡è¿æœºåˆ¶**:
- æ·»åŠ äº†æ‰€æœ‰ç¼ºå¤±çš„å±æ€§ï¼ˆ`_auto_reconnect_enabled`, `_max_reconnect_attempts`, `_is_closing`ï¼‰
- å®ç°äº†æ‰€æœ‰ç¼ºå¤±çš„æ–¹æ³•ï¼ˆ`enable_auto_reconnect()`, `_cleanup_connection()`ï¼‰
- å¢å¼ºäº†å¼‚å¸¸æ•è·ï¼ˆ6ç§å¼‚å¸¸ç±»å‹ï¼‰
- åœ¨voice_session_managerä¸­å¯ç”¨äº†è‡ªåŠ¨é‡è¿

âœ… **è§£å†³äº†1åˆ†é’Ÿç©ºé—²æ–­çº¿é—®é¢˜**:
- ä¹‹å‰ï¼š1åˆ†é’Ÿç©ºé—²å°±æ–­å¼€ï¼Œæ— æ³•æ¢å¤
- ç°åœ¨ï¼š1åˆ†é’Ÿç©ºé—²åè‡ªåŠ¨é‡è¿ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥

âœ… **å¯¹é½äº†py-xiaozhiçš„æ ‡å‡†å®ç°**:
- 100%å‚ç…§å®˜æ–¹ä»£ç 
- æ‰€æœ‰å…³é”®ç‰¹æ€§å·²å¯¹é½
- æ³¨é‡Šä¸­æ ‡æ³¨äº†å‚ç…§çš„è¡Œå·

### 12.2 ä¿®æ”¹ç»Ÿè®¡

- **ä¿®æ”¹æ–‡ä»¶æ•°**: 2ä¸ª
- **æ–°å¢æ–¹æ³•**: 2ä¸ªï¼ˆ`enable_auto_reconnect()`, `_cleanup_connection()`ï¼‰
- **ä¿®æ”¹æ–¹æ³•**: 3ä¸ªï¼ˆ`disconnect()`, `_handle_connection_loss()`, `_handle_messages()`ï¼‰
- **æ–°å¢å±æ€§**: 3ä¸ªï¼ˆ`_is_closing`, `_auto_reconnect_enabled`, `_max_reconnect_attempts`ï¼‰
- **æ–°å¢ä»£ç è¡Œæ•°**: ~100è¡Œ
- **åˆ é™¤ä»£ç è¡Œæ•°**: ~20è¡Œ
- **å‡€å¢åŠ **: ~80è¡Œ

### 12.3 ä¸‹ä¸€æ­¥

ğŸ”¥ **ç«‹å³æµ‹è¯•**:
1. é‡å¯åç«¯å’Œå‰ç«¯
2. æ‰§è¡Œ1åˆ†é’Ÿç©ºé—²æµ‹è¯•
3. éªŒè¯è‡ªåŠ¨é‡è¿æ˜¯å¦ç”Ÿæ•ˆ
4. å¦‚æœ‰é—®é¢˜ï¼ŒæŸ¥çœ‹æ—¥å¿—å¹¶åé¦ˆ

ğŸ“Š **é•¿æœŸç›‘æ§**:
1. è®°å½•é‡è¿é¢‘ç‡å’ŒæˆåŠŸç‡
2. è§‚å¯Ÿæ˜¯å¦æœ‰å†…å­˜æ³„æ¼
3. æ”¶é›†ç”¨æˆ·åé¦ˆ

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-01-16
**ä¿®å¤çŠ¶æ€**: âœ… ä»£ç ä¿®æ”¹å®Œæˆï¼Œç­‰å¾…æµ‹è¯•éªŒè¯
**å‚ç…§æ ‡å‡†**: py-xiaozhi (100%å¯¹é½)
**æµ‹è¯•çŠ¶æ€**: å¾…ç”¨æˆ·æµ‹è¯•

**é‡è¦æé†’**:
- ğŸ”¥ è¯·é‡å¯åç«¯å’Œå‰ç«¯æœåŠ¡
- ğŸ”¥ æµ‹è¯•1åˆ†é’Ÿç©ºé—²åæ˜¯å¦è‡ªåŠ¨é‡è¿
- ğŸ”¥ å¦‚æœ‰é—®é¢˜è¯·æä¾›è¯¦ç»†æ—¥å¿—

---

## é™„å½•ï¼šå¿«é€Ÿè¯Šæ–­æŒ‡å—

### å¦‚æœ1åˆ†é’Ÿåä»ç„¶æ–­å¼€

**æ£€æŸ¥é¡¹1**: æ˜¯å¦å¯ç”¨äº†è‡ªåŠ¨é‡è¿ï¼Ÿ
```bash
# æœç´¢æ—¥å¿—ä¸­æ˜¯å¦æœ‰è¿™ä¸€è¡Œï¼š
"âœ… WebSocketè‡ªåŠ¨é‡è¿å·²å¯ç”¨ (max_attempts=5)"

# å¦‚æœæ²¡æœ‰ï¼Œè¯´æ˜voice_session_manageræœªæ­£ç¡®è°ƒç”¨enable_auto_reconnect()
```

**æ£€æŸ¥é¡¹2**: æ˜¯å¦æ£€æµ‹åˆ°äº†è¿æ¥æ–­å¼€ï¼Ÿ
```bash
# æœç´¢æ—¥å¿—ä¸­æ˜¯å¦æœ‰è¿™ä¸€è¡Œï¼š
"ğŸ” è¿æ¥ç›‘æ§ï¼šæ£€æµ‹åˆ°WebSocketè¿æ¥å·²å…³é—­"

# å¦‚æœæ²¡æœ‰ï¼Œè¯´æ˜è¿æ¥ç›‘æ§æœªç”Ÿæ•ˆ
```

**æ£€æŸ¥é¡¹3**: æ˜¯å¦è§¦å‘äº†é‡è¿ï¼Ÿ
```bash
# æœç´¢æ—¥å¿—ä¸­æ˜¯å¦æœ‰è¿™ä¸€è¡Œï¼š
"ğŸ”„ å°†åœ¨ X ç§’åå°è¯•ç¬¬ Y æ¬¡é‡è¿"

# å¦‚æœæ²¡æœ‰ï¼Œè¯´æ˜_handle_connection_loss()ä¸­çš„æ¡ä»¶åˆ¤æ–­æœ‰é—®é¢˜
```

**æ£€æŸ¥é¡¹4**: é‡è¿æ˜¯å¦æˆåŠŸï¼Ÿ
```bash
# æœç´¢æ—¥å¿—ä¸­æ˜¯å¦æœ‰è¿™ä¸€è¡Œï¼š
"âœ… WebSocketè¿æ¥å»ºç«‹æˆåŠŸ"

# å¦‚æœæ²¡æœ‰ï¼Œè¯´æ˜é‡è¿è¿‡ç¨‹å¤±è´¥ï¼ŒæŸ¥çœ‹é”™è¯¯æ—¥å¿—
```

### ç´§æ€¥å›æ»šæ–¹æ¡ˆ

å¦‚æœæ–°ç‰ˆæœ¬æœ‰é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

```bash
cd /Users/good/Desktop/PocketSpeak
git checkout HEAD~1 backend/services/voice_chat/ws_client.py
git checkout HEAD~1 backend/services/voice_chat/voice_session_manager.py
```

ç„¶åé‡å¯æœåŠ¡å³å¯æ¢å¤åˆ°ä¿®å¤å‰çš„ç‰ˆæœ¬ã€‚
