# PocketSpeak V1.2 用户管理 API 后端开发文档

**执行时间**: 2025-01-17
**版本**: V1.2
**任务**: 用户管理 API 后端开发
**状态**: ✅ 完成
**最后更新**: 2025-01-17

---

## 📋 任务概述

根据 [pocketspeak_PRD_v1.2.md](../backend_claude_memory/specs/pocketspeak_PRD_v1.2.md) 的需求，实现用户档案管理的后端 API 接口，包括创建、查询、更新、删除用户档案等功能。

---

## 🎯 实现目标

1. **数据模型**: 定义 UserProfile Pydantic 模型和相关枚举类型
2. **数据存储**: 实现基于 JSON 文件的用户档案存储服务
3. **API 接口**: 实现完整的 RESTful API 接口
4. **测试验证**: 编写测试脚本并验证所有接口功能

---

## 📦 新增文件清单

### 1. 数据模型

📄 `backend/models/user_profile.py`

**内容**:
- **UserProfile** 类：用户档案数据模型（Pydantic BaseModel）
- **LearningGoal** 枚举：学习目标选项
- **EnglishLevel** 枚举：英语水平选项（CEFR 标准）
- **AgeGroup** 枚举：年龄段选项
- **UserProfileCreateRequest** 类：创建用户档案请求模型
- **UserProfileUpdateRequest** 类：更新用户档案请求模型
- **UserProfileResponse** 类：用户档案响应模型

**字段说明**:
```python
class UserProfile(BaseModel):
    user_id: str              # 用户UUID
    device_id: str            # 设备ID
    learning_goal: LearningGoal   # 学习目标
    english_level: EnglishLevel   # 英语水平
    age_group: AgeGroup           # 年龄段
    created_at: datetime          # 创建时间
    last_active: datetime         # 最后活跃时间
```

### 2. 数据存储服务

📄 `backend/services/user_storage_service.py`

**内容**:
- **UserStorageService** 类：用户档案存储服务
- 使用 JSON 文件存储：`backend/data/user_profiles.json`
- 提供完整的 CRUD 操作

**核心方法**:
```python
class UserStorageService:
    def create_user_profile(self, user_profile: UserProfile) -> bool
    def get_user_profile(self, user_id: str) -> Optional[UserProfile]
    def update_user_profile(self, user_id: str, ...) -> bool
    def delete_user_profile(self, user_id: str) -> bool
    def update_last_active(self, user_id: str) -> bool
    def get_all_user_ids(self) -> list
```

### 3. API 路由

📄 `backend/routers/user.py`

**接口列表**:

| 方法 | 路径 | 功能 | 状态码 |
|------|------|------|--------|
| POST | `/api/user/init` | 创建用户档案 | 200/400/500 |
| GET | `/api/user/{user_id}` | 获取用户档案 | 200/404/500 |
| PUT | `/api/user/{user_id}` | 更新用户档案 | 200/404/400/500 |
| DELETE | `/api/user/{user_id}` | 删除用户档案（调试用） | 200/404/500 |
| GET | `/api/user/list/all` | 获取所有用户ID列表（调试用） | 200/500 |

### 4. 主程序集成

📄 `backend/main.py` (修改)

**修改内容**:
```python
# 新增导入
from routers import device, ws_lifecycle, voice_chat, user

# 注册用户管理路由
app.include_router(user.router)  # V1.2: 用户管理路由
```

### 5. 测试脚本

📄 `backend/test_user_api.py`

**测试项目**:
1. ✅ 创建用户档案
2. ✅ 获取用户档案
3. ✅ 更新用户档案
4. ✅ 获取所有用户列表
5. ✅ 使用无效枚举值（预期失败）
6. ✅ 获取不存在的用户（预期 404）
7. ✅ 重复创建用户（预期失败）
8. ✅ 删除用户档案

---

## 🔧 核心实现逻辑

### 1. API 接口设计

#### 1.1 POST `/api/user/init` - 创建用户档案

**请求体**:
```json
{
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "device_id": "ABC123DEF456",
  "learning_goal": "daily",
  "english_level": "B1",
  "age_group": "21-30"
}
```

**响应体**:
```json
{
  "success": true,
  "message": "用户档案创建成功",
  "user_profile": {
    "user_id": "550e8400-e29b-41d4-a716-446655440000",
    "device_id": "ABC123DEF456",
    "learning_goal": "daily",
    "english_level": "B1",
    "age_group": "21-30",
    "created_at": "2025-01-17T10:30:00",
    "last_active": "2025-01-17T10:30:00"
  }
}
```

**错误处理**:
- 400: 用户已存在
- 400: 无效的枚举值
- 500: 服务器内部错误

#### 1.2 GET `/api/user/{user_id}` - 获取用户档案

**路径参数**:
- `user_id`: 用户UUID

**响应体**:
```json
{
  "success": true,
  "message": "用户档案获取成功",
  "user_profile": { ... }
}
```

**特性**:
- 自动更新 `last_active` 时间戳

**错误处理**:
- 404: 用户不存在
- 500: 服务器内部错误

#### 1.3 PUT `/api/user/{user_id}` - 更新用户档案

**路径参数**:
- `user_id`: 用户UUID

**请求体**:
```json
{
  "english_level": "B2",
  "learning_goal": "business"
}
```

**特性**:
- 支持部分更新（所有字段可选）
- 自动更新 `last_active` 时间戳
- 枚举值验证

**错误处理**:
- 404: 用户不存在
- 400: 无效的枚举值
- 500: 服务器内部错误

### 2. 数据存储结构

**文件路径**: `backend/data/user_profiles.json`

**JSON 格式**:
```json
{
  "user_id_1": {
    "user_id": "550e8400-e29b-41d4-a716-446655440000",
    "device_id": "ABC123DEF456",
    "learning_goal": "daily",
    "english_level": "B1",
    "age_group": "21-30",
    "created_at": "2025-01-17T10:30:00",
    "last_active": "2025-01-17T10:30:00"
  },
  "user_id_2": { ... }
}
```

**特点**:
- 使用 user_id 作为字典键，O(1) 查询性能
- UTF-8 编码，支持中文
- 自动格式化（indent=2）

### 3. 枚举值设计

#### LearningGoal - 学习目标
```python
class LearningGoal(str, Enum):
    BUSINESS = "business"  # 商务职场英语
    EXAM = "exam"          # 雅思/KET/PET
    DAILY = "daily"        # 日常口语交流
    TRAVEL = "travel"      # 出国旅游
    OTHER = "other"        # 其他
```

#### EnglishLevel - 英语水平（CEFR 标准）
```python
class EnglishLevel(str, Enum):
    A1 = "A1"              # 入门
    A2 = "A2"              # 初级
    B1 = "B1"              # 中级
    B2 = "B2"              # 中高
    C1 = "C1"              # 高级
    C2 = "C2"              # 专家
    UNCERTAIN = "uncertain" # 不太确定
```

#### AgeGroup - 年龄段
```python
class AgeGroup(str, Enum):
    AGE_12_20 = "12-20"    # 12-20岁
    AGE_21_30 = "21-30"    # 21-30岁
    AGE_31_40 = "31-40"    # 31-40岁
    AGE_41_50 = "41-50"    # 41-50岁
    AGE_51_PLUS = "51+"    # 51岁以上
```

---

## 🧪 测试结果

### 测试执行命令
```bash
cd /Users/good/Desktop/PocketSpeak/backend
python test_user_api.py
```

### 测试结果摘要

| 测试项 | 状态 | 状态码 |
|--------|------|--------|
| 创建用户档案 | ✅ 通过 | 200 |
| 获取用户档案 | ✅ 通过 | 200 |
| 更新用户档案 | ✅ 通过 | 200 |
| 获取所有用户列表 | ✅ 通过 | 200 |
| 无效枚举值（预期失败） | ✅ 通过 | 400 |
| 获取不存在的用户（预期 404） | ✅ 通过 | 404 |
| 重复创建用户（预期失败） | ✅ 通过 | 400 |
| 删除用户档案 | ✅ 通过 | 200 |

**结论**: 所有 8 项测试全部通过 ✅

---

## 📊 数据流转

```
前端 Flutter 应用
  ↓
用户完成引导流程表单
  ↓
调用 POST /api/user/init
  ↓
UserRouter.create_user_profile()
  ├─ 验证枚举值
  ├─ 创建 UserProfile 对象
  └─ UserStorageService.create_user_profile()
      ├─ 加载 user_profiles.json
      ├─ 检查用户是否已存在
      ├─ 添加新用户档案
      └─ 保存 JSON 文件
  ↓
返回 UserProfileResponse
  ↓
前端保存到本地 SharedPreferences
```

---

## 🔗 与前端集成

### 前端调用示例

```dart
import 'package:http/http.dart' as http;
import 'dart:convert';

Future<void> syncUserProfileToBackend(UserProfile profile) async {
  final url = Uri.parse('http://127.0.0.1:8000/api/user/init');

  final response = await http.post(
    url,
    headers: {'Content-Type': 'application/json'},
    body: jsonEncode({
      'user_id': profile.userId,
      'device_id': profile.deviceId,
      'learning_goal': profile.learningGoal,
      'english_level': profile.englishLevel,
      'age_group': profile.ageGroup,
    }),
  );

  if (response.statusCode == 200) {
    print('✅ 用户档案已同步到后端');
  } else {
    print('❌ 同步失败: ${response.body}');
  }
}
```

### 集成时机

建议在前端 `OnboardingCompletePage` 点击"开始对话"按钮时，后台调用后端 API 同步用户档案：

```dart
ElevatedButton(
  onPressed: () async {
    // 1. 获取本地用户档案
    final profile = await UserStorageService.getUserProfile();

    // 2. 同步到后端
    if (profile != null) {
      await syncUserProfileToBackend(profile);
    }

    // 3. 导航到聊天页面
    Navigator.of(context).pushAndRemoveUntil(
      MaterialPageRoute(builder: (context) => const ChatPage()),
      (route) => false,
    );
  },
  child: const Text('开始对话'),
)
```

---

## 🎨 API 文档访问

启动后端服务后，可通过以下地址访问自动生成的 API 文档：

- **Swagger UI**: http://127.0.0.1:8000/docs
- **ReDoc**: http://127.0.0.1:8000/redoc

**文档特性**:
- 完整的请求/响应示例
- 枚举值说明
- 错误码说明
- 在线测试功能

---

## ✅ 完成检查项

- [x] 创建 Pydantic 数据模型
- [x] 创建数据存储服务（JSON 文件）
- [x] 实现 POST /api/user/init 接口
- [x] 实现 GET /api/user/{user_id} 接口
- [x] 实现 PUT /api/user/{user_id} 接口
- [x] 实现 DELETE /api/user/{user_id} 接口（调试用）
- [x] 实现 GET /api/user/list/all 接口（调试用）
- [x] 在 main.py 中注册路由
- [x] 编写测试脚本
- [x] 执行测试并全部通过
- [x] 生成 user_profiles.json 存储文件
- [x] 编写开发文档

---

## 🔗 相关文档

- **前端开发文档**: `claude_workspace/20250117_v1.2_user_onboarding_frontend.md`
- **PRD 文档**: `backend_claude_memory/specs/pocketspeak_PRD_v1.2.md`
- **开发路线图**: `backend_claude_memory/specs/development_roadmap.md`
- **命名规范**: `backend_claude_memory/specs/naming_convention.md`

---

## 📝 后续优化建议

### V1.3 版本建议

1. **数据库迁移**:
   - 当前使用 JSON 文件存储，适合小规模数据
   - 建议未来迁移到 SQLite 或 PostgreSQL

2. **数据同步**:
   - 实现多设备数据同步机制
   - 支持用户在不同设备间同步档案

3. **英语水平测试**:
   - 当用户选择 "uncertain" 时触发测试
   - 使用 GPT API 评估英语水平
   - 自动更新 english_level 字段

4. **学习进度追踪**:
   - 记录用户学习时长
   - 统计对话次数
   - 生成学习报告

5. **数据分析**:
   - 用户画像分析
   - 学习效果评估
   - 个性化推荐

---

## 🎉 完成总结

### 已完成内容

1. ✅ **后端数据模型**（Pydantic + 枚举）
2. ✅ **数据存储服务**（JSON 文件 + CRUD 操作）
3. ✅ **5 个 RESTful API 接口**（创建/查询/更新/删除/列表）
4. ✅ **主程序路由注册**
5. ✅ **完整测试脚本**（8 项测试全部通过）
6. ✅ **开发文档编写**

### 技术亮点

- 🔹 使用 Pydantic 进行数据验证和序列化
- 🔹 枚举类型确保数据一致性
- 🔹 清晰的错误处理和状态码设计
- 🔹 完整的测试覆盖
- 🔹 符合 RESTful API 设计规范

### 符合规范

- ✅ 遵循 PEP8 / Python 命名规范
- ✅ 按照 PRD 需求实现
- ✅ 代码注释完整清晰
- ✅ 文档结构规范

---

## 🚀 启动说明

### 启动后端服务

```bash
cd /Users/good/Desktop/PocketSpeak/backend
python main.py
```

### 测试 API

```bash
# 方式1: 使用测试脚本
python test_user_api.py

# 方式2: 使用 Swagger UI
访问: http://127.0.0.1:8000/docs

# 方式3: 使用 curl
curl -X POST "http://127.0.0.1:8000/api/user/init" \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "test-uuid-001",
    "device_id": "test-device-001",
    "learning_goal": "daily",
    "english_level": "B1",
    "age_group": "21-30"
  }'
```

---

**文档编写**: Claude Code
**开发时间**: 2025-01-17
**版本**: V1.2
**状态**: ✅ 完成
