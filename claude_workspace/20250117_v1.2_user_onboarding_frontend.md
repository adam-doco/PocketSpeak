# PocketSpeak V1.2 用户引导流程前端开发文档

**执行时间**: 2025-01-17
**版本**: V1.2
**任务**: 用户引导流程前端开发
**状态**: ✅ 完成
**最后更新**: 2025-01-17 (增加英语水平详细说明)

---

## 📋 任务概述

根据 [pocketspeak_PRD_v1.2.md](../backend_claude_memory/specs/pocketspeak_PRD_v1.2.md) 的需求，实现用户首次启动时的信息收集流程，包括学习目标、英语水平、年龄段等基础信息的采集。

---

## 🎯 实现目标

1. **用户引导流程**: 首次启动时展示欢迎页 → 信息表单页 → 完成确认页
2. **数据收集**: 收集用户学习目标、英语水平、年龄段
3. **本地存储**: 使用 SharedPreferences 存储用户档案
4. **流程控制**: 根据引导完成状态决定应用入口页面

---

## 📦 新增文件清单

### 1. 数据模型
📄 `lib/models/user_profile.dart`
- **UserProfile** 类：用户档案数据模型
- **LearningGoal** 枚举：学习目标选项
- **EnglishLevel** 枚举：英语水平选项
- **AgeGroup** 枚举：年龄段选项

### 2. 页面组件
📄 `lib/pages/onboarding/welcome_page.dart`
- 欢迎页，展示 App logo 和欢迎词
- 点击"开始使用"进入信息表单页

📄 `lib/pages/onboarding/user_info_form_page.dart`
- 用户信息表单页，包含三个问题：
  - Q1: 练习英语口语的主要目的
  - Q2: 目前的英语水平
  - Q3: 目前的年龄段
- 提交后保存数据并进入完成页

📄 `lib/pages/onboarding/onboarding_complete_page.dart`
- 引导完成页，提示"你的英语AI助手已准备好"
- 点击"开始对话"进入主聊天界面

### 3. 服务层
📄 `lib/services/user_storage_service.dart`
- **UserStorageService** 类：用户数据本地存储服务
- 提供保存、读取、检查、清除用户数据等功能

### 4. 集成修改
📄 `lib/main.dart` (修改)
- 增加用户引导流程状态检查
- 修改应用启动逻辑：引导流程 → 设备激活 → 主界面

📄 `pubspec.yaml` (修改)
- 新增依赖：
  - `shared_preferences: ^2.2.2` - 本地数据存储
  - `uuid: ^4.2.2` - UUID 生成
  - `device_info_plus: ^10.0.1` - 设备信息获取

---

## 🔧 核心实现逻辑

### 1. 用户数据模型

```dart
class UserProfile {
  final String userId;        // UUID
  final String deviceId;       // 设备ID
  final String learningGoal;   // 学习目标 (business/exam/daily/travel/other)
  final String englishLevel;   // 英语水平 (A1/A2/B1/B2/C1/C2/uncertain)
  final String ageGroup;       // 年龄段 (12-20/21-30/31-40/41-50/51+)
  final DateTime createdAt;    // 创建时间
  final DateTime lastActive;   // 最后活跃时间
}
```

### 2. 页面流程

```
应用启动
  ↓
检查引导完成状态 (UserStorageService.isOnboardingComplete())
  ↓
┌─────────────────┐
│ 未完成引导流程   │
└─────────────────┘
  ↓
WelcomePage (欢迎页)
  ↓
UserInfoFormPage (信息表单页)
  ├─ Q1: 学习目的
  ├─ Q2: 英语水平
  └─ Q3: 年龄段
  ↓
保存用户档案 (UserStorageService.saveUserProfile())
  ↓
OnboardingCompletePage (完成页)
  ↓
ChatPage (聊天主界面)
```

### 3. 本地存储

使用 SharedPreferences 存储：
- **user_profile**: 用户档案 JSON 字符串
- **onboarding_complete**: 引导流程完成标志 (bool)

```dart
// 保存用户档案
await UserStorageService.saveUserProfile(profile);

// 检查引导完成状态
bool isComplete = await UserStorageService.isOnboardingComplete();

// 获取用户档案
UserProfile? profile = await UserStorageService.getUserProfile();
```

### 4. 应用启动逻辑

```dart
Future<Map<String, bool>> _checkAppStatus() async {
  // 1. 检查用户引导流程
  final isOnboardingComplete = await UserStorageService.isOnboardingComplete();

  // 2. 检查设备激活状态
  final apiService = ApiService();
  final result = await apiService.waitForBindConfirmation();
  final isActivated = result['is_activated'] ?? false;

  return {
    'isOnboardingComplete': isOnboardingComplete,
    'isActivated': isActivated,
  };
}

// 根据状态决定显示哪个页面
if (!isOnboardingComplete) {
  return WelcomePage();  // 首次启动
}
if (isActivated) {
  return ChatPage();      // 已激活
} else {
  return BindingPage();   // 未激活
}
```

---

## 🎨 UI 设计要点

### 1. 配色方案
- 主色调: `#667EEA` (紫蓝色渐变)
- 辅助色: `#764BA2` (深紫色)
- 背景色: 白色 / 渐变紫
- 选中状态: 浅紫色背景 + 紫色边框

### 2. 交互设计
- **单选选项**: 圆形勾选框 + 选中高亮
- **提交按钮**: 仅当所有问题回答后才可点击
- **页面过渡**: pushReplacement (无返回) / pushAndRemoveUntil (清除历史)

### 3. 响应式布局
- 使用 `SafeArea` 适配刘海屏
- `SingleChildScrollView` 支持小屏幕滚动
- 按钮固定在底部，内容可滚动

---

## 📊 数据流转

```
用户填写表单
  ↓
UserInfoFormPage._handleSubmit()
  ├─ 生成 UUID (userId)
  ├─ 获取设备 ID (deviceId)
  ├─ 创建 UserProfile 对象
  └─ 保存到 SharedPreferences
  ↓
UserStorageService.saveUserProfile()
  ├─ 序列化为 JSON
  ├─ 保存 user_profile key
  └─ 设置 onboarding_complete = true
  ↓
导航到 OnboardingCompletePage
  ↓
导航到 ChatPage (清除所有历史路由)
```

---

## ✅ 测试检查项

- [x] 代码编译无错误 (`flutter analyze`)
- [x] 依赖包安装成功 (`flutter pub get`)
- [x] 数据模型序列化/反序列化正常
- [x] 本地存储读写功能正常
- [x] 页面导航流程正确
- [x] UI 适配不同屏幕尺寸
- [ ] 实机测试用户引导流程 (待用户测试)

---

## 🔗 相关文档

- **PRD 文档**: `backend_claude_memory/specs/pocketspeak_PRD_v1.2.md`
- **开发路线图**: `backend_claude_memory/specs/development_roadmap.md`
- **命名规范**: `backend_claude_memory/specs/naming_convention.md`

---

## 📝 后续待办

### V1.2 后续任务
1. **后端 API 开发**:
   - `POST /api/user/init` - 创建用户记录
   - `PUT /api/user/{user_id}` - 更新用户数据
   - `GET /api/user/{user_id}` - 获取用户数据

2. **数据同步**:
   - 将本地用户档案同步到后端
   - 支持多设备数据同步

### V1.3 预留功能
3. **英语水平测试** (可选):
   - 当用户选择"不太确定"时触发
   - 通过 GPT API 评估英语水平
   - 更新用户档案中的 english_level

---

## 🎉 完成总结

✅ **已完成内容**:
1. 用户数据模型 (UserProfile + 枚举类型)
2. 三个引导页面 (Welcome + Form + Complete)
3. 本地存储服务 (SharedPreferences)
4. 主应用入口集成 (main.dart)
5. 依赖包配置 (pubspec.yaml)
6. 代码质量检查 (无警告/错误)

✅ **技术亮点**:
- 清晰的页面流程控制
- 完整的数据模型设计
- 优雅的 UI/UX 设计
- 规范的代码结构

✅ **符合规范**:
- 遵循 PEP8 / Dart 命名规范
- 按照 PRD 需求实现
- 代码注释完整清晰

---

## 📝 更新记录

### 2025-01-17 更新 - 增加英语水平详细说明

**修改内容**:
- ✅ 在 `EnglishLevel` 枚举中增加 `description` 字段
- ✅ 为每个英语水平选项添加详细说明文字：
  - A1-入门（能运用最基础的语句）
  - A2-初级（能简单交流讨论问题）
  - B1-中级（可以轻松应对日常话题）
  - B2-中高（全英文输出复杂观点）
  - C1-高级（与外国人交流无障碍）
  - C2-专家（如母语者般熟练）
  - 不太确定？测一测我的英语水平
- ✅ 修改 `_buildOptionTile` 方法，支持显示副标题描述
- ✅ UI 优化：选项卡片显示双行文字（标题 + 描述）

**修改文件**:
- `lib/models/user_profile.dart` - 增加 description 字段
- `lib/pages/onboarding/user_info_form_page.dart` - UI 显示描述文字

**测试结果**: ✅ flutter analyze 通过，无错误

---

**文档编写**: Claude Code
**开发时间**: 2025-01-17
**版本**: V1.2
