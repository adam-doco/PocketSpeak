# PocketSpeak V1.3 ç”¨æˆ·ç™»å½•ä¸æ³¨å†Œç³»ç»Ÿ - æ¶æ„è®¾è®¡æ–‡æ¡£

**æ‰§è¡Œæ—¶é—´**: 2025-01-17
**ç‰ˆæœ¬**: V1.3
**ä»»åŠ¡**: ç”¨æˆ·ç™»å½•ä¸æ³¨å†Œç³»ç»Ÿæ¶æ„è®¾è®¡
**çŠ¶æ€**: ğŸ—ï¸ è®¾è®¡ä¸­
**æœ€åæ›´æ–°**: 2025-01-17

---

## ğŸ“‹ è®¾è®¡æ¦‚è¿°

æ ¹æ® [pocketspeak_PRD_v1.3.md](../backend_claude_memory/specs/pocketspeak_PRD_v1.3.md) çš„éœ€æ±‚ï¼Œè®¾è®¡å®Œæ•´çš„ç”¨æˆ·ç™»å½•ä¸æ³¨å†Œç³»ç»Ÿæ¶æ„ï¼ŒåŒ…æ‹¬å‰ç«¯è®¤è¯æµç¨‹ã€åç«¯ API è®¾è®¡ã€æ•°æ®æ¨¡å‹ã€Token ç®¡ç†ç­‰ã€‚

---

## ğŸ¯ æ ¸å¿ƒç›®æ ‡

1. **ç”¨æˆ·è´¦æˆ·ç³»ç»Ÿ**: æ„å»ºå®Œæ•´çš„ç”¨æˆ·è®¤è¯ä½“ç³»
2. **é‚®ç®±éªŒè¯ç ç™»å½•**: æ”¯æŒé‚®ç®± + éªŒè¯ç ç™»å½•æ–¹å¼
3. **Apple ID ç™»å½•**: é¢„ç•™ Apple ID ç™»å½•æ¥å£
4. **Token æŒä¹…åŒ–**: æ”¯æŒè‡ªåŠ¨ç™»å½•
5. **æ•°æ®æ•´åˆ**: ä¸ V1.2 ç”¨æˆ·æ¡£æ¡ˆæ•°æ®æ‰“é€š

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Frontend (Flutter)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  App å¯åŠ¨                                                        â”‚
â”‚    â”œâ”€ æ£€æŸ¥æœ¬åœ° Token                                            â”‚
â”‚    â”œâ”€ éªŒè¯ Token æœ‰æ•ˆæ€§ (GET /api/user/me)                     â”‚
â”‚    â””â”€ å†³å®šè·³è½¬: LoginPage / WelcomePage / ChatPage            â”‚
â”‚                                                                  â”‚
â”‚  LoginPage (ç™»å½•/æ³¨å†Œé¡µ)                                        â”‚
â”‚    â”œâ”€ é‚®ç®±è¾“å…¥ + éªŒè¯ç ç™»å½•                                     â”‚
â”‚    â”œâ”€ Apple ID ç™»å½• (é¢„ç•™)                                      â”‚
â”‚    â””â”€ ç™»å½•æˆåŠŸ â†’ ä¿å­˜ Token â†’ è·å–ç”¨æˆ·ä¿¡æ¯                     â”‚
â”‚                                                                  â”‚
â”‚  AuthService (è®¤è¯æœåŠ¡)                                         â”‚
â”‚    â”œâ”€ sendVerificationCode() - å‘é€éªŒè¯ç                        â”‚
â”‚    â”œâ”€ loginWithEmailCode() - é‚®ç®±éªŒè¯ç ç™»å½•                     â”‚
â”‚    â”œâ”€ loginWithApple() - Apple ID ç™»å½•                          â”‚
â”‚    â”œâ”€ getCurrentUser() - è·å–å½“å‰ç”¨æˆ·                          â”‚
â”‚    â”œâ”€ saveToken() - ä¿å­˜ Token                                 â”‚
â”‚    â””â”€ logout() - ç™»å‡º                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ HTTP/HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Backend (FastAPI)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Authentication Router (/api/auth)                               â”‚
â”‚    â”œâ”€ POST /api/auth/send-code - å‘é€é‚®ç®±éªŒè¯ç                 â”‚
â”‚    â”œâ”€ POST /api/auth/login-code - é‚®ç®±éªŒè¯ç ç™»å½•               â”‚
â”‚    â”œâ”€ POST /api/auth/login-apple - Apple ID ç™»å½• (é¢„ç•™)        â”‚
â”‚    â””â”€ POST /api/auth/logout - ç™»å‡º                             â”‚
â”‚                                                                  â”‚
â”‚  User Router (/api/user)                                         â”‚
â”‚    â”œâ”€ GET /api/user/me - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯                      â”‚
â”‚    â”œâ”€ PUT /api/user/me - æ›´æ–°ç”¨æˆ·ä¿¡æ¯                          â”‚
â”‚    â””â”€ (ä¿ç•™ V1.2 çš„ç”¨æˆ·æ¡£æ¡ˆæ¥å£)                               â”‚
â”‚                                                                  â”‚
â”‚  Services                                                        â”‚
â”‚    â”œâ”€ AuthService - è®¤è¯é€»è¾‘                                   â”‚
â”‚    â”œâ”€ EmailService - é‚®ä»¶å‘é€ (SMTP/Sendgrid)                  â”‚
â”‚    â”œâ”€ TokenService - JWT Token ç”Ÿæˆå’ŒéªŒè¯                      â”‚
â”‚    â””â”€ UserService - ç”¨æˆ·ç®¡ç†                                   â”‚
â”‚                                                                  â”‚
â”‚  Data Storage                                                    â”‚
â”‚    â”œâ”€ users.json - ç”¨æˆ·æ•°æ® (åç»­å¯è¿ç§»åˆ° MongoDB)             â”‚
â”‚    â””â”€ verification_codes.json - éªŒè¯ç ç¼“å­˜ (åç»­å¯ç”¨ Redis)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š æ•°æ®æ¨¡å‹è®¾è®¡

### 1. User æ¨¡å‹ (ç»Ÿä¸€ç”¨æˆ·æ¨¡å‹)

```python
class User(BaseModel):
    """ç”¨æˆ·æ•°æ®æ¨¡å‹ - V1.3"""
    user_id: str                    # UUID
    email: Optional[str] = None     # é‚®ç®± (å¯é€‰ï¼ŒAppleç™»å½•å¯èƒ½æ²¡æœ‰)
    email_verified: bool = False    # é‚®ç®±æ˜¯å¦éªŒè¯
    login_type: LoginType           # ç™»å½•æ–¹å¼ (email_code / apple)
    apple_id: Optional[str] = None  # Apple ID (å¯é€‰)

    # V1.2 ç”¨æˆ·æ¡£æ¡ˆæ•°æ® (é›†æˆ)
    device_id: Optional[str] = None
    learning_goal: Optional[str] = None
    english_level: Optional[str] = None
    age_group: Optional[str] = None

    # æ—¶é—´æˆ³
    created_at: datetime
    last_login_at: datetime

    # æ‰©å±•å­—æ®µ (é¢„ç•™)
    phone: Optional[str] = None
    wechat_openid: Optional[str] = None
    google_id: Optional[str] = None
```

### 2. LoginType æšä¸¾

```python
class LoginType(str, Enum):
    EMAIL_CODE = "email_code"   # é‚®ç®±éªŒè¯ç 
    APPLE = "apple"             # Apple ID
    PHONE_CODE = "phone_code"   # æ‰‹æœºéªŒè¯ç  (é¢„ç•™)
    WECHAT = "wechat"           # å¾®ä¿¡ç™»å½• (é¢„ç•™)
    GOOGLE = "google"           # Google ç™»å½• (é¢„ç•™)
```

### 3. VerificationCode æ¨¡å‹

```python
class VerificationCode(BaseModel):
    """éªŒè¯ç æ¨¡å‹"""
    email: str
    code: str                   # 6ä½æ•°å­—
    expires_at: datetime        # è¿‡æœŸæ—¶é—´ (5åˆ†é’Ÿ)
    created_at: datetime
    used: bool = False          # æ˜¯å¦å·²ä½¿ç”¨
```

---

## ğŸ” Token ç®¡ç†è®¾è®¡

### JWT Token ç»“æ„

```json
{
  "user_id": "uuid",
  "email": "user@example.com",
  "exp": 1234567890,  // è¿‡æœŸæ—¶é—´ (7å¤©)
  "iat": 1234567890   // ç­¾å‘æ—¶é—´
}
```

### Token ç”Ÿæˆå’ŒéªŒè¯

```python
# backend/services/token_service.py

import jwt
from datetime import datetime, timedelta

SECRET_KEY = "your-secret-key"  # åº”ä»ç¯å¢ƒå˜é‡è¯»å–
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_DAYS = 7

def create_access_token(user_id: str, email: str) -> str:
    """åˆ›å»º JWT Token"""
    expire = datetime.utcnow() + timedelta(days=ACCESS_TOKEN_EXPIRE_DAYS)
    payload = {
        "user_id": user_id,
        "email": email,
        "exp": expire,
        "iat": datetime.utcnow()
    }
    return jwt.encode(payload, SECRET_KEY, algorithm=ALGORITHM)

def verify_token(token: str) -> dict:
    """éªŒè¯ Token"""
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        return payload
    except jwt.ExpiredSignatureError:
        raise Exception("Token å·²è¿‡æœŸ")
    except jwt.JWTError:
        raise Exception("Token æ— æ•ˆ")
```

---

## ğŸ”„ æ ¸å¿ƒæµç¨‹è®¾è®¡

### 1. é‚®ç®±éªŒè¯ç ç™»å½•æµç¨‹

```
ç”¨æˆ·è¾“å…¥é‚®ç®±
  â†“
ç‚¹å‡»"å‘é€éªŒè¯ç "
  â†“
POST /api/auth/send-code
  â”œâ”€ åç«¯ç”Ÿæˆ6ä½éšæœºæ•°å­—
  â”œâ”€ ä¿å­˜åˆ° verification_codes.json (æœ‰æ•ˆæœŸ5åˆ†é’Ÿ)
  â”œâ”€ å‘é€é‚®ä»¶ (EmailService)
  â””â”€ è¿”å›æˆåŠŸå“åº”
  â†“
å‰ç«¯æ˜¾ç¤ºå€’è®¡æ—¶ (60ç§’)
  â†“
ç”¨æˆ·è¾“å…¥éªŒè¯ç 
  â†“
ç‚¹å‡»"ç™»å½•"
  â†“
POST /api/auth/login-code
  â”œâ”€ åç«¯éªŒè¯éªŒè¯ç æ˜¯å¦æ­£ç¡®
  â”œâ”€ éªŒè¯éªŒè¯ç æ˜¯å¦è¿‡æœŸ
  â”œâ”€ éªŒè¯éªŒè¯ç æ˜¯å¦å·²ä½¿ç”¨
  â”œâ”€ æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
  â”‚   â”œâ”€ ä¸å­˜åœ¨ â†’ åˆ›å»ºæ–°ç”¨æˆ·
  â”‚   â””â”€ å­˜åœ¨ â†’ æ›´æ–° last_login_at
  â”œâ”€ ç”Ÿæˆ JWT Token
  â””â”€ è¿”å› Token + ç”¨æˆ·ä¿¡æ¯
  â†“
å‰ç«¯ä¿å­˜ Token åˆ° SecureStorage
  â†“
GET /api/user/me (éªŒè¯ Token)
  â†“
è·³è½¬åˆ°ä¸»ç•Œé¢
```

### 2. App å¯åŠ¨æµç¨‹ (å«ç™»å½•çŠ¶æ€æ£€æŸ¥)

```
App å¯åŠ¨
  â†“
æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰ Token
  â”œâ”€ æ—  Token
  â”‚   â””â”€ è·³è½¬åˆ° LoginPage
  â”‚
  â””â”€ æœ‰ Token
      â†“
      GET /api/user/me (æºå¸¦ Token)
      â”œâ”€ æˆåŠŸ (200)
      â”‚   â”œâ”€ æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ english_level
      â”‚   â”‚   â”œâ”€ æœ‰ â†’ è·³è½¬åˆ° ChatPage
      â”‚   â”‚   â””â”€ æ—  â†’ è·³è½¬åˆ° WelcomePage (V1.2 å¼•å¯¼æµç¨‹)
      â”‚   â””â”€
      â””â”€ å¤±è´¥ (401)
          â”œâ”€ Token è¿‡æœŸæˆ–æ— æ•ˆ
          â””â”€ è·³è½¬åˆ° LoginPage
```

### 3. ä¸ V1.2 æ•°æ®æ•´åˆæµç¨‹

```
ç”¨æˆ·é¦–æ¬¡ç™»å½• (é‚®ç®±éªŒè¯ç )
  â†“
åˆ›å»º User è®°å½• (æ—  english_level)
  â†“
GET /api/user/me
  â”œâ”€ english_level ä¸ºç©º
  â””â”€ å‰ç«¯æ£€æµ‹åˆ°éœ€è¦å¼•å¯¼
  â†“
è·³è½¬åˆ° WelcomePage (V1.2)
  â†“
å®Œæˆç”¨æˆ·æ¡£æ¡ˆè¡¨å•
  â†“
PUT /api/user/me (æ›´æ–° english_level ç­‰å­—æ®µ)
  â†“
ä¿å­˜åˆ°ç”¨æˆ·è®°å½•
  â†“
è·³è½¬åˆ° ChatPage
```

---

## ğŸ“¡ API æ¥å£è¯¦ç»†è®¾è®¡

### 1. POST /api/auth/send-code

**è¯·æ±‚**:
```json
{
  "email": "user@example.com"
}
```

**å“åº”**:
```json
{
  "success": true,
  "message": "éªŒè¯ç å·²å‘é€",
  "expires_in": 300  // 5åˆ†é’Ÿ
}
```

**é”™è¯¯å“åº”**:
```json
{
  "success": false,
  "message": "å‘é€é¢‘ç¹ï¼Œè¯·60ç§’åå†è¯•"
}
```

**ä¸šåŠ¡é€»è¾‘**:
- éªŒè¯é‚®ç®±æ ¼å¼
- æ£€æŸ¥å†·å´æ—¶é—´ (60ç§’)
- ç”Ÿæˆ6ä½éšæœºæ•°å­—
- ä¿å­˜åˆ°ç¼“å­˜ (æœ‰æ•ˆæœŸ5åˆ†é’Ÿ)
- å‘é€é‚®ä»¶
- è¿”å›æˆåŠŸå“åº”

---

### 2. POST /api/auth/login-code

**è¯·æ±‚**:
```json
{
  "email": "user@example.com",
  "code": "123456"
}
```

**æˆåŠŸå“åº”**:
```json
{
  "success": true,
  "token": "eyJhbGciOiJIUzI1NiIs...",
  "user": {
    "user_id": "uuid",
    "email": "user@example.com",
    "email_verified": true,
    "login_type": "email_code",
    "english_level": "B1",  // å¯èƒ½ä¸º null
    "created_at": "2025-01-17T10:00:00Z",
    "last_login_at": "2025-01-17T10:00:00Z"
  }
}
```

**é”™è¯¯å“åº”**:
```json
{
  "success": false,
  "message": "éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸ"
}
```

**ä¸šåŠ¡é€»è¾‘**:
- éªŒè¯é‚®ç®±æ ¼å¼
- æŸ¥è¯¢éªŒè¯ç è®°å½•
- éªŒè¯éªŒè¯ç æ˜¯å¦æ­£ç¡®
- éªŒè¯éªŒè¯ç æ˜¯å¦è¿‡æœŸ
- éªŒè¯éªŒè¯ç æ˜¯å¦å·²ä½¿ç”¨
- æ ‡è®°éªŒè¯ç ä¸ºå·²ä½¿ç”¨
- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
  - ä¸å­˜åœ¨: åˆ›å»ºæ–°ç”¨æˆ· (email_verified=true)
  - å­˜åœ¨: æ›´æ–° last_login_at
- ç”Ÿæˆ JWT Token
- è¿”å› Token + ç”¨æˆ·ä¿¡æ¯

---

### 3. GET /api/user/me

**è¯·æ±‚å¤´**:
```
Authorization: Bearer <token>
```

**æˆåŠŸå“åº”**:
```json
{
  "success": true,
  "user": {
    "user_id": "uuid",
    "email": "user@example.com",
    "email_verified": true,
    "login_type": "email_code",
    "learning_goal": "business",
    "english_level": "B1",
    "age_group": "21-30",
    "created_at": "2025-01-17T10:00:00Z",
    "last_login_at": "2025-01-17T10:00:00Z"
  }
}
```

**é”™è¯¯å“åº”** (401):
```json
{
  "detail": "Token æ— æ•ˆæˆ–å·²è¿‡æœŸ"
}
```

**ä¸šåŠ¡é€»è¾‘**:
- ä» Authorization å¤´æå– Token
- éªŒè¯ Token æœ‰æ•ˆæ€§
- è§£æ Token è·å– user_id
- æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
- è¿”å›ç”¨æˆ·ä¿¡æ¯

---

### 4. PUT /api/user/me (æ›´æ–°ç”¨æˆ·ä¿¡æ¯)

**è¯·æ±‚å¤´**:
```
Authorization: Bearer <token>
```

**è¯·æ±‚ä½“**:
```json
{
  "learning_goal": "business",
  "english_level": "B1",
  "age_group": "21-30"
}
```

**æˆåŠŸå“åº”**:
```json
{
  "success": true,
  "user": { /* æ›´æ–°åçš„ç”¨æˆ·ä¿¡æ¯ */ }
}
```

---

### 5. POST /api/auth/login-apple (é¢„ç•™)

**è¯·æ±‚**:
```json
{
  "apple_id_token": "xxx",
  "apple_user_id": "xxx"
}
```

**æˆåŠŸå“åº”**:
```json
{
  "success": true,
  "token": "...",
  "user": { /* ç”¨æˆ·ä¿¡æ¯ */ }
}
```

---

## ğŸ“ æ–‡ä»¶ç»“æ„è®¾è®¡

### åç«¯æ–‡ä»¶ç»“æ„

```
backend/
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ user.py                    # User æ¨¡å‹ (ç»Ÿä¸€)
â”‚   â””â”€â”€ verification_code.py       # éªŒè¯ç æ¨¡å‹
â”‚
â”œâ”€â”€ routers/
â”‚   â”œâ”€â”€ auth.py                    # è®¤è¯è·¯ç”±
â”‚   â””â”€â”€ user.py                    # ç”¨æˆ·è·¯ç”± (æ‰©å±• V1.2)
â”‚
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ auth_service.py            # è®¤è¯æœåŠ¡
â”‚   â”œâ”€â”€ email_service.py           # é‚®ä»¶å‘é€æœåŠ¡
â”‚   â”œâ”€â”€ token_service.py           # JWT Token æœåŠ¡
â”‚   â”œâ”€â”€ user_service.py            # ç”¨æˆ·ç®¡ç†æœåŠ¡
â”‚   â””â”€â”€ verification_code_service.py  # éªŒè¯ç ç®¡ç†
â”‚
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ jwt_helper.py              # JWT å·¥å…·ç±»
â”‚   â””â”€â”€ email_helper.py            # é‚®ä»¶å‘é€å·¥å…·
â”‚
â”œâ”€â”€ middleware/
â”‚   â””â”€â”€ auth_middleware.py         # è®¤è¯ä¸­é—´ä»¶
â”‚
â””â”€â”€ data/
    â”œâ”€â”€ users.json                 # ç”¨æˆ·æ•°æ®
    â””â”€â”€ verification_codes.json    # éªŒè¯ç ç¼“å­˜
```

### å‰ç«¯æ–‡ä»¶ç»“æ„

```
frontend/lib/
â”œâ”€â”€ models/
â”‚   â””â”€â”€ user.dart                  # User æ¨¡å‹ (ç»Ÿä¸€)
â”‚
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ auth/
â”‚       â”œâ”€â”€ login_page.dart        # ç™»å½•/æ³¨å†Œé¡µ
â”‚       â”œâ”€â”€ email_input.dart       # é‚®ç®±è¾“å…¥ç»„ä»¶
â”‚       â””â”€â”€ code_input.dart        # éªŒè¯ç è¾“å…¥ç»„ä»¶
â”‚
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ auth_service.dart          # è®¤è¯æœåŠ¡
â”‚   â””â”€â”€ storage_service.dart       # æœ¬åœ°å­˜å‚¨æœåŠ¡ (Token)
â”‚
â””â”€â”€ utils/
    â””â”€â”€ auth_interceptor.dart      # HTTP æ‹¦æˆªå™¨ (è‡ªåŠ¨æ·»åŠ  Token)
```

---

## ğŸ”’ å®‰å…¨è®¾è®¡

### 1. éªŒè¯ç å®‰å…¨
- **æœ‰æ•ˆæœŸ**: 5 åˆ†é’Ÿ
- **å†·å´æ—¶é—´**: 60 ç§’
- **å•æ¬¡ä½¿ç”¨**: éªŒè¯åæ ‡è®°ä¸ºå·²ä½¿ç”¨
- **éšæœºæ€§**: ä½¿ç”¨ secrets æ¨¡å—ç”Ÿæˆ

### 2. Token å®‰å…¨
- **ç®—æ³•**: HS256 (HMAC with SHA-256)
- **å¯†é’¥**: ä»ç¯å¢ƒå˜é‡è¯»å–ï¼Œä¸ç¡¬ç¼–ç 
- **æœ‰æ•ˆæœŸ**: 7 å¤©
- **å­˜å‚¨**: å‰ç«¯ä½¿ç”¨ flutter_secure_storage

### 3. API å®‰å…¨
- **HTTPS**: ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶ HTTPS
- **CORS**: é…ç½®å…è®¸çš„æ¥æº
- **Rate Limiting**: é˜²æ­¢æš´åŠ›ç ´è§£ (é¢„ç•™)

---

## ğŸ“ æ•°æ®è¿ç§»ç­–ç•¥

### V1.2 â†’ V1.3 æ•°æ®è¿ç§»

**ç°çŠ¶**:
- V1.2: `user_profiles.json` å­˜å‚¨ç”¨æˆ·æ¡£æ¡ˆ (user_id, device_id, learning_goal, english_level, age_group)

**è¿ç§»æ–¹æ¡ˆ**:
1. **ä¿ç•™ V1.2 æ•°æ®æ–‡ä»¶**: ä¸åˆ é™¤ `user_profiles.json`
2. **åˆ›å»ºæ–°çš„ users.json**: å­˜å‚¨å®Œæ•´ç”¨æˆ·ä¿¡æ¯ (åŒ…å«è®¤è¯ä¿¡æ¯)
3. **æ•°æ®æ•´åˆ**: ç™»å½•åï¼Œå¦‚æœç”¨æˆ·å·²æœ‰ V1.2 æ¡£æ¡ˆï¼Œè‡ªåŠ¨å…³è”
4. **å…³è”é€»è¾‘**:
   - ç”¨æˆ·ç™»å½•åï¼Œæ£€æŸ¥ device_id æ˜¯å¦åœ¨ `user_profiles.json` ä¸­å­˜åœ¨
   - å¦‚æœå­˜åœ¨ï¼Œå°† learning_goal, english_level, age_group è¿ç§»åˆ° `users.json`
   - æ ‡è®° V1.2 æ•°æ®ä¸ºå·²è¿ç§»

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### åç«¯æµ‹è¯•
1. âœ… å‘é€éªŒè¯ç æ¥å£æµ‹è¯•
2. âœ… éªŒè¯ç ç™»å½•æ¥å£æµ‹è¯•
3. âœ… Token ç”Ÿæˆå’ŒéªŒè¯æµ‹è¯•
4. âœ… è·å–ç”¨æˆ·ä¿¡æ¯æ¥å£æµ‹è¯•
5. âœ… éªŒè¯ç è¿‡æœŸæµ‹è¯•
6. âœ… éªŒè¯ç å†·å´æµ‹è¯•

### å‰ç«¯æµ‹è¯•
1. âœ… ç™»å½•é¡µé¢ UI æµ‹è¯•
2. âœ… é‚®ç®±æ ¼å¼éªŒè¯æµ‹è¯•
3. âœ… éªŒè¯ç å€’è®¡æ—¶æµ‹è¯•
4. âœ… ç™»å½•æµç¨‹æµ‹è¯•
5. âœ… Token å­˜å‚¨å’Œè¯»å–æµ‹è¯•
6. âœ… å¯åŠ¨æµç¨‹æµ‹è¯•

### é›†æˆæµ‹è¯•
1. âœ… å®Œæ•´ç™»å½•æµç¨‹æµ‹è¯•
2. âœ… è‡ªåŠ¨ç™»å½•æµ‹è¯•
3. âœ… Token è¿‡æœŸå¤„ç†æµ‹è¯•
4. âœ… V1.2 æ•°æ®æ•´åˆæµ‹è¯•

---

## ğŸ“‹ å¼€å‘ä»»åŠ¡æ¸…å•

### åç«¯å¼€å‘
- [ ] åˆ›å»º User æ•°æ®æ¨¡å‹
- [ ] åˆ›å»º VerificationCode æ•°æ®æ¨¡å‹
- [ ] å®ç° TokenService (JWT)
- [ ] å®ç° EmailService (é‚®ä»¶å‘é€)
- [ ] å®ç° VerificationCodeService (éªŒè¯ç ç®¡ç†)
- [ ] å®ç° AuthService (è®¤è¯é€»è¾‘)
- [ ] å®ç° POST /api/auth/send-code
- [ ] å®ç° POST /api/auth/login-code
- [ ] å®ç° GET /api/user/me
- [ ] å®ç° PUT /api/user/me
- [ ] å®ç°è®¤è¯ä¸­é—´ä»¶
- [ ] ç¼–å†™åç«¯æµ‹è¯•è„šæœ¬

### å‰ç«¯å¼€å‘
- [ ] åˆ›å»º User æ¨¡å‹
- [ ] åˆ›å»º LoginPage UI
- [ ] å®ç° AuthService
- [ ] å®ç° StorageService (Token å­˜å‚¨)
- [ ] å®ç°é‚®ç®±éªŒè¯ç ç™»å½•æµç¨‹
- [ ] ä¿®æ”¹ main.dart å¯åŠ¨æµç¨‹
- [ ] å®ç° HTTP æ‹¦æˆªå™¨ (è‡ªåŠ¨æ·»åŠ  Token)
- [ ] æ•´åˆ V1.2 ç”¨æˆ·æ¡£æ¡ˆæµç¨‹

### é›†æˆä¸æµ‹è¯•
- [ ] å‰åç«¯è”è°ƒæµ‹è¯•
- [ ] å®Œæ•´ç™»å½•æµç¨‹æµ‹è¯•
- [ ] V1.2 æ•°æ®è¿ç§»æµ‹è¯•
- [ ] ç¼–å†™å¼€å‘æ–‡æ¡£

---

## ğŸ¯ é‡Œç¨‹ç¢‘

| é˜¶æ®µ | å®Œæˆæ ‡å‡† | é¢„è®¡æ—¶é—´ |
|------|----------|----------|
| æ¶æ„è®¾è®¡ | å®Œæˆæœ¬æ–‡æ¡£ | âœ… å®Œæˆ |
| åç«¯å¼€å‘ | æ‰€æœ‰ API æ¥å£å®ç°å¹¶æµ‹è¯•é€šè¿‡ | 2-3 å°æ—¶ |
| å‰ç«¯å¼€å‘ | ç™»å½•é¡µé¢å’Œè®¤è¯æµç¨‹å®Œæˆ | 2-3 å°æ—¶ |
| é›†æˆæµ‹è¯• | å®Œæ•´æµç¨‹æµ‹è¯•é€šè¿‡ | 1 å°æ—¶ |
| æ–‡æ¡£ç¼–å†™ | å®Œæ•´çš„å¼€å‘æ–‡æ¡£ | 1 å°æ—¶ |

---

**æ–‡æ¡£ç¼–å†™**: Claude Code
**è®¾è®¡æ—¶é—´**: 2025-01-17
**ç‰ˆæœ¬**: V1.3
**çŠ¶æ€**: âœ… è®¾è®¡å®Œæˆ
