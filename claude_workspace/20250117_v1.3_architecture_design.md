# PocketSpeak V1.3 用户登录与注册系统 - 架构设计文档

**执行时间**: 2025-01-17
**版本**: V1.3
**任务**: 用户登录与注册系统架构设计
**状态**: 🏗️ 设计中
**最后更新**: 2025-01-17

---

## 📋 设计概述

根据 [pocketspeak_PRD_v1.3.md](../backend_claude_memory/specs/pocketspeak_PRD_v1.3.md) 的需求，设计完整的用户登录与注册系统架构，包括前端认证流程、后端 API 设计、数据模型、Token 管理等。

---

## 🎯 核心目标

1. **用户账户系统**: 构建完整的用户认证体系
2. **邮箱验证码登录**: 支持邮箱 + 验证码登录方式
3. **Apple ID 登录**: 预留 Apple ID 登录接口
4. **Token 持久化**: 支持自动登录
5. **数据整合**: 与 V1.2 用户档案数据打通

---

## 🏗️ 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         Frontend (Flutter)                       │
├─────────────────────────────────────────────────────────────────┤
│  App 启动                                                        │
│    ├─ 检查本地 Token                                            │
│    ├─ 验证 Token 有效性 (GET /api/user/me)                     │
│    └─ 决定跳转: LoginPage / WelcomePage / ChatPage            │
│                                                                  │
│  LoginPage (登录/注册页)                                        │
│    ├─ 邮箱输入 + 验证码登录                                     │
│    ├─ Apple ID 登录 (预留)                                      │
│    └─ 登录成功 → 保存 Token → 获取用户信息                     │
│                                                                  │
│  AuthService (认证服务)                                         │
│    ├─ sendVerificationCode() - 发送验证码                       │
│    ├─ loginWithEmailCode() - 邮箱验证码登录                     │
│    ├─ loginWithApple() - Apple ID 登录                          │
│    ├─ getCurrentUser() - 获取当前用户                          │
│    ├─ saveToken() - 保存 Token                                 │
│    └─ logout() - 登出                                           │
└─────────────────────────────────────────────────────────────────┘
                              ↓ HTTP/HTTPS
┌─────────────────────────────────────────────────────────────────┐
│                         Backend (FastAPI)                        │
├─────────────────────────────────────────────────────────────────┤
│  Authentication Router (/api/auth)                               │
│    ├─ POST /api/auth/send-code - 发送邮箱验证码                │
│    ├─ POST /api/auth/login-code - 邮箱验证码登录               │
│    ├─ POST /api/auth/login-apple - Apple ID 登录 (预留)        │
│    └─ POST /api/auth/logout - 登出                             │
│                                                                  │
│  User Router (/api/user)                                         │
│    ├─ GET /api/user/me - 获取当前用户信息                      │
│    ├─ PUT /api/user/me - 更新用户信息                          │
│    └─ (保留 V1.2 的用户档案接口)                               │
│                                                                  │
│  Services                                                        │
│    ├─ AuthService - 认证逻辑                                   │
│    ├─ EmailService - 邮件发送 (SMTP/Sendgrid)                  │
│    ├─ TokenService - JWT Token 生成和验证                      │
│    └─ UserService - 用户管理                                   │
│                                                                  │
│  Data Storage                                                    │
│    ├─ users.json - 用户数据 (后续可迁移到 MongoDB)             │
│    └─ verification_codes.json - 验证码缓存 (后续可用 Redis)    │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📊 数据模型设计

### 1. User 模型 (统一用户模型)

```python
class User(BaseModel):
    """用户数据模型 - V1.3"""
    user_id: str                    # UUID
    email: Optional[str] = None     # 邮箱 (可选，Apple登录可能没有)
    email_verified: bool = False    # 邮箱是否验证
    login_type: LoginType           # 登录方式 (email_code / apple)
    apple_id: Optional[str] = None  # Apple ID (可选)

    # V1.2 用户档案数据 (集成)
    device_id: Optional[str] = None
    learning_goal: Optional[str] = None
    english_level: Optional[str] = None
    age_group: Optional[str] = None

    # 时间戳
    created_at: datetime
    last_login_at: datetime

    # 扩展字段 (预留)
    phone: Optional[str] = None
    wechat_openid: Optional[str] = None
    google_id: Optional[str] = None
```

### 2. LoginType 枚举

```python
class LoginType(str, Enum):
    EMAIL_CODE = "email_code"   # 邮箱验证码
    APPLE = "apple"             # Apple ID
    PHONE_CODE = "phone_code"   # 手机验证码 (预留)
    WECHAT = "wechat"           # 微信登录 (预留)
    GOOGLE = "google"           # Google 登录 (预留)
```

### 3. VerificationCode 模型

```python
class VerificationCode(BaseModel):
    """验证码模型"""
    email: str
    code: str                   # 6位数字
    expires_at: datetime        # 过期时间 (5分钟)
    created_at: datetime
    used: bool = False          # 是否已使用
```

---

## 🔐 Token 管理设计

### JWT Token 结构

```json
{
  "user_id": "uuid",
  "email": "user@example.com",
  "exp": 1234567890,  // 过期时间 (7天)
  "iat": 1234567890   // 签发时间
}
```

### Token 生成和验证

```python
# backend/services/token_service.py

import jwt
from datetime import datetime, timedelta

SECRET_KEY = "your-secret-key"  # 应从环境变量读取
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_DAYS = 7

def create_access_token(user_id: str, email: str) -> str:
    """创建 JWT Token"""
    expire = datetime.utcnow() + timedelta(days=ACCESS_TOKEN_EXPIRE_DAYS)
    payload = {
        "user_id": user_id,
        "email": email,
        "exp": expire,
        "iat": datetime.utcnow()
    }
    return jwt.encode(payload, SECRET_KEY, algorithm=ALGORITHM)

def verify_token(token: str) -> dict:
    """验证 Token"""
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        return payload
    except jwt.ExpiredSignatureError:
        raise Exception("Token 已过期")
    except jwt.JWTError:
        raise Exception("Token 无效")
```

---

## 🔄 核心流程设计

### 1. 邮箱验证码登录流程

```
用户输入邮箱
  ↓
点击"发送验证码"
  ↓
POST /api/auth/send-code
  ├─ 后端生成6位随机数字
  ├─ 保存到 verification_codes.json (有效期5分钟)
  ├─ 发送邮件 (EmailService)
  └─ 返回成功响应
  ↓
前端显示倒计时 (60秒)
  ↓
用户输入验证码
  ↓
点击"登录"
  ↓
POST /api/auth/login-code
  ├─ 后端验证验证码是否正确
  ├─ 验证验证码是否过期
  ├─ 验证验证码是否已使用
  ├─ 检查用户是否存在
  │   ├─ 不存在 → 创建新用户
  │   └─ 存在 → 更新 last_login_at
  ├─ 生成 JWT Token
  └─ 返回 Token + 用户信息
  ↓
前端保存 Token 到 SecureStorage
  ↓
GET /api/user/me (验证 Token)
  ↓
跳转到主界面
```

### 2. App 启动流程 (含登录状态检查)

```
App 启动
  ↓
检查本地是否有 Token
  ├─ 无 Token
  │   └─ 跳转到 LoginPage
  │
  └─ 有 Token
      ↓
      GET /api/user/me (携带 Token)
      ├─ 成功 (200)
      │   ├─ 检查用户是否有 english_level
      │   │   ├─ 有 → 跳转到 ChatPage
      │   │   └─ 无 → 跳转到 WelcomePage (V1.2 引导流程)
      │   └─
      └─ 失败 (401)
          ├─ Token 过期或无效
          └─ 跳转到 LoginPage
```

### 3. 与 V1.2 数据整合流程

```
用户首次登录 (邮箱验证码)
  ↓
创建 User 记录 (无 english_level)
  ↓
GET /api/user/me
  ├─ english_level 为空
  └─ 前端检测到需要引导
  ↓
跳转到 WelcomePage (V1.2)
  ↓
完成用户档案表单
  ↓
PUT /api/user/me (更新 english_level 等字段)
  ↓
保存到用户记录
  ↓
跳转到 ChatPage
```

---

## 📡 API 接口详细设计

### 1. POST /api/auth/send-code

**请求**:
```json
{
  "email": "user@example.com"
}
```

**响应**:
```json
{
  "success": true,
  "message": "验证码已发送",
  "expires_in": 300  // 5分钟
}
```

**错误响应**:
```json
{
  "success": false,
  "message": "发送频繁，请60秒后再试"
}
```

**业务逻辑**:
- 验证邮箱格式
- 检查冷却时间 (60秒)
- 生成6位随机数字
- 保存到缓存 (有效期5分钟)
- 发送邮件
- 返回成功响应

---

### 2. POST /api/auth/login-code

**请求**:
```json
{
  "email": "user@example.com",
  "code": "123456"
}
```

**成功响应**:
```json
{
  "success": true,
  "token": "eyJhbGciOiJIUzI1NiIs...",
  "user": {
    "user_id": "uuid",
    "email": "user@example.com",
    "email_verified": true,
    "login_type": "email_code",
    "english_level": "B1",  // 可能为 null
    "created_at": "2025-01-17T10:00:00Z",
    "last_login_at": "2025-01-17T10:00:00Z"
  }
}
```

**错误响应**:
```json
{
  "success": false,
  "message": "验证码错误或已过期"
}
```

**业务逻辑**:
- 验证邮箱格式
- 查询验证码记录
- 验证验证码是否正确
- 验证验证码是否过期
- 验证验证码是否已使用
- 标记验证码为已使用
- 检查用户是否存在
  - 不存在: 创建新用户 (email_verified=true)
  - 存在: 更新 last_login_at
- 生成 JWT Token
- 返回 Token + 用户信息

---

### 3. GET /api/user/me

**请求头**:
```
Authorization: Bearer <token>
```

**成功响应**:
```json
{
  "success": true,
  "user": {
    "user_id": "uuid",
    "email": "user@example.com",
    "email_verified": true,
    "login_type": "email_code",
    "learning_goal": "business",
    "english_level": "B1",
    "age_group": "21-30",
    "created_at": "2025-01-17T10:00:00Z",
    "last_login_at": "2025-01-17T10:00:00Z"
  }
}
```

**错误响应** (401):
```json
{
  "detail": "Token 无效或已过期"
}
```

**业务逻辑**:
- 从 Authorization 头提取 Token
- 验证 Token 有效性
- 解析 Token 获取 user_id
- 查询用户信息
- 返回用户信息

---

### 4. PUT /api/user/me (更新用户信息)

**请求头**:
```
Authorization: Bearer <token>
```

**请求体**:
```json
{
  "learning_goal": "business",
  "english_level": "B1",
  "age_group": "21-30"
}
```

**成功响应**:
```json
{
  "success": true,
  "user": { /* 更新后的用户信息 */ }
}
```

---

### 5. POST /api/auth/login-apple (预留)

**请求**:
```json
{
  "apple_id_token": "xxx",
  "apple_user_id": "xxx"
}
```

**成功响应**:
```json
{
  "success": true,
  "token": "...",
  "user": { /* 用户信息 */ }
}
```

---

## 📁 文件结构设计

### 后端文件结构

```
backend/
├── models/
│   ├── user.py                    # User 模型 (统一)
│   └── verification_code.py       # 验证码模型
│
├── routers/
│   ├── auth.py                    # 认证路由
│   └── user.py                    # 用户路由 (扩展 V1.2)
│
├── services/
│   ├── auth_service.py            # 认证服务
│   ├── email_service.py           # 邮件发送服务
│   ├── token_service.py           # JWT Token 服务
│   ├── user_service.py            # 用户管理服务
│   └── verification_code_service.py  # 验证码管理
│
├── utils/
│   ├── jwt_helper.py              # JWT 工具类
│   └── email_helper.py            # 邮件发送工具
│
├── middleware/
│   └── auth_middleware.py         # 认证中间件
│
└── data/
    ├── users.json                 # 用户数据
    └── verification_codes.json    # 验证码缓存
```

### 前端文件结构

```
frontend/lib/
├── models/
│   └── user.dart                  # User 模型 (统一)
│
├── pages/
│   └── auth/
│       ├── login_page.dart        # 登录/注册页
│       ├── email_input.dart       # 邮箱输入组件
│       └── code_input.dart        # 验证码输入组件
│
├── services/
│   ├── auth_service.dart          # 认证服务
│   └── storage_service.dart       # 本地存储服务 (Token)
│
└── utils/
    └── auth_interceptor.dart      # HTTP 拦截器 (自动添加 Token)
```

---

## 🔒 安全设计

### 1. 验证码安全
- **有效期**: 5 分钟
- **冷却时间**: 60 秒
- **单次使用**: 验证后标记为已使用
- **随机性**: 使用 secrets 模块生成

### 2. Token 安全
- **算法**: HS256 (HMAC with SHA-256)
- **密钥**: 从环境变量读取，不硬编码
- **有效期**: 7 天
- **存储**: 前端使用 flutter_secure_storage

### 3. API 安全
- **HTTPS**: 生产环境强制 HTTPS
- **CORS**: 配置允许的来源
- **Rate Limiting**: 防止暴力破解 (预留)

---

## 📝 数据迁移策略

### V1.2 → V1.3 数据迁移

**现状**:
- V1.2: `user_profiles.json` 存储用户档案 (user_id, device_id, learning_goal, english_level, age_group)

**迁移方案**:
1. **保留 V1.2 数据文件**: 不删除 `user_profiles.json`
2. **创建新的 users.json**: 存储完整用户信息 (包含认证信息)
3. **数据整合**: 登录后，如果用户已有 V1.2 档案，自动关联
4. **关联逻辑**:
   - 用户登录后，检查 device_id 是否在 `user_profiles.json` 中存在
   - 如果存在，将 learning_goal, english_level, age_group 迁移到 `users.json`
   - 标记 V1.2 数据为已迁移

---

## 🧪 测试计划

### 后端测试
1. ✅ 发送验证码接口测试
2. ✅ 验证码登录接口测试
3. ✅ Token 生成和验证测试
4. ✅ 获取用户信息接口测试
5. ✅ 验证码过期测试
6. ✅ 验证码冷却测试

### 前端测试
1. ✅ 登录页面 UI 测试
2. ✅ 邮箱格式验证测试
3. ✅ 验证码倒计时测试
4. ✅ 登录流程测试
5. ✅ Token 存储和读取测试
6. ✅ 启动流程测试

### 集成测试
1. ✅ 完整登录流程测试
2. ✅ 自动登录测试
3. ✅ Token 过期处理测试
4. ✅ V1.2 数据整合测试

---

## 📋 开发任务清单

### 后端开发
- [ ] 创建 User 数据模型
- [ ] 创建 VerificationCode 数据模型
- [ ] 实现 TokenService (JWT)
- [ ] 实现 EmailService (邮件发送)
- [ ] 实现 VerificationCodeService (验证码管理)
- [ ] 实现 AuthService (认证逻辑)
- [ ] 实现 POST /api/auth/send-code
- [ ] 实现 POST /api/auth/login-code
- [ ] 实现 GET /api/user/me
- [ ] 实现 PUT /api/user/me
- [ ] 实现认证中间件
- [ ] 编写后端测试脚本

### 前端开发
- [ ] 创建 User 模型
- [ ] 创建 LoginPage UI
- [ ] 实现 AuthService
- [ ] 实现 StorageService (Token 存储)
- [ ] 实现邮箱验证码登录流程
- [ ] 修改 main.dart 启动流程
- [ ] 实现 HTTP 拦截器 (自动添加 Token)
- [ ] 整合 V1.2 用户档案流程

### 集成与测试
- [ ] 前后端联调测试
- [ ] 完整登录流程测试
- [ ] V1.2 数据迁移测试
- [ ] 编写开发文档

---

## 🎯 里程碑

| 阶段 | 完成标准 | 预计时间 |
|------|----------|----------|
| 架构设计 | 完成本文档 | ✅ 完成 |
| 后端开发 | 所有 API 接口实现并测试通过 | 2-3 小时 |
| 前端开发 | 登录页面和认证流程完成 | 2-3 小时 |
| 集成测试 | 完整流程测试通过 | 1 小时 |
| 文档编写 | 完整的开发文档 | 1 小时 |

---

**文档编写**: Claude Code
**设计时间**: 2025-01-17
**版本**: V1.3
**状态**: ✅ 设计完成
