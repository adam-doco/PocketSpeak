# PocketSpeak V1.3 用户登录与注册系统开发文档

**开发日期**: 2025-01-17
**版本**: V1.3
**开发者**: Claude
**任务状态**: ✅ 已完成

---

## 📋 任务概述

本次开发实现了 PocketSpeak V1.3 版本的完整用户登录与注册系统，包括：

- ✅ 邮箱验证码登录
- ✅ JWT Token 认证机制
- ✅ 用户账户管理
- ✅ 登录状态持久化
- ✅ 前后端完整对接
- 🔜 Apple ID 登录（预留接口）

---

## 📁 新增/修改文件清单

### 后端文件

#### 1. **数据模型** - `backend/models/user_model.py`
- 创建统一的 User 数据模型，整合 V1.2 和 V1.3 需求
- 包含字段：user_id, email, email_verified, login_type, device_id, english_level, age_range, purpose
- 定义枚举类型：LoginType, EnglishLevel, AgeRange

#### 2. **安全模块** - `backend/core/security.py`
- JWT Token 生成：`create_access_token(user_id, email)`
- JWT Token 验证：`verify_token(token)`
- Token 有效期：24小时
- 算法：HS256

#### 3. **邮件发送工具** - `backend/utils/email_sender.py`
- 发送验证码邮件：`send_verification_code(email, code)`
- 当前为开发模式（控制台打印），预留生产环境接入

#### 4. **认证服务** - `backend/services/auth_service.py`
- 生成6位随机验证码
- 发送验证码（60秒冷却）
- 验证码验证（5分钟有效期，一次性使用）
- 邮箱验证码登录（自动创建新用户）
- 用户 CRUD 操作

#### 5. **依赖注入** - `backend/deps/dependencies.py`
- `get_current_user()`: 从 Bearer Token 获取当前登录用户
- `get_current_user_optional()`: 可选认证

#### 6. **认证路由** - `backend/routers/auth_router.py`
- `POST /api/auth/send-code`: 发送验证码
- `POST /api/auth/login-code`: 验证码登录
- `POST /api/auth/login-apple`: Apple 登录（预留）
- `POST /api/auth/logout`: 登出

#### 7. **用户路由扩展** - `backend/routers/user.py`
- `GET /api/user/me`: 获取当前登录用户信息（需要认证）

#### 8. **主程序** - `backend/main.py`
- 注册 auth_router

#### 9. **测试脚本** - `backend/test_auth_api.py`
- 完整的 API 测试脚本，包含7个测试用例

### 前端文件

#### 10. **认证服务** - `frontend/pocketspeak_app/lib/services/auth_service.dart`
- 发送验证码：`sendVerificationCode(email)`
- 登录：`loginWithEmailCode(email, code)`
- 获取当前用户：`getCurrentUser()`
- 登出：`logout()`
- Token 管理（SharedPreferences）
- 登录状态检查：`isLoggedIn()`

#### 11. **登录页面** - `frontend/pocketspeak_app/lib/pages/auth/login_page.dart`
- 邮箱输入框（格式验证）
- 验证码输入框（6位数字）
- 获取验证码按钮（60秒倒计时）
- 登录按钮（loading 状态）
- Apple 登录按钮（预留）
- 完整的错误提示和用户反馈

#### 12. **启动流程** - `frontend/pocketspeak_app/lib/main.dart`
- 新增登录状态检查
- 启动流程：登录检查 → 引导流程 → 设备激活 → 聊天页面

---

## 🔑 核心技术实现

### 1. JWT Token 认证流程

```
用户输入邮箱 → 后端发送验证码（60秒冷却）
↓
用户输入验证码 → 后端验证（5分钟有效，一次性使用）
↓
验证成功 → 生成 JWT Token（24小时有效）
↓
前端存储 Token（SharedPreferences）
↓
后续请求携带 Bearer Token → 后端验证并返回用户信息
```

### 2. 验证码安全机制

- **60秒发送冷却**: 防止频繁发送
- **5分钟有效期**: 限制使用时间
- **一次性使用**: 验证后立即标记为已使用
- **6位随机数字**: 使用 `secrets.randbelow()` 生成

### 3. 用户数据存储

当前使用 JSON 文件存储（V1.3 开发阶段）：
- `backend/data/users.json`: 用户数据
- `backend/data/verification_codes.json`: 验证码数据

**注意**: 生产环境应迁移到数据库（PostgreSQL / MySQL）

### 4. 前端认证状态管理

```dart
// 登录状态检查
Future<bool> isLoggedIn() async {
  final token = await getToken();
  if (token == null) return false;

  // 验证 Token 是否有效
  final user = await getCurrentUser();
  return user != null;
}
```

---

## 🧪 测试说明

### 后端 API 测试

运行测试脚本：

```bash
cd backend
python test_auth_api.py
```

测试内容：
1. ✅ 发送验证码
2. ✅ 验证冷却机制
3. ✅ 错误的验证码
4. ✅ 正确的验证码登录
5. ✅ 获取当前用户信息（需要认证）
6. ✅ 未认证访问
7. ✅ 登出

### 前后端联调测试

1. 启动后端服务：
```bash
cd backend
python main.py
```

2. 启动前端应用：
```bash
cd frontend/pocketspeak_app
flutter run
```

3. 测试流程：
   - App 启动 → 显示登录页面
   - 输入邮箱 → 点击"获取验证码"
   - 查看后端控制台获取验证码
   - 输入验证码 → 点击"登录"
   - 登录成功 → 根据 english_level 跳转到对应页面

---

## 🎯 API 端点总览

### 认证相关

| 方法 | 端点 | 说明 | 认证 |
|------|------|------|------|
| POST | `/api/auth/send-code` | 发送验证码 | ❌ |
| POST | `/api/auth/login-code` | 验证码登录 | ❌ |
| POST | `/api/auth/login-apple` | Apple 登录（预留） | ❌ |
| POST | `/api/auth/logout` | 登出 | ❌ |

### 用户相关

| 方法 | 端点 | 说明 | 认证 |
|------|------|------|------|
| GET | `/api/user/me` | 获取当前用户信息 | ✅ |
| POST | `/api/user/init` | 创建用户档案（V1.2） | ❌ |
| GET | `/api/user/{user_id}` | 获取用户档案（V1.2） | ❌ |

---

## 📊 数据模型

### User 模型

```python
{
  "user_id": "uuid",
  "email": "user@example.com",
  "email_verified": true,
  "login_type": "email_code",
  "device_id": "device-uuid",
  "english_level": "B1",
  "age_range": "18-25",
  "purpose": "travel",
  "created_at": "2025-01-17T10:00:00",
  "updated_at": "2025-01-17T10:00:00",
  "last_login_at": "2025-01-17T10:00:00"
}
```

### LoginCode Response

```json
{
  "success": true,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "user_id": "uuid",
    "email": "user@example.com",
    "email_verified": true,
    "english_level": "B1"
  }
}
```

---

## 🚀 部署注意事项

### 1. 环境变量配置

```bash
# JWT 密钥（必须修改！）
export JWT_SECRET_KEY="your-secret-key-change-in-production"

# 邮件服务商配置（生产环境）
export SENDGRID_API_KEY="your-sendgrid-api-key"
```

### 2. 数据库迁移

生产环境建议使用数据库替代 JSON 文件存储：
- 用户表：users
- 验证码表：verification_codes（带过期时间索引）

### 3. 邮件服务接入

在 `backend/utils/email_sender.py` 中接入真实邮件服务：
- Sendgrid
- AWS SES
- 阿里云邮件服务

### 4. HTTPS 配置

生产环境必须使用 HTTPS，确保 Token 传输安全。

---

## 🔄 与 V1.2 的集成

V1.3 与 V1.2 完美集成：

1. **统一用户模型**: V1.3 的 User 模型包含 V1.2 的所有字段
2. **启动流程整合**: 登录 → 引导流程（V1.2） → 设备激活 → 聊天页面
3. **数据互通**: 登录后可以继续使用 V1.2 的用户档案功能

---

## ⚠️ 已知限制

1. **邮件发送**: 当前为开发模式（控制台打印），需接入真实邮件服务
2. **Apple 登录**: 接口已预留，功能未实现
3. **数据存储**: 使用 JSON 文件，生产环境需迁移到数据库
4. **Token 黑名单**: 未实现 Token 黑名单机制（登出后 Token 仍然有效直到过期）

---

## 📝 后续优化建议

1. **接入真实邮件服务** (Sendgrid / AWS SES)
2. **数据库迁移** (PostgreSQL / MySQL)
3. **实现 Apple ID 登录**
4. **添加 Token 刷新机制**
5. **实现 Token 黑名单**
6. **添加登录日志记录**
7. **实现密码登录（可选）**
8. **添加手机号验证码登录（可选）**

---

## ✅ 开发完成检查清单

- [x] 后端数据模型创建
- [x] JWT Token 生成和验证
- [x] 邮件发送工具实现
- [x] 认证服务实现
- [x] 认证路由实现
- [x] 获取当前用户依赖注入
- [x] 路由注册到 main.py
- [x] 扩展 user.py 添加 /me 端点
- [x] 后端测试脚本编写
- [x] 前端认证服务实现
- [x] 登录页面 UI 创建
- [x] 修改 main.dart 启动流程
- [x] 开发文档编写

---

## 📚 相关文档

- PRD: `backend_claude_memory/specs/pocketspeak_PRD_v1.3.md`
- 后端提示词: `backend_claude_memory/prompts/v1.3_auth_backend_prompt.md`
- 前端提示词: `frontend_claude_memory/prompts/v1.3_auth_ui_prompt.md`
- 架构设计: `claude_workspace/20250117_v1.3_architecture_design.md`

---

**开发完成时间**: 2025-01-17
**总开发时长**: 约 2 小时
**代码质量**: ✅ 已通过基本测试
**下一步**: 前后端联调测试 → 生产环境部署准备
