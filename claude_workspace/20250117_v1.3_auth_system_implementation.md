# PocketSpeak V1.3 ç”¨æˆ·ç™»å½•ä¸æ³¨å†Œç³»ç»Ÿå¼€å‘æ–‡æ¡£

**å¼€å‘æ—¥æœŸ**: 2025-01-17
**ç‰ˆæœ¬**: V1.3
**å¼€å‘è€…**: Claude
**ä»»åŠ¡çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

æœ¬æ¬¡å¼€å‘å®ç°äº† PocketSpeak V1.3 ç‰ˆæœ¬çš„å®Œæ•´ç”¨æˆ·ç™»å½•ä¸æ³¨å†Œç³»ç»Ÿï¼ŒåŒ…æ‹¬ï¼š

- âœ… é‚®ç®±éªŒè¯ç ç™»å½•
- âœ… JWT Token è®¤è¯æœºåˆ¶
- âœ… ç”¨æˆ·è´¦æˆ·ç®¡ç†
- âœ… ç™»å½•çŠ¶æ€æŒä¹…åŒ–
- âœ… å‰åç«¯å®Œæ•´å¯¹æ¥
- ğŸ”œ Apple ID ç™»å½•ï¼ˆé¢„ç•™æ¥å£ï¼‰

---

## ğŸ“ æ–°å¢/ä¿®æ”¹æ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶

#### 1. **æ•°æ®æ¨¡å‹** - `backend/models/user_model.py`
- åˆ›å»ºç»Ÿä¸€çš„ User æ•°æ®æ¨¡å‹ï¼Œæ•´åˆ V1.2 å’Œ V1.3 éœ€æ±‚
- åŒ…å«å­—æ®µï¼šuser_id, email, email_verified, login_type, device_id, english_level, age_range, purpose
- å®šä¹‰æšä¸¾ç±»å‹ï¼šLoginType, EnglishLevel, AgeRange

#### 2. **å®‰å…¨æ¨¡å—** - `backend/core/security.py`
- JWT Token ç”Ÿæˆï¼š`create_access_token(user_id, email)`
- JWT Token éªŒè¯ï¼š`verify_token(token)`
- Token æœ‰æ•ˆæœŸï¼š24å°æ—¶
- ç®—æ³•ï¼šHS256

#### 3. **é‚®ä»¶å‘é€å·¥å…·** - `backend/utils/email_sender.py`
- å‘é€éªŒè¯ç é‚®ä»¶ï¼š`send_verification_code(email, code)`
- å½“å‰ä¸ºå¼€å‘æ¨¡å¼ï¼ˆæ§åˆ¶å°æ‰“å°ï¼‰ï¼Œé¢„ç•™ç”Ÿäº§ç¯å¢ƒæ¥å…¥

#### 4. **è®¤è¯æœåŠ¡** - `backend/services/auth_service.py`
- ç”Ÿæˆ6ä½éšæœºéªŒè¯ç 
- å‘é€éªŒè¯ç ï¼ˆ60ç§’å†·å´ï¼‰
- éªŒè¯ç éªŒè¯ï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆæœŸï¼Œä¸€æ¬¡æ€§ä½¿ç”¨ï¼‰
- é‚®ç®±éªŒè¯ç ç™»å½•ï¼ˆè‡ªåŠ¨åˆ›å»ºæ–°ç”¨æˆ·ï¼‰
- ç”¨æˆ· CRUD æ“ä½œ

#### 5. **ä¾èµ–æ³¨å…¥** - `backend/deps/dependencies.py`
- `get_current_user()`: ä» Bearer Token è·å–å½“å‰ç™»å½•ç”¨æˆ·
- `get_current_user_optional()`: å¯é€‰è®¤è¯

#### 6. **è®¤è¯è·¯ç”±** - `backend/routers/auth_router.py`
- `POST /api/auth/send-code`: å‘é€éªŒè¯ç 
- `POST /api/auth/login-code`: éªŒè¯ç ç™»å½•
- `POST /api/auth/login-apple`: Apple ç™»å½•ï¼ˆé¢„ç•™ï¼‰
- `POST /api/auth/logout`: ç™»å‡º

#### 7. **ç”¨æˆ·è·¯ç”±æ‰©å±•** - `backend/routers/user.py`
- `GET /api/user/me`: è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼ˆéœ€è¦è®¤è¯ï¼‰

#### 8. **ä¸»ç¨‹åº** - `backend/main.py`
- æ³¨å†Œ auth_router

#### 9. **æµ‹è¯•è„šæœ¬** - `backend/test_auth_api.py`
- å®Œæ•´çš„ API æµ‹è¯•è„šæœ¬ï¼ŒåŒ…å«7ä¸ªæµ‹è¯•ç”¨ä¾‹

### å‰ç«¯æ–‡ä»¶

#### 10. **è®¤è¯æœåŠ¡** - `frontend/pocketspeak_app/lib/services/auth_service.dart`
- å‘é€éªŒè¯ç ï¼š`sendVerificationCode(email)`
- ç™»å½•ï¼š`loginWithEmailCode(email, code)`
- è·å–å½“å‰ç”¨æˆ·ï¼š`getCurrentUser()`
- ç™»å‡ºï¼š`logout()`
- Token ç®¡ç†ï¼ˆSharedPreferencesï¼‰
- ç™»å½•çŠ¶æ€æ£€æŸ¥ï¼š`isLoggedIn()`

#### 11. **ç™»å½•é¡µé¢** - `frontend/pocketspeak_app/lib/pages/auth/login_page.dart`
- é‚®ç®±è¾“å…¥æ¡†ï¼ˆæ ¼å¼éªŒè¯ï¼‰
- éªŒè¯ç è¾“å…¥æ¡†ï¼ˆ6ä½æ•°å­—ï¼‰
- è·å–éªŒè¯ç æŒ‰é’®ï¼ˆ60ç§’å€’è®¡æ—¶ï¼‰
- ç™»å½•æŒ‰é’®ï¼ˆloading çŠ¶æ€ï¼‰
- Apple ç™»å½•æŒ‰é’®ï¼ˆé¢„ç•™ï¼‰
- å®Œæ•´çš„é”™è¯¯æç¤ºå’Œç”¨æˆ·åé¦ˆ

#### 12. **å¯åŠ¨æµç¨‹** - `frontend/pocketspeak_app/lib/main.dart`
- æ–°å¢ç™»å½•çŠ¶æ€æ£€æŸ¥
- å¯åŠ¨æµç¨‹ï¼šç™»å½•æ£€æŸ¥ â†’ å¼•å¯¼æµç¨‹ â†’ è®¾å¤‡æ¿€æ´» â†’ èŠå¤©é¡µé¢

---

## ğŸ”‘ æ ¸å¿ƒæŠ€æœ¯å®ç°

### 1. JWT Token è®¤è¯æµç¨‹

```
ç”¨æˆ·è¾“å…¥é‚®ç®± â†’ åç«¯å‘é€éªŒè¯ç ï¼ˆ60ç§’å†·å´ï¼‰
â†“
ç”¨æˆ·è¾“å…¥éªŒè¯ç  â†’ åç«¯éªŒè¯ï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆï¼Œä¸€æ¬¡æ€§ä½¿ç”¨ï¼‰
â†“
éªŒè¯æˆåŠŸ â†’ ç”Ÿæˆ JWT Tokenï¼ˆ24å°æ—¶æœ‰æ•ˆï¼‰
â†“
å‰ç«¯å­˜å‚¨ Tokenï¼ˆSharedPreferencesï¼‰
â†“
åç»­è¯·æ±‚æºå¸¦ Bearer Token â†’ åç«¯éªŒè¯å¹¶è¿”å›ç”¨æˆ·ä¿¡æ¯
```

### 2. éªŒè¯ç å®‰å…¨æœºåˆ¶

- **60ç§’å‘é€å†·å´**: é˜²æ­¢é¢‘ç¹å‘é€
- **5åˆ†é’Ÿæœ‰æ•ˆæœŸ**: é™åˆ¶ä½¿ç”¨æ—¶é—´
- **ä¸€æ¬¡æ€§ä½¿ç”¨**: éªŒè¯åç«‹å³æ ‡è®°ä¸ºå·²ä½¿ç”¨
- **6ä½éšæœºæ•°å­—**: ä½¿ç”¨ `secrets.randbelow()` ç”Ÿæˆ

### 3. ç”¨æˆ·æ•°æ®å­˜å‚¨

å½“å‰ä½¿ç”¨ JSON æ–‡ä»¶å­˜å‚¨ï¼ˆV1.3 å¼€å‘é˜¶æ®µï¼‰ï¼š
- `backend/data/users.json`: ç”¨æˆ·æ•°æ®
- `backend/data/verification_codes.json`: éªŒè¯ç æ•°æ®

**æ³¨æ„**: ç”Ÿäº§ç¯å¢ƒåº”è¿ç§»åˆ°æ•°æ®åº“ï¼ˆPostgreSQL / MySQLï¼‰

### 4. å‰ç«¯è®¤è¯çŠ¶æ€ç®¡ç†

```dart
// ç™»å½•çŠ¶æ€æ£€æŸ¥
Future<bool> isLoggedIn() async {
  final token = await getToken();
  if (token == null) return false;

  // éªŒè¯ Token æ˜¯å¦æœ‰æ•ˆ
  final user = await getCurrentUser();
  return user != null;
}
```

---

## ğŸ§ª æµ‹è¯•è¯´æ˜

### åç«¯ API æµ‹è¯•

è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š

```bash
cd backend
python test_auth_api.py
```

æµ‹è¯•å†…å®¹ï¼š
1. âœ… å‘é€éªŒè¯ç 
2. âœ… éªŒè¯å†·å´æœºåˆ¶
3. âœ… é”™è¯¯çš„éªŒè¯ç 
4. âœ… æ­£ç¡®çš„éªŒè¯ç ç™»å½•
5. âœ… è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆéœ€è¦è®¤è¯ï¼‰
6. âœ… æœªè®¤è¯è®¿é—®
7. âœ… ç™»å‡º

### å‰åç«¯è”è°ƒæµ‹è¯•

1. å¯åŠ¨åç«¯æœåŠ¡ï¼š
```bash
cd backend
python main.py
```

2. å¯åŠ¨å‰ç«¯åº”ç”¨ï¼š
```bash
cd frontend/pocketspeak_app
flutter run
```

3. æµ‹è¯•æµç¨‹ï¼š
   - App å¯åŠ¨ â†’ æ˜¾ç¤ºç™»å½•é¡µé¢
   - è¾“å…¥é‚®ç®± â†’ ç‚¹å‡»"è·å–éªŒè¯ç "
   - æŸ¥çœ‹åç«¯æ§åˆ¶å°è·å–éªŒè¯ç 
   - è¾“å…¥éªŒè¯ç  â†’ ç‚¹å‡»"ç™»å½•"
   - ç™»å½•æˆåŠŸ â†’ æ ¹æ® english_level è·³è½¬åˆ°å¯¹åº”é¡µé¢

---

## ğŸ¯ API ç«¯ç‚¹æ€»è§ˆ

### è®¤è¯ç›¸å…³

| æ–¹æ³• | ç«¯ç‚¹ | è¯´æ˜ | è®¤è¯ |
|------|------|------|------|
| POST | `/api/auth/send-code` | å‘é€éªŒè¯ç  | âŒ |
| POST | `/api/auth/login-code` | éªŒè¯ç ç™»å½• | âŒ |
| POST | `/api/auth/login-apple` | Apple ç™»å½•ï¼ˆé¢„ç•™ï¼‰ | âŒ |
| POST | `/api/auth/logout` | ç™»å‡º | âŒ |

### ç”¨æˆ·ç›¸å…³

| æ–¹æ³• | ç«¯ç‚¹ | è¯´æ˜ | è®¤è¯ |
|------|------|------|------|
| GET | `/api/user/me` | è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ | âœ… |
| POST | `/api/user/init` | åˆ›å»ºç”¨æˆ·æ¡£æ¡ˆï¼ˆV1.2ï¼‰ | âŒ |
| GET | `/api/user/{user_id}` | è·å–ç”¨æˆ·æ¡£æ¡ˆï¼ˆV1.2ï¼‰ | âŒ |

---

## ğŸ“Š æ•°æ®æ¨¡å‹

### User æ¨¡å‹

```python
{
  "user_id": "uuid",
  "email": "user@example.com",
  "email_verified": true,
  "login_type": "email_code",
  "device_id": "device-uuid",
  "english_level": "B1",
  "age_range": "18-25",
  "purpose": "travel",
  "created_at": "2025-01-17T10:00:00",
  "updated_at": "2025-01-17T10:00:00",
  "last_login_at": "2025-01-17T10:00:00"
}
```

### LoginCode Response

```json
{
  "success": true,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "user_id": "uuid",
    "email": "user@example.com",
    "email_verified": true,
    "english_level": "B1"
  }
}
```

---

## ğŸš€ éƒ¨ç½²æ³¨æ„äº‹é¡¹

### 1. ç¯å¢ƒå˜é‡é…ç½®

```bash
# JWT å¯†é’¥ï¼ˆå¿…é¡»ä¿®æ”¹ï¼ï¼‰
export JWT_SECRET_KEY="your-secret-key-change-in-production"

# é‚®ä»¶æœåŠ¡å•†é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
export SENDGRID_API_KEY="your-sendgrid-api-key"
```

### 2. æ•°æ®åº“è¿ç§»

ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨æ•°æ®åº“æ›¿ä»£ JSON æ–‡ä»¶å­˜å‚¨ï¼š
- ç”¨æˆ·è¡¨ï¼šusers
- éªŒè¯ç è¡¨ï¼šverification_codesï¼ˆå¸¦è¿‡æœŸæ—¶é—´ç´¢å¼•ï¼‰

### 3. é‚®ä»¶æœåŠ¡æ¥å…¥

åœ¨ `backend/utils/email_sender.py` ä¸­æ¥å…¥çœŸå®é‚®ä»¶æœåŠ¡ï¼š
- Sendgrid
- AWS SES
- é˜¿é‡Œäº‘é‚®ä»¶æœåŠ¡

### 4. HTTPS é…ç½®

ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPSï¼Œç¡®ä¿ Token ä¼ è¾“å®‰å…¨ã€‚

---

## ğŸ”„ ä¸ V1.2 çš„é›†æˆ

V1.3 ä¸ V1.2 å®Œç¾é›†æˆï¼š

1. **ç»Ÿä¸€ç”¨æˆ·æ¨¡å‹**: V1.3 çš„ User æ¨¡å‹åŒ…å« V1.2 çš„æ‰€æœ‰å­—æ®µ
2. **å¯åŠ¨æµç¨‹æ•´åˆ**: ç™»å½• â†’ å¼•å¯¼æµç¨‹ï¼ˆV1.2ï¼‰ â†’ è®¾å¤‡æ¿€æ´» â†’ èŠå¤©é¡µé¢
3. **æ•°æ®äº’é€š**: ç™»å½•åå¯ä»¥ç»§ç»­ä½¿ç”¨ V1.2 çš„ç”¨æˆ·æ¡£æ¡ˆåŠŸèƒ½

---

## âš ï¸ å·²çŸ¥é™åˆ¶

1. **é‚®ä»¶å‘é€**: å½“å‰ä¸ºå¼€å‘æ¨¡å¼ï¼ˆæ§åˆ¶å°æ‰“å°ï¼‰ï¼Œéœ€æ¥å…¥çœŸå®é‚®ä»¶æœåŠ¡
2. **Apple ç™»å½•**: æ¥å£å·²é¢„ç•™ï¼ŒåŠŸèƒ½æœªå®ç°
3. **æ•°æ®å­˜å‚¨**: ä½¿ç”¨ JSON æ–‡ä»¶ï¼Œç”Ÿäº§ç¯å¢ƒéœ€è¿ç§»åˆ°æ•°æ®åº“
4. **Token é»‘åå•**: æœªå®ç° Token é»‘åå•æœºåˆ¶ï¼ˆç™»å‡ºå Token ä»ç„¶æœ‰æ•ˆç›´åˆ°è¿‡æœŸï¼‰

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

1. **æ¥å…¥çœŸå®é‚®ä»¶æœåŠ¡** (Sendgrid / AWS SES)
2. **æ•°æ®åº“è¿ç§»** (PostgreSQL / MySQL)
3. **å®ç° Apple ID ç™»å½•**
4. **æ·»åŠ  Token åˆ·æ–°æœºåˆ¶**
5. **å®ç° Token é»‘åå•**
6. **æ·»åŠ ç™»å½•æ—¥å¿—è®°å½•**
7. **å®ç°å¯†ç ç™»å½•ï¼ˆå¯é€‰ï¼‰**
8. **æ·»åŠ æ‰‹æœºå·éªŒè¯ç ç™»å½•ï¼ˆå¯é€‰ï¼‰**

---

## âœ… å¼€å‘å®Œæˆæ£€æŸ¥æ¸…å•

- [x] åç«¯æ•°æ®æ¨¡å‹åˆ›å»º
- [x] JWT Token ç”Ÿæˆå’ŒéªŒè¯
- [x] é‚®ä»¶å‘é€å·¥å…·å®ç°
- [x] è®¤è¯æœåŠ¡å®ç°
- [x] è®¤è¯è·¯ç”±å®ç°
- [x] è·å–å½“å‰ç”¨æˆ·ä¾èµ–æ³¨å…¥
- [x] è·¯ç”±æ³¨å†Œåˆ° main.py
- [x] æ‰©å±• user.py æ·»åŠ  /me ç«¯ç‚¹
- [x] åç«¯æµ‹è¯•è„šæœ¬ç¼–å†™
- [x] å‰ç«¯è®¤è¯æœåŠ¡å®ç°
- [x] ç™»å½•é¡µé¢ UI åˆ›å»º
- [x] ä¿®æ”¹ main.dart å¯åŠ¨æµç¨‹
- [x] å¼€å‘æ–‡æ¡£ç¼–å†™

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- PRD: `backend_claude_memory/specs/pocketspeak_PRD_v1.3.md`
- åç«¯æç¤ºè¯: `backend_claude_memory/prompts/v1.3_auth_backend_prompt.md`
- å‰ç«¯æç¤ºè¯: `frontend_claude_memory/prompts/v1.3_auth_ui_prompt.md`
- æ¶æ„è®¾è®¡: `claude_workspace/20250117_v1.3_architecture_design.md`

---

**å¼€å‘å®Œæˆæ—¶é—´**: 2025-01-17
**æ€»å¼€å‘æ—¶é•¿**: çº¦ 2 å°æ—¶
**ä»£ç è´¨é‡**: âœ… å·²é€šè¿‡åŸºæœ¬æµ‹è¯•
**ä¸‹ä¸€æ­¥**: å‰åç«¯è”è°ƒæµ‹è¯• â†’ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‡†å¤‡
