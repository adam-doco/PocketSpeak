<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <base href="./">
    <title>Live2D Model</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: transparent;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 14px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            text-align: center;
        }

        .error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff6b6b;
            font-size: 14px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">æ­£åœ¨åŠ è½½Live2Dæ¨¡å‹...</div>
    <div id="error" class="error">æ¨¡å‹åŠ è½½å¤±è´¥<br/>è¯·æ£€æŸ¥æ§åˆ¶å°</div>
    <canvas id="canvas"></canvas>

    <script>
        // å…¨å±€æ—¥å¿—å‡½æ•° - å‘é€æ—¥å¿—åˆ°Flutter
        function log(message, level = 'info') {
            console.log(`[Live2D ${level.toUpperCase()}]`, message);

            // å‘é€åˆ°Flutter (flutter_inappwebview API)
            if (window.flutter_inappwebview) {
                window.flutter_inappwebview.callHandler('FlutterChannel', JSON.stringify({
                    type: 'log',
                    level: level,
                    message: message
                }));
            }
        }

        // Live2Dæ§åˆ¶å™¨ç±»
        class Live2DController {
            constructor() {
                this.app = null;
                this.model = null;
                this.isLoaded = false;
                this.canvas = document.getElementById('canvas');
                this.loadingElement = document.getElementById('loading');
                this.errorElement = document.getElementById('error');
            }

            async init() {
                try {
                    log('å¼€å§‹åˆå§‹åŒ–Live2D...');

                    // åŠ è½½ä¾èµ–è„šæœ¬
                    await this.loadScripts();

                    // åˆå§‹åŒ–PIXIåº”ç”¨
                    await this.initPixiApp();

                    // åŠ è½½Live2Dæ¨¡å‹
                    await this.loadModel();

                    // éšè—åŠ è½½æç¤º
                    this.hideLoading();

                    this.isLoaded = true;
                    log('Live2Dåˆå§‹åŒ–å®Œæˆ', 'success');

                    // é€šçŸ¥Flutteråˆå§‹åŒ–å®Œæˆ
                    this.sendToFlutter({
                        type: 'initialized',
                        status: 'success'
                    });

                } catch (error) {
                    log(`Live2Dåˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                    console.error('è¯¦ç»†é”™è¯¯:', error);
                    this.showError(error.message);

                    // é€šçŸ¥Flutteråˆå§‹åŒ–å¤±è´¥
                    this.sendToFlutter({
                        type: 'initialized',
                        status: 'error',
                        message: error.message
                    });
                }
            }

            async loadScripts() {
                log('å¼€å§‹åŠ è½½ä¾èµ–è„šæœ¬...');

                const scripts = [
                    'https://unpkg.com/pixi.js@7.3.2/dist/pixi.min.js',
                    'https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js'
                ];

                for (const src of scripts) {
                    await this.loadScript(src);
                }

                // è®¾ç½®PIXIå…¨å±€å˜é‡
                window.PIXI = PIXI;

                // åŠ è½½ pixi-live2d-display
                await this.loadScript('https://unpkg.com/pixi-live2d-display@0.4.0/dist/cubism4.min.js');

                log('æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆ', 'success');
            }

            loadScript(src) {
                return new Promise((resolve, reject) => {
                    log(`åŠ è½½è„šæœ¬: ${src}`);
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = () => {
                        log(`è„šæœ¬åŠ è½½æˆåŠŸ: ${src}`, 'success');
                        resolve();
                    };
                    script.onerror = () => {
                        const error = `è„šæœ¬åŠ è½½å¤±è´¥: ${src}`;
                        log(error, 'error');
                        reject(new Error(error));
                    };
                    document.head.appendChild(script);
                });
            }

            async initPixiApp() {
                log('åˆå§‹åŒ–PIXIåº”ç”¨...');

                this.app = new PIXI.Application({
                    view: this.canvas,
                    width: window.innerWidth,
                    height: window.innerHeight,
                    backgroundColor: 0x000000,
                    backgroundAlpha: 0,
                    antialias: true,
                    resolution: window.devicePixelRatio || 1,
                    autoDensity: true
                });

                log('PIXIåº”ç”¨åˆå§‹åŒ–å®Œæˆ', 'success');

                // ç›‘å¬çª—å£å¤§å°å˜åŒ–
                window.addEventListener('resize', () => {
                    this.app.renderer.resize(window.innerWidth, window.innerHeight);
                    if (this.model) {
                        this.positionModel();
                    }
                });
            }

            async loadModel() {
                try {
                    log('å¼€å§‹åŠ è½½Live2Dæ¨¡å‹...');

                    // æ„å»ºåŸºäºå½“å‰é¡µé¢çš„ç»å¯¹è·¯å¾„
                    const currentUrl = window.location.href;
                    log(`å½“å‰é¡µé¢URL: ${currentUrl}`);

                    // æå–åŸºç¡€è·¯å¾„ï¼šä»URLä¸­ç§»é™¤ 'index.html'
                    const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
                    log(`åŸºç¡€è·¯å¾„: ${baseUrl}`);

                    const modelPath = baseUrl + 'models/Mould/Z.model3.json';
                    log(`å®Œæ•´æ¨¡å‹è·¯å¾„: ${modelPath}`);

                    // æµ‹è¯•æ–‡ä»¶æ˜¯å¦å¯è®¿é—®
                    try {
                        const testResponse = await fetch(modelPath, { method: 'HEAD' });
                        log(`æ–‡ä»¶è®¿é—®æµ‹è¯•: ${testResponse.ok ? 'æˆåŠŸ' : 'å¤±è´¥ ' + testResponse.status}`);
                    } catch (e) {
                        log(`æ–‡ä»¶è®¿é—®æµ‹è¯•å¤±è´¥: ${e.message}`, 'error');
                    }

                    // å°è¯•åŠ è½½æ¨¡å‹
                    log(`å¼€å§‹åŠ è½½æ¨¡å‹...`);
                    this.model = await PIXI.live2d.Live2DModel.from(modelPath);
                    log(`æ¨¡å‹åŠ è½½æˆåŠŸ`, 'success');

                    this.app.stage.addChild(this.model);
                    log('æ¨¡å‹æ·»åŠ åˆ°èˆå°', 'success');

                    // è®¾ç½®æ¨¡å‹ä½ç½®
                    this.positionModel();

                    // æ’­æ”¾é»˜è®¤å¾…æœºåŠ¨ä½œ
                    await this.playMotion('', 0);

                    log('Live2Dæ¨¡å‹åŠ è½½å®Œæˆ', 'success');

                } catch (error) {
                    log(`æ¨¡å‹åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                    log(`é”™è¯¯å †æ ˆ: ${error.stack}`, 'error');
                    console.error('è¯¦ç»†é”™è¯¯:', error);
                    throw error;
                }
            }

            positionModel() {
                if (!this.model) return;

                // ç­‰å¾…æ¨¡å‹å®Œå…¨åŠ è½½ï¼Œæœ€å¤šé‡è¯•5æ¬¡
                if (!this.positionRetryCount) this.positionRetryCount = 0;

                if ((!this.model.width || !this.model.height ||
                     this.model.width < 10 || this.model.height < 10) &&
                    this.positionRetryCount < 5) {
                    log(`æ¨¡å‹å°ºå¯¸æœªå°±ç»ªï¼Œå»¶è¿Ÿå®šä½ (ç¬¬${this.positionRetryCount + 1}æ¬¡)`);
                    this.positionRetryCount++;
                    setTimeout(() => this.positionModel(), 200);
                    return;
                }

                // è®¾ç½®é”šç‚¹ä¸ºä¸­å¿ƒ
                this.model.anchor.set(0.5, 0.5);

                // å±…ä¸­æ˜¾ç¤ºï¼ˆå‘ä¸Šåç§»20pxï¼Œé¿å…è¢«åº•éƒ¨è¾“å…¥æ¡†é®æŒ¡ï¼‰
                this.model.x = window.innerWidth / 2;
                this.model.y = window.innerHeight / 2 - 20;

                // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
                if (this.model.width && this.model.height) {
                    const scale = Math.min(
                        window.innerWidth / this.model.width,
                        window.innerHeight / this.model.height
                    ) * 0.9;

                    const finalScale = Math.max(0.1, Math.min(2.0, scale));
                    this.model.scale.set(finalScale);

                    log(`æ¨¡å‹å®šä½å®Œæˆ: ä½ç½®(${this.model.x}, ${this.model.y}), ç¼©æ”¾${finalScale}`, 'success');
                } else {
                    // ä½¿ç”¨é»˜è®¤ç¼©æ”¾
                    this.model.scale.set(0.5);
                    log('ä½¿ç”¨é»˜è®¤ç¼©æ”¾ 0.5');
                }

                this.positionRetryCount = 0;
            }

            // æ’­æ”¾åŠ¨ä½œ
            async playMotion(group = '', index = 0) {
                if (!this.model || !this.isLoaded) {
                    log('æ¨¡å‹æœªåŠ è½½ï¼Œæ— æ³•æ’­æ”¾åŠ¨ä½œ', 'warn');
                    return;
                }

                try {
                    log(`æ’­æ”¾åŠ¨ä½œ: group="${group}", index=${index}`);
                    await this.model.motion(group, index);
                    log(`åŠ¨ä½œæ’­æ”¾æˆåŠŸ`, 'success');
                } catch (error) {
                    log(`åŠ¨ä½œæ’­æ”¾å¤±è´¥: ${error.message}`, 'error');
                    console.error(error);
                }
            }

            // æ’­æ”¾è¡¨æƒ…
            async playExpression(name) {
                if (!this.model || !this.isLoaded) {
                    log('æ¨¡å‹æœªåŠ è½½ï¼Œæ— æ³•æ’­æ”¾è¡¨æƒ…', 'warn');
                    return;
                }

                try {
                    log(`æ’­æ”¾è¡¨æƒ…: ${name}`);

                    // æ£€æŸ¥æ¨¡å‹æ˜¯å¦æœ‰è¡¨æƒ…å®šä¹‰
                    if (!this.model.internalModel || !this.model.internalModel.motionManager) {
                        log('æ¨¡å‹æ²¡æœ‰è¡¨æƒ…ç®¡ç†å™¨', 'warn');
                        return;
                    }

                    // è·å–å¯ç”¨çš„è¡¨æƒ…åˆ—è¡¨
                    const expressions = this.model.internalModel.settings?.expressions;
                    if (expressions) {
                        log(`æ¨¡å‹å¯ç”¨è¡¨æƒ…: ${expressions.map(e => e.Name || e.name).join(', ')}`);
                    }

                    // æ’­æ”¾è¡¨æƒ…
                    const result = await this.model.expression(name);
                    log(`è¡¨æƒ…æ’­æ”¾æˆåŠŸï¼Œè¿”å›å€¼: ${result}`, 'success');
                } catch (error) {
                    log(`è¡¨æƒ…æ’­æ”¾å¤±è´¥: ${error.message}`, 'error');
                    console.error('è¡¨æƒ…æ’­æ”¾è¯¦ç»†é”™è¯¯:', error);
                }
            }

            // ğŸ”¥ æ–°å¢ï¼šå˜´éƒ¨åŠ¨ä½œæ§åˆ¶å™¨
            startLipSync() {
                if (!this.model || !this.isLoaded) {
                    log('æ¨¡å‹æœªåŠ è½½ï¼Œæ— æ³•å¯åŠ¨å˜´éƒ¨åŠ¨ä½œ', 'warn');
                    return;
                }

                // åœæ­¢ä¹‹å‰çš„å˜´éƒ¨åŠ¨ä½œ
                this.stopLipSync();

                log('ğŸ‘„ å¯åŠ¨å˜´éƒ¨åŒæ­¥åŠ¨ç”»');

                // å˜´éƒ¨åŠ¨ä½œå‚æ•°
                let mouthValue = 0;
                let direction = 1;
                const speed = 0.15; // å¼ å˜´é€Ÿåº¦
                const maxOpen = 1.0; // æœ€å¤§å¼ å¼€å¹…åº¦

                // ä½¿ç”¨setIntervalå®ç°å¹³æ»‘çš„å˜´éƒ¨åŠ¨ä½œ
                this.lipSyncInterval = setInterval(() => {
                    if (!this.model || !this.model.internalModel) {
                        this.stopLipSync();
                        return;
                    }

                    try {
                        // æ›´æ–°å˜´éƒ¨æ•°å€¼ï¼ˆ0 -> maxOpen -> 0 å¾ªç¯ï¼‰
                        mouthValue += speed * direction;

                        if (mouthValue >= maxOpen) {
                            mouthValue = maxOpen;
                            direction = -1; // å¼€å§‹é—­å˜´
                        } else if (mouthValue <= 0) {
                            mouthValue = 0;
                            direction = 1; // å¼€å§‹å¼ å˜´
                        }

                        // ğŸ”¥ ä½¿ç”¨æ­£ç¡®çš„ pixi-live2d-display API
                        // é€šè¿‡ internalModel.coreModel ç›´æ¥è®¾ç½®å‚æ•°å€¼
                        const coreModel = this.model.internalModel.coreModel;

                        // ParamMouthOpenY - æ§åˆ¶å˜´å·´å¼ å¼€/é—­åˆï¼ˆæœ€é‡è¦çš„å‚æ•°ï¼‰
                        coreModel.setParameterValueById('ParamMouthOpenY', mouthValue);

                        // é¦–æ¬¡å¾ªç¯æ—¶è¾“å‡ºæ—¥å¿—
                        if (!this._lipSyncStarted) {
                            log(`ğŸ‘„ å˜´éƒ¨å‚æ•°è®¾ç½®: ParamMouthOpenY = ${mouthValue.toFixed(2)}`);
                            this._lipSyncStarted = true;
                        }
                    } catch (error) {
                        log(`âŒ å˜´éƒ¨åŠ¨ä½œæ›´æ–°å¤±è´¥: ${error.message}`, 'error');
                        console.error('å˜´éƒ¨åŠ¨ä½œé”™è¯¯è¯¦æƒ…:', error);
                    }
                }, 50); // æ¯50msæ›´æ–°ä¸€æ¬¡ï¼ˆ20fpsï¼‰

                this.isLipSyncActive = true;
            }

            // ğŸ”¥ æ–°å¢ï¼šåœæ­¢å˜´éƒ¨åŠ¨ä½œ
            stopLipSync() {
                if (this.lipSyncInterval) {
                    clearInterval(this.lipSyncInterval);
                    this.lipSyncInterval = null;
                    log('ğŸ‘„ åœæ­¢å˜´éƒ¨åŠ¨ä½œå¾ªç¯');
                }

                // é‡ç½®å˜´éƒ¨å‚æ•°ä¸ºé—­åˆçŠ¶æ€
                if (this.model && this.model.internalModel) {
                    try {
                        const coreModel = this.model.internalModel.coreModel;
                        coreModel.setParameterValueById('ParamMouthOpenY', 0);
                        log('ğŸ‘„ å˜´éƒ¨å‚æ•°å·²é‡ç½®ä¸ºé—­åˆçŠ¶æ€');
                    } catch (error) {
                        log(`âŒ é‡ç½®å˜´éƒ¨å‚æ•°å¤±è´¥: ${error.message}`, 'error');
                    }
                }

                this.isLipSyncActive = false;
                this._lipSyncStarted = false;
            }

            hideLoading() {
                if (this.loadingElement) {
                    this.loadingElement.style.display = 'none';
                }
            }

            showError(message) {
                if (this.loadingElement) {
                    this.loadingElement.style.display = 'none';
                }
                if (this.errorElement) {
                    this.errorElement.textContent = `æ¨¡å‹åŠ è½½å¤±è´¥\n${message}`;
                    this.errorElement.style.display = 'block';
                }
            }

            sendToFlutter(data) {
                if (window.flutter_inappwebview) {
                    window.flutter_inappwebview.callHandler('FlutterChannel', JSON.stringify(data));
                }
            }
        }

        // åˆ›å»ºå…¨å±€æ§åˆ¶å™¨å®ä¾‹
        let controller = null;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async () => {
            log('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–Live2Dæ§åˆ¶å™¨');

            try {
                controller = new Live2DController();
                await controller.init();

                // æš´éœ²å…¨å±€æ¥å£ä¾›Flutterè°ƒç”¨
                window.live2dController = controller;

                // æš´éœ²å¿«æ·æ–¹æ³•
                window.playMotion = (group, index) => controller.playMotion(group, index);
                window.playExpression = (name) => controller.playExpression(name);
                // ğŸ”¥ æ–°å¢ï¼šæš´éœ²å˜´éƒ¨åŠ¨ä½œæ§åˆ¶æ–¹æ³•
                window.startLipSync = () => controller.startLipSync();
                window.stopLipSync = () => controller.stopLipSync();

                log('Live2Dæ§åˆ¶å™¨å·²å°±ç»ª', 'success');

            } catch (error) {
                log(`æ§åˆ¶å™¨åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
            }
        });
    </script>
</body>
</html>
